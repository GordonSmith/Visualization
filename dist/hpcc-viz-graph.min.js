"function"==typeof define&&define.amd&&define("css",[],function(){return{load:function(t,e,i){i()}}}),function(t,e){"function"==typeof define&&define.amd?define("graph/Edge",["d3","../common/SVGWidget","../common/TextBox","css!./Edge"],e):t.graph_Edge=e(t.d3,t.common_SVGWidget,t.common_TextBox)}(this,function(t,e,i){function o(){e.call(this),this._points=[],this._weight=100,this._strokeDasharray=null,this._hidden=!1,this._textBox=(new i).padding(0)}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype._class+=" graph_Edge",o.prototype.publish("arcDepth",16,"number","Arc Depth",null,{tags:["Basic"]}),o.prototype.publish("showArc",!0,"boolean","Show/Hide Arc",null,{tags:["Basic"]}),o.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),o.prototype.publish("sourceMarker","circle","set","Source Marker",["circle"],{optional:!0}),o.prototype.publish("targetMarker","arrow","set","Source Marker",["arrow","circle"],{optional:!0}),o.prototype.publish("strokeDasharray",null,"string","Stroke Dash Array",null,{optional:!0}),o.prototype.publish("strokeColor",null,"html-color","Stroke Color",null,{optional:!0}),o.prototype.sourceVertex=function(t){return arguments.length?(this._sourceVertex=t,this):this._sourceVertex},o.prototype.targetVertex=function(t){return arguments.length?(this._targetVertex=t,this):this._targetVertex},o.prototype.weight=function(t){return arguments.length?(this._weight=t,this):this._weight},o.prototype.points=function(t,e,i){return arguments.length?(this._points=t,this._elementPath&&this.update(null,this._element,e,i),this):this._points},o.prototype.hidden=function(t){return arguments.length?(this._hidden=t,this):this._hidden},o.prototype.text=function(t){return arguments.length?(this._textBox.text(t),this):this._textBox.text()},o.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this._elementPath=i.append("path"),this._tooltipElement=this._elementPath.append("title"),this._textBox.text()&&this._textBox.target(t).tooltip(this.tooltip()).render()},o.prototype.update=function(i,o,r,n){e.prototype.update.apply(this,arguments);var a=this;this.svgMarkerGlitch&&!n&&o.transition().duration((r?r:0)+100).each("start",function(t){a._pushMarkers(o,t)}).each("end",function(t){a._popMarkers(o,t)});var s=a._calculateEdgePoints(this._sourceVertex,this._targetVertex,this._points),h="";if(this._points.length||r,0){var c=s[2].x-s[0].x,p=s[2].y-s[0].y,l=2*Math.sqrt(c*c+p*p);h="M"+s[0].x+","+s[0].y+"A"+l+","+l+" 0 0,1 "+s[2].x+","+s[2].y}else h=t.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("bundle").tension(.75)(s);var d=this._elementPath;r&&(d=d.transition().duration(r)),d.attr("opacity",this._hidden?0:1).attr("marker-start",this.svgMarkerGlitch&&n||!this.sourceMarker_exists()?null:"url(#"+this._graphID+"_"+this.sourceMarker()+"Foot)").attr("marker-end",this.svgMarkerGlitch&&n||!this.targetMarker_exists()?null:"url(#"+this._graphID+"_"+this.targetMarker()+"Head)").attr("stroke",this.strokeColor_exists()?this.strokeColor():null).attr("stroke-dasharray",this.strokeDasharray_exists()?this.strokeDasharray():null).attr("d",h),this._tooltipElement.text(this.tooltip()),this._textBox.text()&&this._textBox.tooltip(this.tooltip()).move(this._findMidPoint(s),r)},o.prototype._findMidPoint=function(t){var e=t.length/2;if(t.length%2)return t[Math.floor(e)];if(t.length){var i=t[e-1],o=t[e];return{x:(i.x+o.x)/2,y:(i.y+o.y)/2}}return{x:0,y:0}},o.prototype._calculateEdgePoints=function(t,e,i){if(!t||!e)return[{x:0,y:0},{x:0,y:0}];var o=i?i.slice():[],r=0===o.length?e.pos():o[0],n=0===o.length?t.pos():o[o.length-1];if(o.unshift(t.intersection(t._pos,r)),o.push(e.intersection(e._pos,n)),o[0]||(o[0]=t._pos),o[o.length-1]||(o[o.length-1]=e._pos),2===o.length&&o[0]&&o[1]){var a=o[0].x-o[1].x,s=o[0].y-o[1].y,h=Math.sqrt(a*a+s*s);if(h)if(this.showArc()){var c=(o[0].x+o[1].x)/2-s*this.arcDepth()/100,p=(o[0].y+o[1].y)/2+a*this.arcDepth()/100;o=[{x:o[0].x,y:o[0].y},{x:c,y:p},{x:o[1].x,y:o[1].y}]}else o=[{x:o[0].x,y:o[0].y},{x:o[1].x,y:o[1].y}]}return o},o}),function(t,e){"function"==typeof define&&define.amd?define("graph/Vertex.js",["d3","../common/SVGWidget","../common/Icon","../common/TextBox","css!./Vertex"],e):t.graph_Vertex=e(t.d3,t.common_SVGWidget,t.common_Icon,t.common_TextBox)}(this,function(t,e,i,o){function r(){e.call(this),this._icon=new i,this._textBox=new o,this._annotationWidgets={}}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" graph_Vertex",r.prototype.publishProxy("faChar","_icon"),r.prototype.publishProxy("imageUrl","_icon"),r.prototype.publishProxy("icon_shape_diameter","_icon","diameter"),r.prototype.publishProxy("icon_shape_colorFill","_icon","shape_colorFill"),r.prototype.publishProxy("icon_shape_colorStroke","_icon","shape_colorStroke"),r.prototype.publishProxy("icon_image_colorFill","_icon","image_colorFill"),r.prototype.publishProxy("text","_textBox"),r.prototype.publishProxy("anchor","_textBox"),r.prototype.publishProxy("textbox_shape_colorStroke","_textBox","shape_colorStroke"),r.prototype.publishProxy("textbox_shape_colorFill","_textBox","shape_colorFill"),r.prototype.publishProxy("textbox_text_colorFill","_textBox","text_colorFill"),r.prototype.publish("iconAnchor","start","set","Icon Anchor Position",["","start","middle","end"],{tags:["Basic"]}),r.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),r.prototype.publish("annotationDiameter",14,"number","Annotation Diameter",null,{tags:["Private"]}),r.prototype.publish("annotationSpacing",3,"number","Annotation Spacing",null,{tags:["Private"]}),r.prototype.publish("annotationIcons",[],"array","Annotations",null,{tags:["Private"]}),r.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this._icon.target(t).render(),this._textBox.target(t).render()},r.prototype.update=function(o,r){e.prototype.update.apply(this,arguments),this._icon.tooltip(this.tooltip()).render();var n=this._icon.getBBox(!0);this._textBox.tooltip(this.tooltip()).render();var a=this._textBox.getBBox(!0);switch(this.iconAnchor()){case"start":this._icon.move({x:-(a.width/2)+n.width/3,y:-(a.height/2)-n.height/3});break;case"middle":this._icon.move({x:0,y:-(a.height/2)-n.height/3});break;case"end":this._icon.move({x:a.width/2-n.width/3,y:-(a.height/2)-n.height/3})}var s=this,h=r.selectAll(".annotation").data(this.annotationIcons());h.enter().append("g").attr("class","annotation").each(function(t,e){s._annotationWidgets[e]=(new i).target(this).shape("square")});var c=a.width/2,p=a.height/2;h.each(function(t,e){var i=s._annotationWidgets[e];i.diameter(s.annotationDiameter()).shape_colorFill(s.textbox_shape_colorFill()).shape_colorStroke(s.textbox_shape_colorStroke());for(var o in t)i[o]?i[o](t[o]):window.__hpcc_debug&&console.log("Invalid annotation property:  "+o);i.render();var r=i.getBBox(!0);i.move({x:c-r.width/2+4,y:p+r.height/2-4}),c-=r.width+s.annotationSpacing()}),h.exit().each(function(e,i){var o=t.select(this);delete s._annotationWidgets[i],o.remove()})},r.prototype.intersection=function(t,e){var i=this._icon.intersection(t,e,this._pos);if(i)return i;var o=this._textBox.intersection(t,e,this._pos);return o?o:null},r}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphData.js",["dagre"],e):t.graph_GraphData=e(t.dagre)}(this,function(t){function e(){t.graphlib.Graph.call(this,{multigraph:!0,compound:!0}),this.setGraph({}),this.setDefaultNodeLabel(function(){return{}}),this.setDefaultEdgeLabel(function(){return{}})}return e.prototype=Object.create(t.graphlib.Graph.prototype),e.prototype.constructor=e,e.prototype.setData=function(t,e,i,o){for(var r=this,n={addedVertices:[],addedEdges:[]},a=0;a<t.length;++a){var s=t[a];o&&this.hasNode(s._id)||(this.setNode(s._id,s),n.addedVertices.push(s))}for(a=0;a<e.length;++a){var h=e[a];o&&this.hasEdge(h._id)||(h._sourceVertex&&h._targetVertex?(this.setEdge(h._sourceVertex._id,h._targetVertex._id,h,h._id),n.addedEdges.push(h)):console.log("Bad edge definition"))}if(i)for(a=0;a<i.length;++a)this.setParent(i[a].child._id,i[a].parent._id);if(o){var c=e.map(function(t){return t._id});this.filterEdges(function(t){return c.indexOf(t.v+"_"+t.w)<0}).forEach(function(t){});var p=t.map(function(t){return t._id});this.filterNodes(function(t){return p.indexOf(t)<0}).forEach(function(t){try{r.delNode(t)}catch(e){}})}return n},e.prototype.filterEdges=function(t){var e=[];return this.eachEdge(function(i){t(i)&&e.push(i)}),e},e.prototype.filterNodes=function(t){var e=[];return this.eachNode(function(i){t(i)&&e.push(i)}),e},e.prototype.nodeValues=function(){var t=[];return this.nodes().forEach(function(e,i){t.push(this.node(e))},this),t},e.prototype.eachNode=function(t){this.nodes().forEach(function(e,i){t(e,this.node(e))},this)},e.prototype.edgeValues=function(){var t=[];return this.edges().forEach(function(e,i){t.push(this.edge(e))},this),t},e.prototype.eachEdge=function(t){this.edges().forEach(function(e,i){t(e,e.v,e.w,this.edge(e))},this)},e.prototype.getJSON=function(){var e=t.graphlib.json.write(this);return JSON.stringify(e,function(t,e){return"value"===t?e._text&&e._text._text?e._text._text:e._id:e},"  ")},e}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphLayouts.js",["d3","dagre"],e):t.graph_GraphLayouts=e(t.d3,t.dagre)}(this,function(t,e){function i(t,e,i,o){var r=this;this.pos={};var n=0;o=o||(i>e?e-n:i-n)/2;var a=t.nodeCount(),s=-Math.PI/2,h=2*Math.PI/a;t.eachNode(function(t,e){var i=e.getBBox(!0),n=Math.max(i.width,i.height);r.pos[t]={x:e.fixed?e.x:Math.cos(s)*(o-n),y:e.fixed?e.y:Math.sin(s)*(o-n),width:i.width,height:i.height},s+=h})}function o(t,e,i,o){var r=this;this.pos={},t.eachNode(function(t,e){r.pos[t]={x:e.x,y:e.y,width:e.width,height:e.height}})}function r(e,i,o,r){r=r||{};var n=this;if(this.pos={},this.vertices=[],this.vertexMap={},e.eachNode(function(t){var i=e.node(t),o=i.getBBox(!0),r={id:t,x:i.pos().x,y:i.pos().y,width:o.width,height:o.height,value:i};n.vertices.push(r),n.vertexMap[t]=r}),this.edges=[],e.eachEdge(function(t,e,i){n.edges.push({source:n.vertexMap[e],target:n.vertexMap[i]})}),this.force=t.layout.force().linkDistance(r.linkDistance).linkStrength(r.linkStrength).friction(r.friction).charge(function(t){var e=t.value.getBBox();return r.charge*Math.max(e.width,e.height)}).chargeDistance(r.chargeDistance).theta(r.theta).gravity(r.gravity).nodes(this.vertices).links(this.edges),r.oneShot){this.force.start();var a=e.nodeCount();a=Math.min(a*a,500);for(var s=0;a>s;++s)this.force.tick();this.force.stop()}}function n(t,i,o,r){var n=new e.graphlib.Graph({multigraph:!0,compound:!0}).setGraph(r).setDefaultNodeLabel(function(){return{}}).setDefaultEdgeLabel(function(){return{}});t.eachNode(function(e){var i=t.node(e),o=i.getBBox();n.setNode(e,{width:o.width,height:o.height})}),t.eachEdge(function(e,i,o){var r=t.edge(e);n.setEdge(i,o,{weight:r.weight()},r._id)}),t.eachNode(function(e){n.setParent(e,t.parent(e))}),this.dagreLayout=e.layout(n);var a=-n.graph().width/2,s=-n.graph().height/2;n.nodes().forEach(function(t){var e=n.node(t);e.x+=a,e.y+=s}),n.edges().forEach(function(t){for(var e=n.edge(t),i=0;i<e.points.length;++i)e.points[i].x+=a,e.points[i].y+=s}),this.digraph=n}i.prototype.nodePos=function(t){return this.pos[t]},i.prototype.edgePoints=function(t){return[]},o.prototype.nodePos=function(t){return this.pos[t]},o.prototype.edgePoints=function(t){return[]},r.prototype.nodePos=function(t){return this.vertexMap[t]},r.prototype.edgePoints=function(t){return[]},n.prototype.nodePos=function(t){return this.digraph.node(t)},n.prototype.edgePoints=function(t){return this.digraph.edge(t._sourceVertex.id(),t._targetVertex.id(),t._id).points};var a={None:o,Circle:i,ForceDirected:r,Hierarchy:n};return a}),function(t,e){"function"==typeof define&&define.amd?define("graph/Graph.js",["d3","../common/SVGWidget","../common/Palette","../api/IGraph","./Vertex","./Edge","./GraphData","./GraphLayouts","../common/Utility","css!./Graph"],e):t.graph_Graph=e(t.d3,t.common_SVGWidget,t.common_Palette,t.api_IGraph,t.graph_Vertex,t.graph_Edge,t.graph_GraphData,t.graph_GraphLayouts,t.common_Utility)}(this,function(t,e,i,o,r,n,a,s,h){function c(){e.call(this),o.call(this),this.graphData=new a,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection}return c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype._class+=" graph_Graph",c.prototype["implements"](o.prototype),c.prototype.Vertex=r,c.prototype.Edge=n,c.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices",null,{tags:["Advanced"]}),c.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"],{tags:["Basic"]}),c.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"],{tags:["Basic"]}),c.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("transitionDuration",250,"number","Transition Duration",null,{tags:["Intermediate"]}),c.prototype.publish("showEdges",!0,"boolean","Show Edges",null,{tags:["Intermediate"]}),c.prototype.publish("snapToGrid",0,"number","Snap to Grid",null,{tags:["Private"]}),c.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"],{tags:["Advanced"]}),c.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedCharge",-25,"number","Charge strength ",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedTheta",.8,"number","Barnes–Hut approximation criterion",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength",null,{tags:["Advanced"]}),c.prototype.getOffsetPos=function(){return{x:0,y:0}},c.prototype.size=function(t){var i=e.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),i},c.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},c.prototype.data=function(t){var i=e.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new a,this._renderCount=0);var o=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),r=this;o.addedVertices.forEach(function(t){t.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),o.addedEdges.forEach(function(t){t._graphID=r._id});var n={};this.graphData.edgeValues().forEach(function(t){n[t._sourceVertex._id]||(n[t._sourceVertex._id]={}),n[t._sourceVertex._id][t._targetVertex._id]||(n[t._sourceVertex._id][t._targetVertex._id]=0);var e=++n[t._sourceVertex._id][t._targetVertex._id];t.arcDepth(16*e)})}return i},c.prototype.selection=function(t){return arguments.length?(this._selection.set(t),this):this._selection.get()},c.prototype.setZoom=function(t,e,i){this.zoom&&(this.zoom.translate(t),this.zoom.scale(e),this.applyZoom(i))},c.prototype.applyZoom=function(e){t.event&&t.event.sourceEvent&&t.event.sourceEvent.ctrlKey&&("wheel"===t.event.sourceEvent.type||"mousewheel"===t.event.sourceEvent.type||"DOMMouseScroll"===t.event.sourceEvent.type)&&t.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+t.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale)),(e?this.svg.transition().duration(e):this.svg).attr("transform","translate("+this.zoom.translate()+")scale("+this.zoom.scale()+")"),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this._fixIEMarkers(),this.prevScale=this.zoom.scale()),this.brush.x(t.scale.identity().domain([1*(-this.prevTranslate[0]-this._size.width/2)/this.zoom.scale(),1*(-this.prevTranslate[0]+this._size.width/2)/this.zoom.scale()])),this.brush.y(t.scale.identity().domain([1*(-this.prevTranslate[1]-this._size.height/2)/this.zoom.scale(),1*(-this.prevTranslate[1]+this._size.height/2)/this.zoom.scale()]))},c.prototype.enter=function(i,o){function r(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),s._dragging=!0,s.forceLayout){var i=s.forceLayout.vertexMap[e.id()];i.fixed=!0}s.svgMarkerGlitch&&s.graphData.nodeEdges(e.id()).forEach(function(t){var e=s.graphData.edge(t);s._pushMarkers(e.element(),e)})}}function n(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),e.move({x:t.event.x,y:t.event.y}),s.forceLayout){var i=s.forceLayout.vertexMap[e.id()];i.fixed=!0,i.x=i.px=t.event.x,i.y=i.py=t.event.y}s.refreshIncidentEdges(e,!0)}}function a(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),s._dragging=!1,s.snapToGrid()){var i=e.calcSnap(s.snapToGrid());e.move(i[0]),s.refreshIncidentEdges(e,!0)}if(s.forceLayout){var o=s.forceLayout.vertexMap[e.id()];o.fixed=!1}s.svgMarkerGlitch&&s.graphData.nodeEdges(e.id()).forEach(function(t){var e=s.graphData.edge(t);s._popMarkers(e.element(),e)})}}e.prototype.enter.apply(this,arguments);var s=this;this.prevTranslate=[0,0],this.prevScale=1,this.zoom=t.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(e){switch(s.prevTranslate=s.zoom.translate(),s.prevScale=s.zoom.scale(),t.event.sourceEvent&&t.event.sourceEvent.shiftKey&&t.event.sourceEvent.ctrlKey?s._zoomMode="selection":t.event.sourceEvent&&t.event.sourceEvent.shiftKey?(s._zoomMode="selection",s._selection.clear()):s._zoomMode="zoom",s._zoomMode){case"selection":o.select(".extent").style("visibility",null);break;default:o.select(".extent").style("visibility","hidden")}}).on("zoomend",function(t){switch(s._zoomMode){case"selection":s.zoom.translate(s.prevTranslate),s.zoom.scale(s.prevScale)}s._svgBrush.call(s.brush.clear())}).on("zoom",function(t){switch(s._zoomMode){case"selection":break;default:s.applyZoom()}}),this.brush=t.svg.brush().x(t.scale.identity().domain([-s._size.width/2,s._size.width/2])).y(t.scale.identity().domain([-s._size.height/2,s._size.height/2])).on("brushstart",function(t){switch(s._zoomMode){case"selection":}}).on("brushend",function(e){switch(s._zoomMode){case"selection":var i=t.event.target.extent();s.svgV.selectAll(".graphVertex").select("*").each(function(t){i[0][0]<=t.x()&&t.x()<i[1][0]&&i[0][1]<=t.y()&&t.y()<i[1][1]&&s._selection.append(t)}),s.graph_selection(s.selection())}}).on("brush",function(){switch(s._zoomMode){case"selection":var e=s.zoom.translate();console.log(e[0]);var i=t.event.target.extent();s.svgV.selectAll(".graphVertex").select("*").classed("selected",function(t){return s._selection.isSelected(t)||i[0][0]<=t.x()&&t.x()<i[1][0]&&i[0][1]<=t.y()&&t.y()<i[1][1]})}}),this.drag=t.behavior.drag().origin(function(t){return t.pos()}).on("dragstart",r).on("dragend",a).on("drag",n),this._svgZoom=o.append("rect").attr("class","zoom").attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),this.defs=o.append("defs"),this.addMarkers(),o.call(this.zoom),this.svg=o.append("g"),this._svgBrush=this.svg.append("g").attr("class","selectionBrush").call(this.brush),this._svgBrush.select(".background").style("cursor",null),s._svgBrush.call(s.brush.clear()),this.svgC=this.svg.append("g").attr("id",this._id+"C"),this.svgE=this.svg.append("g").attr("id",this._id+"E"),this.svgV=this.svg.append("g").attr("id",this._id+"V")},c.prototype.getBounds=function(t,e){var i=[[null,null],[null,null]];return t.forEach(function(t){var o=e?e.nodePos(t._id):{x:t.x(),y:t.y(),width:t.width(),height:t.height()};if(o){var r=o.x-o.width/2,n=o.x+o.width/2,a=o.y-o.height/2,s=o.y+o.height/2;(null===i[0][0]||i[0][0]>r)&&(i[0][0]=r),(null===i[0][1]||i[0][1]>a)&&(i[0][1]=a),(null===i[1][0]||i[1][0]<n)&&(i[1][0]=n),(null===i[1][1]||i[1][1]<s)&&(i[1][1]=s)}}),i},c.prototype.getVertexBounds=function(t){return this.getBounds(this.graphData.nodeValues(),t)},c.prototype.getSelectionBounds=function(t){return this.getBounds(this._selection.get(),t)},c.prototype.shrinkToFit=function(t,e){var i=this.width(),o=this.height(),r=t[1][0]-t[0][0],n=t[1][1]-t[0][1],a=(t[0][0]+t[1][0])/2,s=(t[0][1]+t[1][1])/2,h=1/Math.max(r/i,n/o);h>1&&(h=1);var c=[-h*a,-h*s];this.setZoom(c,h,e)},c.prototype._origScale=c.prototype.scale,c.prototype.scale=function(t,e){var i=c.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(t,e),i},c.prototype.zoomTo=function(t,e){switch(t){case"all":this.shrinkToFit(this.getVertexBounds(),e);break;case"width":var i=this.getVertexBounds();i[0][1]=0,i[1][1]=0,this.shrinkToFit(i,e);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),e);break;default:var o=parseInt(t);(isNaN(o)||0>=o||o>200)&&(o=100),this.zoom.scale(o/100),this.applyZoom(e)}},c.prototype.centerOn=function(t,e){var i=(t[0][0]+t[1][0])/2,o=(t[0][1]+t[1][1])/2,r=[i,o];this.setZoom(r,1,e)},c.prototype._origLayout=c.prototype.layout,c.prototype.layout=function(t,e){var i=c.prototype._origLayout.apply(this,arguments);if(arguments.length&&this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var o=this,r=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=r,this.forceLayout.force.on("tick",function(t){if(r.vertices.forEach(function(t){if(t.fixed)t.x=t.px,t.y=t.py;else{t.px=t.x,t.py=t.y;var e=o.graphData.node(t.id);e&&e.move({x:t.x,y:t.y})}}),o.graphData.edgeValues().forEach(function(t){t.points([],!1,!1)}),o.applyScaleOnLayout()){var e=o.getVertexBounds(r);o.shrinkToFit(e)}}),this.forceLayout.force.start();else if(r){if(this.forceLayout=null,o._dragging=!0,o.graphData.nodeValues().forEach(function(t){var i=r.nodePos(t._id);t.move({x:i.x,y:i.y},e),i.width&&i.height&&!t.width()&&!t.height()&&t.width(i.width).height(i.height).render()}),o.graphData.edgeValues().forEach(function(t){var i=r.edgePoints(t);t.points(i,e)}),o.applyScaleOnLayout()){var n=o.getVertexBounds(r);o.shrinkToFit(n,e)}this._fixIEMarkers(),setTimeout(function(){o._dragging=!1},e?e+50:50)}}return i},c.prototype.update=function(i,o){function r(t){t.target(this).render(),t.element().call(h.drag),t.dispatch&&(t.dispatch.on("sizestart",function(t,e){t.allowResize(h.allowDragging()),h.allowDragging()&&(h._dragging=!0)}),t.dispatch.on("size",function(t,e){h.refreshIncidentEdges(t,!1)}),t.dispatch.on("sizeend",function(t,e){if(h._dragging=!1,h.snapToGrid()){var i=t.calcSnap(h.snapToGrid());t.pos(i[0]).size(i[1]).render(),h.refreshIncidentEdges(t,!1)}}))}function n(t){t.target(this).render()}function a(t){t.render()}function s(t){t.render()}e.prototype.update.apply(this,arguments);var h=this,c=this.svgV.selectAll("#"+this._id+"V > .graphVertex").data(this.graphData.nodeValues(),function(t){return t.id()});c.enter().append("g").attr("class","graphVertex").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){var i=t.select(this).select(".graph_Vertex"),o=!1;i.empty()||(o=i.classed("selected")),h.vertex_click(h.rowToObj(e.data()),"",o,{vertex:e})}).on("dblclick",function(e){var i=t.select(this).select(".graph_Vertex"),o=!1;i.empty()||(o=i.classed("selected")),h.vertex_dblclick(h.rowToObj(e.data()),"",o,{vertex:e})}).on("mouseover",function(e){h._dragging||h.vertex_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.vertex_mouseout(t.select(this),e)}).each(r).transition().duration(750).style("opacity",1);var p=this.svgE.selectAll("#"+this._id+"E > .graphEdge").data(this.showEdges()?this.graphData.edgeValues():[],function(t){return t.id()});p.enter().append("g").attr("class","graphEdge").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){var i=t.select(this).select(".graph_Edge"),o=!1;i.empty()||(o=i.classed("selected")),h.edge_click(h.rowToObj(e.data()),"",o,{edge:e})}).on("dblclick",function(e){var i=t.select(this).select(".graph_Edge"),o=!1;i.empty()||(o=i.classed("selected")),h.edge_dblclick(h.rowToObj(e.data()),"",o,{edge:e})}).on("mouseover",function(e){h._dragging||h.edge_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.edge_mouseout(t.select(this),e)}).each(n).transition().duration(750).style("opacity",1),c.each(a),p.each(s),c.exit().each(function(t){t.target(null)}).remove(),p.exit().each(function(t){t.target(null)}).remove(),this._renderCount||(this._renderCount++,this.setZoom([0,0],1),this.layout(this.layout()))},c.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new s.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new s.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},c.prototype.getNeighborMap=function(t){var e={},i={};if(t)for(var o=this.graphData.nodeEdges(t.id()),r=0;r<o.length;++r){var n=this.graphData.edge(o[r]);i[n.id()]=n,n._sourceVertex.id()!==t.id()&&(e[n._sourceVertex.id()]=n._sourceVertex),n._targetVertex.id()!==t.id()&&(e[n._targetVertex.id()]=n._targetVertex)}return{vertices:e,edges:i}},c.prototype.highlightVerticies=function(t){var e=this,i=this.svgV.selectAll(".graphVertex");return i.classed("graphVertex-highlighted",function(e){return!t||t[e.id()]}).transition().duration(this.transitionDuration()).each("end",function(e){t&&t[e.id()]&&e._parentElement.node()&&e._parentElement.node().parentNode&&e._parentElement.node().parentNode.appendChild(e._parentElement.node())}).style("opacity",function(i){return!t||t[i.id()]?1:e.highlight.opacity}),this},c.prototype.highlightEdges=function(t){var e=this,i=this.svgE.selectAll(".graphEdge");return i.classed("graphEdge-highlighted",function(e){return!t||t[e.id()]}).style("stroke-width",function(i){return t&&t[i.id()]?e.highlight.edge:"1px"}).transition().duration(this.transitionDuration()).style("opacity",function(i){return!t||t[i.id()]?1:e.highlight.opacity}),this},c.prototype.highlightVertex=function(t,e){if(this.highlightOnMouseOverVertex())if(e){var i=this.getNeighborMap(e);i.vertices[e.id()]=e,this.highlightVerticies(i.vertices),this.highlightEdges(i.edges)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.highlightEdge=function(t,e){if(this.highlightOnMouseOverEdge())if(e){var i={};i[e._sourceVertex.id()]=e._sourceVertex,i[e._targetVertex.id()]=e._targetVertex;var o={};o[e.id()]=e,this.highlightVerticies(i),this.highlightEdges(o)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.refreshIncidentEdges=function(t,e){var i=this;this.graphData.nodeEdges(t.id()).forEach(function(t){var o=i.graphData.edge(t);o.points([],!1,e)})},c.prototype.graph_selection=function(t){},c.prototype.vertex_click=function(t,e,i,r){r&&r.vertex&&r.vertex._parentElement.node().parentNode.appendChild(r.vertex._parentElement.node()),o.prototype.vertex_click.apply(this,arguments)},c.prototype.vertex_dblclick=function(t,e,i,o){},c.prototype.vertex_mouseover=function(t,e){this.highlightVertex(t,e)},c.prototype.vertex_mouseout=function(t,e){this.highlightVertex(null,null)},c.prototype.edge_mouseover=function(t,e){this.highlightEdge(t,e)},c.prototype.edge_mouseout=function(t,e){this.highlightEdge(null,null)},c.prototype.addMarkers=function(t){t&&(this.defs.select("#"+this._id+"_arrowHead").remove(),this.defs.select("#"+this._id+"_circleFoot").remove(),this.defs.select("#"+this._id+"_circleHead").remove()),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_arrowHead").attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",8).attr("markerHeight",8).attr("markerUnits","strokeWidth").attr("orient","auto").append("polyline").attr("points","0,0 10,5 0,10 1,5"),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleFoot").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleHead").attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4)},c}),function(t,e){"function"==typeof define&&define.amd?define("graph/Sankey.js",["d3","../common/SVGWidget","../common/Palette","../common/PropertyExt","../common/Utility","d3-sankey","css!./Sankey"],e):t.graph_Sankey=e(t.d3,t.common_SVGWidget,t.common_Palette,t.common_PropertyExt,t.common_Utility,t.d3.sankey)}(this,function(t,e,i,o,r,n){function a(t){o.call(this),this._owner=t}function s(t){e.call(this),r.SimpleSelectionMixin.call(this),this._drawStartPos="origin"}return n=n||t.sankey||window.d3.sankey,a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.prototype._class+=" graph_Sankey.Column",a.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),a.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0,disable:function(t){return!t._owner||0===t._owner.mappings().indexOf(t)}}),a.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this._owner?this._owner.columns():[]},{optional:!0,disable:function(t){return!t._owner||!t.aggrType()||0===t._owner.mappings().indexOf(t)}}),a.prototype.aggregate=function(e){switch(this.aggrType()){case null:case void 0:case"":return e.length;default:var i=this._owner.columns(),o=i.indexOf(this.aggrColumn());return t[this.aggrType()](e,function(t){return+t[o]})}},s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype._class+=" graph_Sankey",s.prototype.Column=a,s.prototype.mixin(r.SimpleSelectionMixin),s.prototype._palette=i.ordinal("default"),s.prototype.publish("paletteID","default","set","Palette ID",s.prototype._palette["switch"]()),
s.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:a}),s.prototype.publish("vertexWidth",36,"number","Vertex Width"),s.prototype.publish("vertexPadding",40,"number","Vertex Padding"),s.prototype.publish("xAxisMovement",!1,"boolean","Enable x-axis movement"),s.prototype.publish("yAxisMovement",!1,"boolean","Enable y-axis movement"),s.prototype.sankeyData=function(){var t={},e={vertices:[],edges:[]},i=this.mappings().filter(function(t){return t.column()});return i.forEach(function(i,o){var r=this._db.rollupView([i.column()]);r.entries().forEach(function(r){var n=i.column()+":"+o+":"+r.key;t[n]||(e.vertices.push({__id:n,__category:i.column(),name:r.key,origRow:r.values}),t[n]=e.vertices.length-1)},this)},this),i.forEach(function(o,r){if(r<i.length-1){var n=i[r+1],a=this._db.rollupView([o.column(),n.column()]);a.entries().forEach(function(i){var a=o.column()+":"+r+":"+i.key;i.values.forEach(function(i){var o=n.column()+":"+(r+1)+":"+i.key;e.edges.push({__id:a+"_"+o,source:t[a],target:t[o],value:n.aggregate(i.values)})})})}},this),e},s.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this._d3Sankey=new n,this._d3SankeyPath=this._d3Sankey.link(),this._selection.widgetElement(i)},s.prototype.update=function(i,o){e.prototype.update.apply(this,arguments),this._palette=this._palette["switch"](this.paletteID());var r=this.sankeyData();this._d3Sankey.size([this.width(),this.height()]).nodeWidth(this.vertexWidth()).nodePadding(this.vertexPadding()).nodes(r.vertices).links(r.edges).layout(32);var n=this,a=o.selectAll(".link").data(r.edges);a.enter().append("path").attr("class","link").append("title"),a.attr("d",this._d3SankeyPath).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy}),a.select("title").text(function(t){return t.source.name+" → "+t.target.name+"\n"+t.value}),a.exit().remove();var s=o.selectAll(".node").data(r.vertices);s.enter().append("g").attr("class","node").call(this._selection.enter.bind(this._selection)).on("click",function(t,e){n.click(n.rowToObj(t.origRow[0]),"",n._selection.selected(this))}).on("dblclick",function(t,e){n.dblclick(n.rowToObj(t.origRow[0]),"",n._selection.selected(this))}).each(function(e){var i=t.select(this);i.append("rect"),i.append("text")}),s.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),s.select("rect").attr("height",function(t){return t.dy}).attr("width",this._d3Sankey.nodeWidth()).style("fill",function(t){return n._palette(t.name)}).style("cursor",this.xAxisMovement()||this.yAxisMovement()?null:"default"),s.select("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<n.width()/2}).attr("x",6+this._d3Sankey.nodeWidth()).attr("text-anchor","start"),s.exit().remove()},s.prototype.exit=function(t,i){e.prototype.exit.apply(this,arguments)},s.prototype.click=function(t,e,i){console.log("Click:  "+JSON.stringify(t)+", "+e+","+i)},s.prototype.dblclick=function(t,e,i){console.log("Double Click:  "+JSON.stringify(t)+", "+e+","+i)},s});