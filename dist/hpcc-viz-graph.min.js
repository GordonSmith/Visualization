"function"==typeof define&&define.amd&&define("css",[],function(){return{load:function(t,e,i){i()}}}),function(t,e){"function"==typeof define&&define.amd?define("graph/Edge",["d3","../common/SVGWidget","../common/TextBox","css!./Edge"],e):t.graph_Edge=e(t.d3,t.common_SVGWidget,t.common_TextBox)}(this,function(t,e,i){function r(){e.call(this),this._points=[],this._weight=100,this._strokeDasharray=null,this._hidden=!1,this._textBox=(new i).padding(0)}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" graph_Edge",r.prototype.publish("arcDepth",16,"number","Arc Depth",null,{tags:["Basic"]}),r.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),r.prototype.sourceVertex=function(t){return arguments.length?(this._sourceVertex=t,this):this._sourceVertex},r.prototype.targetVertex=function(t){return arguments.length?(this._targetVertex=t,this):this._targetVertex},r.prototype.sourceMarker=function(t){return arguments.length?(this._sourceMarker=t,this):this._sourceMarker},r.prototype.targetMarker=function(t){return arguments.length?(this._targetMarker=t,this):this._targetMarker},r.prototype.weight=function(t){return arguments.length?(this._weight=t,this):this._weight},r.prototype.strokeDasharray=function(t){return arguments.length?(this._strokeDasharray=t,this):this._strokeDasharray},r.prototype.points=function(t,e,i){return arguments.length?(this._points=t,this._elementPath&&this.update(null,this._element,e,i),this):this._points},r.prototype.hidden=function(t){return arguments.length?(this._hidden=t,this):this._hidden},r.prototype.text=function(t){return arguments.length?(this._textBox.text(t),this):this._textBox.text()},r.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this._elementPath=i.append("path"),this._tooltipElement=this._elementPath.append("title"),this._sourceMarker&&this._elementPath.attr("marker-start","url(#"+this._sourceMarker+")"),this._targetMarker&&this._elementPath.attr("marker-end","url(#"+this._targetMarker+")"),this._textBox.text()&&this._textBox.target(t).tooltip(this.tooltip()).render()},r.prototype.update=function(i,r,o,n){e.prototype.update.apply(this,arguments);var a=this;this.svgMarkerGlitch&&!n&&r.transition().duration((o?o:0)+100).each("start",function(t){a._pushMarkers(r,t)}).each("end",function(t){a._popMarkers(r,t)});var s=a._calculateEdgePoints(this._sourceVertex,this._targetVertex,this._points),h="";if(this._points.length||o,0){var c=s[2].x-s[0].x,p=s[2].y-s[0].y,l=2*Math.sqrt(c*c+p*p);h="M"+s[0].x+","+s[0].y+"A"+l+","+l+" 0 0,1 "+s[2].x+","+s[2].y}else h=t.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("bundle").tension(.75)(s);var u=this._elementPath;o&&(u=u.transition().duration(o)),u.attr("opacity",this._hidden?0:1).attr("stroke-dasharray",this._strokeDasharray).attr("d",h),this._tooltipElement.text(this.tooltip()),this._textBox.text()&&this._textBox.tooltip(this.tooltip()).move(this._findMidPoint(s),o)},r.prototype._findMidPoint=function(t){var e=t.length/2;if(t.length%2)return t[Math.floor(e)];if(t.length){var i=t[e-1],r=t[e];return{x:(i.x+r.x)/2,y:(i.y+r.y)/2}}return{x:0,y:0}},r.prototype._calculateEdgePoints=function(t,e,i){if(!t||!e)return[{x:0,y:0},{x:0,y:0}];var r=i?i.slice():[],o=0===r.length?e.pos():r[0],n=0===r.length?t.pos():r[r.length-1];if(r.unshift(t.intersection(t._pos,o)),r.push(e.intersection(e._pos,n)),r[0]||(r[0]=t._pos),r[r.length-1]||(r[r.length-1]=e._pos),2===r.length&&r[0]&&r[1]){var a=r[0].x-r[1].x,s=r[0].y-r[1].y,h=Math.sqrt(a*a+s*s);if(h){var c=(r[0].x+r[1].x)/2-s*this.arcDepth()/100,p=(r[0].y+r[1].y)/2+a*this.arcDepth()/100;r=[{x:r[0].x,y:r[0].y},{x:c,y:p},{x:r[1].x,y:r[1].y}]}}return r},r}),function(t,e){"function"==typeof define&&define.amd?define("graph/Vertex.js",["d3","../common/SVGWidget","../common/Icon","../common/TextBox","css!./Vertex"],e):t.graph_Vertex=e(t.d3,t.common_SVGWidget,t.common_Icon,t.common_TextBox)}(this,function(t,e,i,r){function o(){e.call(this),this._icon=new i,this._textBox=new r,this._annotationWidgets={}}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype._class+=" graph_Vertex",o.prototype.publishProxy("faChar","_icon"),o.prototype.publishProxy("imageUrl","_icon"),o.prototype.publishProxy("icon_shape_diameter","_icon","diameter"),o.prototype.publishProxy("icon_shape_colorFill","_icon","shape_colorFill"),o.prototype.publishProxy("icon_shape_colorStroke","_icon","shape_colorStroke"),o.prototype.publishProxy("icon_image_colorFill","_icon","image_colorFill"),o.prototype.publishProxy("text","_textBox"),o.prototype.publishProxy("anchor","_textBox"),o.prototype.publishProxy("textbox_shape_colorStroke","_textBox","shape_colorStroke"),o.prototype.publishProxy("textbox_shape_colorFill","_textBox","shape_colorFill"),o.prototype.publishProxy("textbox_text_colorFill","_textBox","text_colorFill"),o.prototype.publish("iconAnchor","start","set","Icon Anchor Position",["","start","middle","end"],{tags:["Basic"]}),o.prototype.publish("tooltip","","string","Tooltip",null,{tags:["Private"]}),o.prototype.publish("annotationDiameter",14,"number","Annotation Diameter",null,{tags:["Private"]}),o.prototype.publish("annotationSpacing",3,"number","Annotation Spacing",null,{tags:["Private"]}),o.prototype.publish("annotationIcons",[],"array","Annotations",null,{tags:["Private"]}),o.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this._icon.target(t).render(),this._textBox.target(t).render()},o.prototype.update=function(r,o){e.prototype.update.apply(this,arguments),this._icon.tooltip(this.tooltip()).render();var n=this._icon.getBBox(!0);this._textBox.tooltip(this.tooltip()).render();var a=this._textBox.getBBox(!0);switch(this.iconAnchor()){case"start":this._icon.move({x:-(a.width/2)+n.width/3,y:-(a.height/2)-n.height/3});break;case"middle":this._icon.move({x:0,y:-(a.height/2)-n.height/3});break;case"end":this._icon.move({x:a.width/2-n.width/3,y:-(a.height/2)-n.height/3})}var s=this,h=o.selectAll(".annotation").data(this.annotationIcons());h.enter().append("g").attr("class","annotation").each(function(t,e){s._annotationWidgets[e]=(new i).target(this).shape("square")});var c=a.width/2,p=a.height/2;h.each(function(t,e){var i=s._annotationWidgets[e];i.diameter(s.annotationDiameter()).shape_colorFill(s.textbox_shape_colorFill()).shape_colorStroke(s.textbox_shape_colorStroke());for(var r in t)i[r]&&i[r](t[r]);i.render();var o=i.getBBox(!0);i.move({x:c-o.width/4,y:p+o.height/4}),c-=o.width+s.annotationSpacing()}),h.exit().each(function(e,i){var r=t.select(this);delete s._annotationWidgets[i],r.remove()})},o.prototype.intersection=function(t,e){var i=this._icon.intersection(t,e,this._pos);if(i)return i;var r=this._textBox.intersection(t,e,this._pos);return r?r:null},o}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphData.js",["dagre"],e):t.graph_GraphData=e(t.dagre)}(this,function(t){function e(){t.graphlib.Graph.call(this,{multigraph:!0,compound:!0}),this.setGraph({}),this.setDefaultNodeLabel(function(){return{}}),this.setDefaultEdgeLabel(function(){return{}})}return e.prototype=Object.create(t.graphlib.Graph.prototype),e.prototype.constructor=e,e.prototype.setData=function(t,e,i,r){for(var o=this,n={addedVertices:[],addedEdges:[]},a=0;a<t.length;++a){var s=t[a];r&&this.hasNode(s._id)||(this.setNode(s._id,s),n.addedVertices.push(s))}for(a=0;a<e.length;++a){var h=e[a];r&&this.hasEdge(h._id)||(this.setEdge(h._sourceVertex._id,h._targetVertex._id,h,h._id),n.addedEdges.push(h))}if(i)for(a=0;a<i.length;++a)this.setParent(i[a].child._id,i[a].parent._id);if(r){var c=e.map(function(t){return t._id});this.filterEdges(function(t){return c.indexOf(t.v+"_"+t.w)<0}).forEach(function(t){});var p=t.map(function(t){return t._id});this.filterNodes(function(t){return p.indexOf(t)<0}).forEach(function(t){try{o.delNode(t)}catch(e){}})}return n},e.prototype.filterEdges=function(t){var e=[];return this.eachEdge(function(i){t(i)&&e.push(i)}),e},e.prototype.filterNodes=function(t){var e=[];return this.eachNode(function(i){t(i)&&e.push(i)}),e},e.prototype.nodeValues=function(){var t=[];return this.nodes().forEach(function(e,i){t.push(this.node(e))},this),t},e.prototype.eachNode=function(t){this.nodes().forEach(function(e,i){t(e,this.node(e))},this)},e.prototype.edgeValues=function(){var t=[];return this.edges().forEach(function(e,i){t.push(this.edge(e))},this),t},e.prototype.eachEdge=function(t){this.edges().forEach(function(e,i){t(e,e.v,e.w,this.edge(e))},this)},e.prototype.getJSON=function(){var e=t.graphlib.json.write(this);return JSON.stringify(e,function(t,e){return"value"===t?e._text&&e._text._text?e._text._text:e._id:e},"  ")},e}),function(t,e){"function"==typeof define&&define.amd?define("graph/GraphLayouts.js",["d3","dagre"],e):t.graph_GraphLayouts=e(t.d3,t.dagre)}(this,function(t,e){function i(t,e,i,r){var o=this;this.pos={};var n=0;r=r||(i>e?e-n:i-n)/2;var a=t.nodeCount(),s=-Math.PI/2,h=2*Math.PI/a;t.eachNode(function(t,e){var i=e.getBBox(!0),n=Math.max(i.width,i.height);o.pos[t]={x:e.fixed?e.x:Math.cos(s)*(r-n),y:e.fixed?e.y:Math.sin(s)*(r-n),width:i.width,height:i.height},s+=h})}function r(t,e,i,r){var o=this;this.pos={},t.eachNode(function(t,e){o.pos[t]={x:e.x,y:e.y,width:e.width,height:e.height}})}function o(e,i,r,o){o=o||{};var n=this;if(this.pos={},this.vertices=[],this.vertexMap={},e.eachNode(function(t){var i=e.node(t),r=i.getBBox(!0),o={id:t,x:i.pos().x,y:i.pos().y,width:r.width,height:r.height,value:i};n.vertices.push(o),n.vertexMap[t]=o}),this.edges=[],e.eachEdge(function(t,e,i){n.edges.push({source:n.vertexMap[e],target:n.vertexMap[i]})}),this.force=t.layout.force().linkDistance(o.linkDistance).linkStrength(o.linkStrength).friction(o.friction).charge(function(t){var e=t.value.getBBox();return o.charge*Math.max(e.width,e.height)}).chargeDistance(o.chargeDistance).theta(o.theta).gravity(o.gravity).nodes(this.vertices).links(this.edges),o.oneShot){this.force.start();var a=e.nodeCount();a=Math.min(a*a,500);for(var s=0;a>s;++s)this.force.tick();this.force.stop()}}function n(t,i,r,o){var n=new e.graphlib.Graph({multigraph:!0,compound:!0}).setGraph(o).setDefaultNodeLabel(function(){return{}}).setDefaultEdgeLabel(function(){return{}});t.eachNode(function(e){var i=t.node(e),r=i.getBBox();n.setNode(e,{width:r.width,height:r.height})}),t.eachEdge(function(e,i,r){var o=t.edge(e);n.setEdge(i,r,{weight:o.weight()},o._id)}),t.eachNode(function(e){n.setParent(e,t.parent(e))}),this.dagreLayout=e.layout(n);var a=-n.graph().width/2,s=-n.graph().height/2;n.nodes().forEach(function(t){var e=n.node(t);e.x+=a,e.y+=s}),n.edges().forEach(function(t){for(var e=n.edge(t),i=0;i<e.points.length;++i)e.points[i].x+=a,e.points[i].y+=s}),this.digraph=n}i.prototype.nodePos=function(t){return this.pos[t]},i.prototype.edgePoints=function(t){return[]},r.prototype.nodePos=function(t){return this.pos[t]},r.prototype.edgePoints=function(t){return[]},o.prototype.nodePos=function(t){return this.vertexMap[t]},o.prototype.edgePoints=function(t){return[]},n.prototype.nodePos=function(t){return this.digraph.node(t)},n.prototype.edgePoints=function(t){return this.digraph.edge(t._sourceVertex.id(),t._targetVertex.id(),t._id).points};var a={None:r,Circle:i,ForceDirected:o,Hierarchy:n};return a}),function(t,e){"function"==typeof define&&define.amd?define("graph/Graph.js",["d3","../common/SVGWidget","../common/Palette","../api/IGraph","./Vertex","./Edge","./GraphData","./GraphLayouts","../common/Utility","css!./Graph"],e):t.graph_Graph=e(t.d3,t.common_SVGWidget,t.common_Palette,t.api_IGraph,t.graph_Vertex,t.graph_Edge,t.graph_GraphData,t.graph_GraphLayouts,t.common_Utility)}(this,function(t,e,i,r,o,n,a,s,h){function c(){e.call(this),r.call(this),this.graphData=new a,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection}return c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype._class+=" graph_Graph",c.prototype["implements"](r.prototype),c.prototype.Vertex=o,c.prototype.Edge=n,c.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices",null,{tags:["Advanced"]}),c.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"],{tags:["Basic"]}),c.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"],{tags:["Basic"]}),c.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("transitionDuration",250,"number","Transition Duration",null,{tags:["Intermediate"]}),c.prototype.publish("showEdges",!0,"boolean","Show Edges",null,{tags:["Intermediate"]}),c.prototype.publish("snapToGrid",0,"number","Snap to Grid",null,{tags:["Private"]}),c.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"],{tags:["Advanced"]}),c.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedCharge",-25,"number","Charge strength ",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedTheta",.8,"number","Barnes–Hut approximation criterion",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength",null,{tags:["Advanced"]}),c.prototype.getOffsetPos=function(){return{x:0,y:0}},c.prototype.size=function(t){var i=e.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),i},c.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},c.prototype.data=function(t){var i=e.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new a,this._renderCount=0);var r=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),o=this;r.addedVertices.forEach(function(t){t.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),r.addedEdges.forEach(function(t){t._sourceMarker&&(t._sourceMarker=o._id+"_"+t._sourceMarker),t._targetMarker&&(t._targetMarker=o._id+"_"+t._targetMarker)});var n={};this.graphData.edgeValues().forEach(function(t){n[t._sourceVertex._id]||(n[t._sourceVertex._id]={}),n[t._sourceVertex._id][t._targetVertex._id]||(n[t._sourceVertex._id][t._targetVertex._id]=0);var e=++n[t._sourceVertex._id][t._targetVertex._id];t.arcDepth(16*e)})}return i},c.prototype.selection=function(t){return arguments.length?(this._selection.set(t),this):this._selection.get()},c.prototype.setZoom=function(t,e,i){this.zoom&&(this.zoom.translate(t),this.zoom.scale(e),this.applyZoom(i))},c.prototype.applyZoom=function(e){t.event&&t.event.sourceEvent&&t.event.sourceEvent.ctrlKey&&("wheel"===t.event.sourceEvent.type||"mousewheel"===t.event.sourceEvent.type||"DOMMouseScroll"===t.event.sourceEvent.type)&&t.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+t.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale)),(e?this.svg.transition().duration(e):this.svg).attr("transform","translate("+this.zoom.translate()+")scale("+this.zoom.scale()+")"),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this._fixIEMarkers(),this.prevScale=this.zoom.scale()),this.brush.x(t.scale.identity().domain([1*(-this.prevTranslate[0]-this._size.width/2)/this.zoom.scale(),1*(-this.prevTranslate[0]+this._size.width/2)/this.zoom.scale()])),this.brush.y(t.scale.identity().domain([1*(-this.prevTranslate[1]-this._size.height/2)/this.zoom.scale(),1*(-this.prevTranslate[1]+this._size.height/2)/this.zoom.scale()]))},c.prototype.enter=function(i,r){function o(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),s._dragging=!0,s.forceLayout){var i=s.forceLayout.vertexMap[e.id()];i.fixed=!0}s.svgMarkerGlitch&&s.graphData.nodeEdges(e.id()).forEach(function(t){var e=s.graphData.edge(t);s._pushMarkers(e.element(),e)})}}function n(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),e.move({x:t.event.x,y:t.event.y}),s.forceLayout){var i=s.forceLayout.vertexMap[e.id()];i.fixed=!0,i.x=i.px=t.event.x,i.y=i.py=t.event.y}s.refreshIncidentEdges(e,!0)}}function a(e){if(s.allowDragging()){if(t.event.sourceEvent.stopPropagation(),s._dragging=!1,s.snapToGrid()){var i=e.calcSnap(s.snapToGrid());e.move(i[0]),s.refreshIncidentEdges(e,!0)}if(s.forceLayout){var r=s.forceLayout.vertexMap[e.id()];r.fixed=!1}s.svgMarkerGlitch&&s.graphData.nodeEdges(e.id()).forEach(function(t){var e=s.graphData.edge(t);s._popMarkers(e.element(),e)})}}e.prototype.enter.apply(this,arguments);var s=this;this.prevTranslate=[0,0],this.prevScale=1,this.zoom=t.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(e){switch(s.prevTranslate=s.zoom.translate(),s.prevScale=s.zoom.scale(),t.event.sourceEvent&&t.event.sourceEvent.shiftKey&&t.event.sourceEvent.ctrlKey?s._zoomMode="selection":t.event.sourceEvent&&t.event.sourceEvent.shiftKey?(s._zoomMode="selection",s._selection.clear()):s._zoomMode="zoom",s._zoomMode){case"selection":r.select(".extent").style("visibility",null);break;default:r.select(".extent").style("visibility","hidden")}}).on("zoomend",function(t){switch(s._zoomMode){case"selection":s.zoom.translate(s.prevTranslate),s.zoom.scale(s.prevScale)}s._svgBrush.call(s.brush.clear())}).on("zoom",function(t){switch(s._zoomMode){case"selection":break;default:s.applyZoom()}}),this.brush=t.svg.brush().x(t.scale.identity().domain([-s._size.width/2,s._size.width/2])).y(t.scale.identity().domain([-s._size.height/2,s._size.height/2])).on("brushstart",function(t){switch(s._zoomMode){case"selection":}}).on("brushend",function(e){switch(s._zoomMode){case"selection":var i=t.event.target.extent();s.svgV.selectAll(".graphVertex").select("*").each(function(t){i[0][0]<=t.x()&&t.x()<i[1][0]&&i[0][1]<=t.y()&&t.y()<i[1][1]&&s._selection.append(t)}),s.graph_selection(s.selection())}}).on("brush",function(){switch(s._zoomMode){case"selection":var e=s.zoom.translate();console.log(e[0]);var i=t.event.target.extent();s.svgV.selectAll(".graphVertex").select("*").classed("selected",function(t){return s._selection.isSelected(t)||i[0][0]<=t.x()&&t.x()<i[1][0]&&i[0][1]<=t.y()&&t.y()<i[1][1]})}}),this.drag=t.behavior.drag().origin(function(t){return t.pos()}).on("dragstart",o).on("dragend",a).on("drag",n),this._svgZoom=r.append("rect").attr("class","zoom").attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),this.defs=r.append("defs"),this.addMarkers(),r.call(this.zoom),this.svg=r.append("g"),this._svgBrush=this.svg.append("g").attr("class","selectionBrush").call(this.brush),this._svgBrush.select(".background").style("cursor",null),s._svgBrush.call(s.brush.clear()),this.svgC=this.svg.append("g").attr("id",this._id+"C"),this.svgE=this.svg.append("g").attr("id",this._id+"E"),this.svgV=this.svg.append("g").attr("id",this._id+"V")},c.prototype.getBounds=function(t,e){var i=[[null,null],[null,null]];return t.forEach(function(t){var r=e?e.nodePos(t._id):{x:t.x(),y:t.y(),width:t.width(),height:t.height()},o=r.x-r.width/2,n=r.x+r.width/2,a=r.y-r.height/2,s=r.y+r.height/2;(null===i[0][0]||i[0][0]>o)&&(i[0][0]=o),(null===i[0][1]||i[0][1]>a)&&(i[0][1]=a),(null===i[1][0]||i[1][0]<n)&&(i[1][0]=n),(null===i[1][1]||i[1][1]<s)&&(i[1][1]=s)}),i},c.prototype.getVertexBounds=function(t){return this.getBounds(this.graphData.nodeValues(),t)},c.prototype.getSelectionBounds=function(t){return this.getBounds(this._selection.get(),t)},c.prototype.shrinkToFit=function(t,e){var i=this.width(),r=this.height(),o=t[1][0]-t[0][0],n=t[1][1]-t[0][1],a=(t[0][0]+t[1][0])/2,s=(t[0][1]+t[1][1])/2,h=1/Math.max(o/i,n/r);h>1&&(h=1);var c=[-h*a,-h*s];this.setZoom(c,h,e)},c.prototype._origScale=c.prototype.scale,c.prototype.scale=function(t,e){var i=c.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(t,e),i},c.prototype.zoomTo=function(t,e){switch(t){case"all":this.shrinkToFit(this.getVertexBounds(),e);break;case"width":var i=this.getVertexBounds();i[0][1]=0,i[1][1]=0,this.shrinkToFit(i,e);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),e);break;default:var r=parseInt(t);(isNaN(r)||0>=r||r>200)&&(r=100),this.zoom.scale(r/100),this.applyZoom(e)}},c.prototype.centerOn=function(t,e){var i=(t[0][0]+t[1][0])/2,r=(t[0][1]+t[1][1])/2,o=[i,r];this.setZoom(o,1,e)},c.prototype._origLayout=c.prototype.layout,c.prototype.layout=function(t,e){var i=c.prototype._origLayout.apply(this,arguments);if(arguments.length&&this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var r=this,o=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=o,this.forceLayout.force.on("tick",function(t){if(o.vertices.forEach(function(t){var e=r.graphData.node(t.id);t.fixed?(t.x=t.px,t.y=t.py):(t.px=t.x,t.py=t.y,e.move({x:t.x,y:t.y}))}),r.graphData.edgeValues().forEach(function(t){t.points([],!1,!1)}),r.applyScaleOnLayout()){var e=r.getVertexBounds(o);r.shrinkToFit(e)}}),this.forceLayout.force.start();else if(o){if(this.forceLayout=null,r._dragging=!0,r.graphData.nodeValues().forEach(function(t){var i=o.nodePos(t._id);t.move({x:i.x,y:i.y},e),i.width&&i.height&&!t.width()&&!t.height()&&t.width(i.width).height(i.height).render()}),r.graphData.edgeValues().forEach(function(t){var i=o.edgePoints(t);t.points(i,e)}),r.applyScaleOnLayout()){var n=r.getVertexBounds(o);r.shrinkToFit(n,e)}this._fixIEMarkers(),setTimeout(function(){r._dragging=!1},e?e+50:50)}}return i},c.prototype.update=function(i,r){function o(t){t.target(this).render(),t.element().call(h.drag),t.dispatch&&(t.dispatch.on("sizestart",function(t,e){t.allowResize(h.allowDragging()),h.allowDragging()&&(h._dragging=!0)}),t.dispatch.on("size",function(t,e){h.refreshIncidentEdges(t,!1)}),t.dispatch.on("sizeend",function(t,e){if(h._dragging=!1,h.snapToGrid()){var i=t.calcSnap(h.snapToGrid());t.pos(i[0]).size(i[1]).render(),h.refreshIncidentEdges(t,!1)}}))}function n(t){t.target(this).render()}function a(t){t.render()}function s(t){t.render()}e.prototype.update.apply(this,arguments);var h=this,c=this.svgV.selectAll("#"+this._id+"V > .graphVertex").data(this.graphData.nodeValues(),function(t){return t.id()});c.enter().append("g").attr("class","graphVertex").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(e){h.vertex_click(e,t.event)}).on("dblclick",function(e){h.vertex_dblclick(e,t.event)}).on("mouseover",function(e){h._dragging||h.vertex_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.vertex_mouseout(t.select(this),e)}).each(o).transition().duration(750).style("opacity",1);var p=this.svgE.selectAll("#"+this._id+"E > .graphEdge").data(this.showEdges()?this.graphData.edgeValues():[],function(t){return t.id()});p.enter().append("g").attr("class","graphEdge").style("opacity",1e-6).on("click.selectionBag",function(e){h._selection.click(e,t.event)}).on("click",function(t){h.edge_click(t)}).on("mouseover",function(e){h._dragging||h.edge_mouseover(t.select(this),e)}).on("mouseout",function(e){h._dragging||h.edge_mouseout(t.select(this),e)}).each(n).transition().duration(750).style("opacity",1),c.each(a),p.each(s),c.exit().each(function(t){t.target(null)}).remove(),p.exit().each(function(t){t.target(null)}).remove(),this._renderCount||(this._renderCount++,this.setZoom([0,0],1),this.layout(this.layout()))},c.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new s.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new s.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new s.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},c.prototype.getNeighborMap=function(t){var e={},i={};if(t)for(var r=this.graphData.nodeEdges(t.id()),o=0;o<r.length;++o){var n=this.graphData.edge(r[o]);i[n.id()]=n,n._sourceVertex.id()!==t.id()&&(e[n._sourceVertex.id()]=n._sourceVertex),n._targetVertex.id()!==t.id()&&(e[n._targetVertex.id()]=n._targetVertex)}return{vertices:e,edges:i}},c.prototype.highlightVerticies=function(t){var e=this,i=this.svgV.selectAll(".graphVertex");return i.transition().duration(this.transitionDuration()).each("end",function(e){t&&t[e.id()]&&e._parentElement.node()&&e._parentElement.node().parentNode&&e._parentElement.node().parentNode.appendChild(e._parentElement.node())}).style("opacity",function(i){return!t||t[i.id()]?1:e.highlight.opacity}),this},c.prototype.highlightEdges=function(t){var e=this,i=this.svgE.selectAll(".graphEdge");return i.style("stroke-width",function(i){return t&&t[i.id()]?e.highlight.edge:"1px"}).transition().duration(this.transitionDuration()).style("opacity",function(i){return!t||t[i.id()]?1:e.highlight.opacity}),this},c.prototype.highlightVertex=function(t,e){if(this.highlightOnMouseOverVertex())if(e){var i=this.getNeighborMap(e);i.vertices[e.id()]=e,this.highlightVerticies(i.vertices),this.highlightEdges(i.edges)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.highlightEdge=function(t,e){if(this.highlightOnMouseOverEdge())if(e){var i={};i[e._sourceVertex.id()]=e._sourceVertex,i[e._targetVertex.id()]=e._targetVertex;var r={};r[e.id()]=e,this.highlightVerticies(i),this.highlightEdges(r)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.refreshIncidentEdges=function(t,e){var i=this;this.graphData.nodeEdges(t.id()).forEach(function(t){var r=i.graphData.edge(t);r.points([],!1,e)})},c.prototype.graph_selection=function(t){},c.prototype.vertex_click=function(t){t._parentElement.node().parentNode.appendChild(t._parentElement.node()),r.prototype.vertex_click.apply(this,arguments)},c.prototype.vertex_dblclick=function(t){},c.prototype.vertex_mouseover=function(t,e){this.highlightVertex(t,e)},c.prototype.vertex_mouseout=function(t,e){this.highlightVertex(null,null)},c.prototype.edge_mouseover=function(t,e){this.highlightEdge(t,e)},c.prototype.edge_mouseout=function(t,e){this.highlightEdge(null,null)},c.prototype.addMarkers=function(t){t&&(this.defs.select("#"+this._id+"_arrowHead").remove(),this.defs.select("#"+this._id+"_circleFoot").remove(),this.defs.select("#"+this._id+"_circleHead").remove()),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_arrowHead").attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",8).attr("markerHeight",8).attr("markerUnits","strokeWidth").attr("orient","auto").append("polyline").attr("points","0,0 10,5 0,10 1,5"),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleFoot").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleHead").attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4)},c}),function(t,e){"function"==typeof define&&define.amd?define("graph/Sankey.js",["d3","../common/SVGWidget","../common/Palette","../common/PropertyExt","d3-sankey","css!./Sankey"],e):t.graph_Sankey=e(t.d3,t.common_SVGWidget,t.common_Palette,t.common_PropertyExt,t.d3.sankey)}(this,function(t,e,i,r,o){function n(t){r.call(this),this._owner=t}function a(t){e.call(this),this._drawStartPos="origin"}return o=o||t.sankey||window.d3.sankey,n.prototype=Object.create(r.prototype),n.prototype.constructor=n,n.prototype._class+=" graph_Sankey.Column",n.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),n.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0,disable:function(t){return!t._owner||0===t._owner.mappings().indexOf(t)}}),n.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this._owner?this._owner.columns():[]},{optional:!0,disable:function(t){return!t._owner||!t.aggrType()||0===t._owner.mappings().indexOf(t)}}),n.prototype.aggregate=function(e){switch(this.aggrType()){case null:case void 0:case"":return e.length;default:var i=this._owner.columns(),r=i.indexOf(this.aggrColumn());return t[this.aggrType()](e,function(t){return+t[r]})}},a.prototype=Object.create(e.prototype),a.prototype.constructor=a,a.prototype._class+=" graph_Sankey",a.prototype.Column=n,a.prototype._palette=i.ordinal("default"),a.prototype.publish("paletteID","default","set","Palette ID",a.prototype._palette["switch"]()),a.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:n}),a.prototype.publish("vertexWidth",36,"number","Vertex Width"),a.prototype.publish("vertexPadding",40,"number","Vertex Padding"),a.prototype.publish("xAxisMovement",!1,"boolean","Enable x-axis movement"),a.prototype.publish("yAxisMovement",!1,"boolean","Enable y-axis movement"),a.prototype.sankeyData=function(){var t={},e={vertices:[],edges:[]},i=this.mappings().filter(function(t){return t.column()});return i.forEach(function(i,r){var o=this._db.rollupView([i.column()]);o.entries().forEach(function(o){var n=i.column()+":"+r+":"+o.key;t[n]||(e.vertices.push({__id:n,__category:i.column(),name:o.key,origRow:o}),t[n]=e.vertices.length-1)},this)},this),i.forEach(function(r,o){if(o<i.length-1){var n=i[o+1],a=this._db.rollupView([r.column(),n.column()]);a.entries().forEach(function(i){var a=r.column()+":"+o+":"+i.key;i.values.forEach(function(i){var r=n.column()+":"+(o+1)+":"+i.key;e.edges.push({__id:a+"_"+r,source:t[a],target:t[r],value:n.aggregate(i.values)})})})}},this),e},a.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this._d3Sankey=new o,
this._d3SankeyPath=this._d3Sankey.link()},a.prototype.update=function(i,r){function o(e){var i=t.select(this);a.xAxisMovement()&&(e.x=Math.max(0,Math.min(a.width()-e.dx,t.event.x))),a.yAxisMovement()&&(e.y=Math.max(0,Math.min(a.height()-e.dy,t.event.y))),i.attr("transform","translate("+e.x+","+e.y+")"),a._d3Sankey.relayout(),s.attr("d",a._d3SankeyPath),i.select("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<a.width()/2}).attr("x",6+a._d3Sankey.nodeWidth()).attr("text-anchor","start")}e.prototype.update.apply(this,arguments),this._palette=this._palette["switch"](this.paletteID());var n=this.sankeyData();this._d3Sankey.size([this.width(),this.height()]).nodeWidth(this.vertexWidth()).nodePadding(this.vertexPadding()).nodes(n.vertices).links(n.edges).layout(32);var a=this,s=r.selectAll(".link").data(n.edges);s.enter().append("path").attr("class","link").append("title"),s.attr("d",this._d3SankeyPath).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy}),s.select("title").text(function(t){return t.source.name+" → "+t.target.name+"\n"+t.value}),s.exit().remove();var h=r.selectAll(".node").data(n.vertices);h.enter().append("g").attr("class","node").each(function(e){var i=t.select(this);i.append("rect"),i.append("text")}).on("click.mouse",function(t,e){a.click(t.origRow,"",!0)}).call(t.behavior.drag().origin(function(t){return t}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",o)),h.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),h.select("rect").attr("height",function(t){return t.dy}).attr("width",this._d3Sankey.nodeWidth()).style("fill",function(t){return a._palette(t.name)}).style("stroke",function(e){return t.rgb(a._palette(e.name)).darker(2)}).style("cursor",this.xAxisMovement()||this.yAxisMovement()?null:"default"),h.select("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<a.width()/2}).attr("x",6+this._d3Sankey.nodeWidth()).attr("text-anchor","start"),h.exit().remove()},a.prototype.exit=function(t,i){e.prototype.exit.apply(this,arguments)},a.prototype.click=function(t,e,i){console.log(t+", "+e+", "+i)},a});