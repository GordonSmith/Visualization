export interface Subgraph {
    id: string;
    text: string;
}

export interface Node {
    id: string;
    text: string;
}

export interface Link {
    id: string;
    source: Node;
    target: Node;
}

export interface Hierarchy {
    parent: string;
    child: string;
}

export interface Data {
    subgraphs: Subgraph[];
    nodes: Node[];
    links: Link[];
    hierarchy: Hierarchy[];
}

export interface Options {
    rankdir: "TB" | "BT" | "LR" | "RL";
    nodesep: number;
    edgesep: number;
    ranksep: number;
    digraph: boolean;
}

export function dagre(data: Data, options: Options) {
    // eslint-disable-next-line quotes
    const workerCode = `!function(){"use strict";var e,n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};try{e=require("graphlib")}catch(e){}e||(e=window.graphlib);var r,t=e;try{r={cloneDeep:require("lodash/cloneDeep"),constant:require("lodash/constant"),defaults:require("lodash/defaults"),each:require("lodash/each"),filter:require("lodash/filter"),find:require("lodash/find"),flatten:require("lodash/flatten"),forEach:require("lodash/forEach"),forIn:require("lodash/forIn"),has:require("lodash/has"),isUndefined:require("lodash/isUndefined"),last:require("lodash/last"),map:require("lodash/map"),mapValues:require("lodash/mapValues"),max:require("lodash/max"),merge:require("lodash/merge"),min:require("lodash/min"),minBy:require("lodash/minBy"),now:require("lodash/now"),pick:require("lodash/pick"),range:require("lodash/range"),reduce:require("lodash/reduce"),sortBy:require("lodash/sortBy"),uniqueId:require("lodash/uniqueId"),values:require("lodash/values"),zipObject:require("lodash/zipObject")}}catch(e){}r||(r=window._);var o=r,i=a;function a(){var e={};e._next=e._prev=e,this._sentinel=e}function u(e){e._prev._next=e._next,e._next._prev=e._prev,delete e._next,delete e._prev}function c(e,n){if("_next"!==e&&"_prev"!==e)return n}a.prototype.dequeue=function(){var e=this._sentinel,n=e._prev;if(n!==e)return u(n),n},a.prototype.enqueue=function(e){var n=this._sentinel;e._prev&&e._next&&u(e),e._next=n._next,n._next._prev=e,n._next=e,e._prev=n},a.prototype.toString=function(){for(var e=[],n=this._sentinel,r=n._prev;r!==n;)e.push(JSON.stringify(r,c)),r=r._prev;return"["+e.join(", ")+"]"};var s=o,f=t.Graph,d=i,h=function(e,n){if(e.nodeCount()<=1)return[];var r=function(e,n){var r=new f,t=0,o=0;s.forEach(e.nodes(),(function(e){r.setNode(e,{v:e,in:0,out:0})})),s.forEach(e.edges(),(function(e){var i=r.edge(e.v,e.w)||0,a=n(e),u=i+a;r.setEdge(e.v,e.w,u),o=Math.max(o,r.node(e.v).out+=a),t=Math.max(t,r.node(e.w).in+=a)}));var i=s.range(o+t+3).map((function(){return new d})),a=t+1;return s.forEach(r.nodes(),(function(e){g(i,a,r.node(e))})),{graph:r,buckets:i,zeroIdx:a}}(e,n||l),t=function(e,n,r){var t,o=[],i=n[n.length-1],a=n[0];for(;e.nodeCount();){for(;t=a.dequeue();)v(e,n,r,t);for(;t=i.dequeue();)v(e,n,r,t);if(e.nodeCount())for(var u=n.length-2;u>0;--u)if(t=n[u].dequeue()){o=o.concat(v(e,n,r,t,!0));break}}return o}(r.graph,r.buckets,r.zeroIdx);return s.flatten(s.map(t,(function(n){return e.outEdges(n.v,n.w)})),!0)},l=s.constant(1);function v(e,n,r,t,o){var i=o?[]:void 0;return s.forEach(e.inEdges(t.v),(function(t){var a=e.edge(t),u=e.node(t.v);o&&i.push({v:t.v,w:t.w}),u.out-=a,g(n,r,u)})),s.forEach(e.outEdges(t.v),(function(t){var o=e.edge(t),i=t.w,a=e.node(i);a.in-=o,g(n,r,a)})),e.removeNode(t.v),i}function g(e,n,r){r.out?r.in?e[r.out-r.in+n].enqueue(r):e[e.length-1].enqueue(r):e[0].enqueue(r)}var p=o,m=h,w={run:function(e){var n="greedy"===e.graph().acyclicer?m(e,function(e){return function(n){return e.edge(n).weight}}(e)):function(e){var n=[],r={},t={};function o(i){p.has(t,i)||(t[i]=!0,r[i]=!0,p.forEach(e.outEdges(i),(function(e){p.has(r,e.w)?n.push(e):o(e.w)})),delete r[i])}return p.forEach(e.nodes(),o),n}(e);p.forEach(n,(function(n){var r=e.edge(n);e.removeEdge(n),r.forwardName=n.name,r.reversed=!0,e.setEdge(n.w,n.v,r,p.uniqueId("rev"))}))},undo:function(e){p.forEach(e.edges(),(function(n){var r=e.edge(n);if(r.reversed){e.removeEdge(n);var t=r.forwardName;delete r.reversed,delete r.forwardName,e.setEdge(n.w,n.v,r,t)}}))}};var E=o,y=t.Graph,b={addDummyNode:_,simplify:function(e){var n=(new y).setGraph(e.graph());return E.forEach(e.nodes(),(function(r){n.setNode(r,e.node(r))})),E.forEach(e.edges(),(function(r){var t=n.edge(r.v,r.w)||{weight:0,minlen:1},o=e.edge(r);n.setEdge(r.v,r.w,{weight:t.weight+o.weight,minlen:Math.max(t.minlen,o.minlen)})})),n},asNonCompoundGraph:function(e){var n=new y({multigraph:e.isMultigraph()}).setGraph(e.graph());return E.forEach(e.nodes(),(function(r){e.children(r).length||n.setNode(r,e.node(r))})),E.forEach(e.edges(),(function(r){n.setEdge(r,e.edge(r))})),n},successorWeights:function(e){var n=E.map(e.nodes(),(function(n){var r={};return E.forEach(e.outEdges(n),(function(n){r[n.w]=(r[n.w]||0)+e.edge(n).weight})),r}));return E.zipObject(e.nodes(),n)},predecessorWeights:function(e){var n=E.map(e.nodes(),(function(n){var r={};return E.forEach(e.inEdges(n),(function(n){r[n.v]=(r[n.v]||0)+e.edge(n).weight})),r}));return E.zipObject(e.nodes(),n)},intersectRect:function(e,n){var r,t,o=e.x,i=e.y,a=n.x-o,u=n.y-i,c=e.width/2,s=e.height/2;if(!a&&!u)throw new Error("Not possible to find intersection inside of the rectangle");Math.abs(u)*c>Math.abs(a)*s?(u<0&&(s=-s),r=s*a/u,t=s):(a<0&&(c=-c),r=c,t=c*u/a);return{x:o+r,y:i+t}},buildLayerMatrix:function(e){var n=E.map(E.range(x(e)+1),(function(){return[]}));return E.forEach(e.nodes(),(function(r){var t=e.node(r),o=t.rank;E.isUndefined(o)||(n[o][t.order]=r)})),n},normalizeRanks:function(e){var n=E.min(E.map(e.nodes(),(function(n){return e.node(n).rank})));E.forEach(e.nodes(),(function(r){var t=e.node(r);E.has(t,"rank")&&(t.rank-=n)}))},removeEmptyRanks:function(e){var n=E.min(E.map(e.nodes(),(function(n){return e.node(n).rank}))),r=[];E.forEach(e.nodes(),(function(t){var o=e.node(t).rank-n;r[o]||(r[o]=[]),r[o].push(t)}));var t=0,o=e.graph().nodeRankFactor;E.forEach(r,(function(n,r){E.isUndefined(n)&&r%o!=0?--t:t&&E.forEach(n,(function(n){e.node(n).rank+=t}))}))},addBorderNode:function(e,n,r,t){var o={width:0,height:0};arguments.length>=4&&(o.rank=r,o.order=t);return _(e,"border",o,n)},maxRank:x,partition:function(e,n){var r={lhs:[],rhs:[]};return E.forEach(e,(function(e){n(e)?r.lhs.push(e):r.rhs.push(e)})),r},time:function(e,n){var r=E.now();try{return n()}finally{console.log(e+" time: "+(E.now()-r)+"ms")}},notime:function(e,n){return n()}};function _(e,n,r,t){var o;do{o=E.uniqueId(t)}while(e.hasNode(o));return r.dummy=n,e.setNode(o,r),o}function x(e){return E.max(E.map(e.nodes(),(function(n){var r=e.node(n).rank;if(!E.isUndefined(r))return r})))}var k=o,N=b,I={run:function(e){e.graph().dummyChains=[],k.forEach(e.edges(),(function(n){!function(e,n){var r,t,o,i=n.v,a=e.node(i).rank,u=n.w,c=e.node(u).rank,s=n.name,f=e.edge(n),d=f.labelRank;if(c===a+1)return;for(e.removeEdge(n),o=0,++a;a<c;++o,++a)f.points=[],t={width:0,height:0,edgeLabel:f,edgeObj:n,rank:a},r=N.addDummyNode(e,"edge",t,"_d"),a===d&&(t.width=f.width,t.height=f.height,t.dummy="edge-label",t.labelpos=f.labelpos),e.setEdge(i,r,{weight:f.weight},s),0===o&&e.graph().dummyChains.push(r),i=r;e.setEdge(i,u,{weight:f.weight},s)}(e,n)}))},undo:function(e){k.forEach(e.graph().dummyChains,(function(n){var r,t=e.node(n),o=t.edgeLabel;for(e.setEdge(t.edgeObj,o);t.dummy;)r=e.successors(n)[0],e.removeNode(n),o.points.push({x:t.x,y:t.y}),"edge-label"===t.dummy&&(o.x=t.x,o.y=t.y,o.width=t.width,o.height=t.height),n=r,t=e.node(n)}))}};var q=o,M={longestPath:function(e){var n={};q.forEach(e.sources(),(function r(t){var o=e.node(t);if(q.has(n,t))return o.rank;n[t]=!0;var i=q.min(q.map(e.outEdges(t),(function(n){return r(n.w)-e.edge(n).minlen})));return i!==Number.POSITIVE_INFINITY&&null!=i||(i=0),o.rank=i}))},slack:function(e,n){return e.node(n.w).rank-e.node(n.v).rank-e.edge(n).minlen}};var T=o,R=t.Graph,L=M.slack,C=function(e){var n,r,t=new R({directed:!1}),o=e.nodes()[0],i=e.nodeCount();t.setNode(o,{});for(;P(t,e)<i;)n=S(t,e),r=t.hasNode(n.v)?L(e,n):-L(e,n),B(t,e,r);return t};function P(e,n){return T.forEach(e.nodes(),(function r(t){T.forEach(n.nodeEdges(t),(function(o){var i=o.v,a=t===i?o.w:i;e.hasNode(a)||L(n,o)||(e.setNode(a,{}),e.setEdge(t,a,{}),r(a))}))})),e.nodeCount()}function S(e,n){return T.minBy(n.edges(),(function(r){if(e.hasNode(r.v)!==e.hasNode(r.w))return L(n,r)}))}function B(e,n,r){T.forEach(e.nodes(),(function(e){n.node(e).rank+=r}))}var G=o,j=C,O=M.slack,A=M.longestPath,V=t.alg.preorder,D=t.alg.postorder,F=b.simplify,U=z;function z(e){e=F(e),A(e);var n,r=j(e);for(J(r),Y(r,e);n=H(r);)X(r,e,n,Q(r,e,n))}function Y(e,n){var r=D(e,e.nodes());r=r.slice(0,r.length-1),G.forEach(r,(function(r){!function(e,n,r){var t=e.node(r).parent;e.edge(r,t).cutvalue=W(e,n,r)}(e,n,r)}))}function W(e,n,r){var t=e.node(r).parent,o=!0,i=n.edge(r,t),a=0;return i||(o=!1,i=n.edge(t,r)),a=i.weight,G.forEach(n.nodeEdges(r),(function(i){var u,c,s=i.v===r,f=s?i.w:i.v;if(f!==t){var d=s===o,h=n.edge(i).weight;if(a+=d?h:-h,u=r,c=f,e.hasEdge(u,c)){var l=e.edge(r,f).cutvalue;a+=d?-l:l}}})),a}function J(e,n){arguments.length<2&&(n=e.nodes()[0]),K(e,{},1,n)}function K(e,n,r,t,o){var i=r,a=e.node(t);return n[t]=!0,G.forEach(e.neighbors(t),(function(o){G.has(n,o)||(r=K(e,n,r,o,t))})),a.low=i,a.lim=r++,o?a.parent=o:delete a.parent,r}function H(e){return G.find(e.edges(),(function(n){return e.edge(n).cutvalue<0}))}function Q(e,n,r){var t=r.v,o=r.w;n.hasEdge(t,o)||(t=r.w,o=r.v);var i=e.node(t),a=e.node(o),u=i,c=!1;i.lim>a.lim&&(u=a,c=!0);var s=G.filter(n.edges(),(function(n){return c===Z(e,e.node(n.v),u)&&c!==Z(e,e.node(n.w),u)}));return G.minBy(s,(function(e){return O(n,e)}))}function X(e,n,r,t){var o=r.v,i=r.w;e.removeEdge(o,i),e.setEdge(t.v,t.w,{}),J(e),Y(e,n),function(e,n){var r=G.find(e.nodes(),(function(e){return!n.node(e).parent})),t=V(e,r);t=t.slice(1),G.forEach(t,(function(r){var t=e.node(r).parent,o=n.edge(r,t),i=!1;o||(o=n.edge(t,r),i=!0),n.node(r).rank=n.node(t).rank+(i?o.minlen:-o.minlen)}))}(e,n)}function Z(e,n,r){return r.low<=n.lim&&n.lim<=r.lim}z.initLowLimValues=J,z.initCutValues=Y,z.calcCutValue=W,z.leaveEdge=H,z.enterEdge=Q,z.exchangeEdges=X;var $=M.longestPath,ee=C,ne=U,re=function(e){switch(e.graph().ranker){case"network-simplex":default:oe(e);break;case"tight-tree":!function(e){$(e),ee(e)}(e);break;case"longest-path":te(e)}};var te=$;function oe(e){ne(e)}var ie=o,ae=function(e){var n=function(e){var n={},r=0;function t(o){var i=r;ie.forEach(e.children(o),t),n[o]={low:i,lim:r++}}return ie.forEach(e.children(),t),n}(e);ie.forEach(e.graph().dummyChains,(function(r){for(var t=e.node(r),o=t.edgeObj,i=function(e,n,r,t){var o,i,a=[],u=[],c=Math.min(n[r].low,n[t].low),s=Math.max(n[r].lim,n[t].lim);o=r;do{o=e.parent(o),a.push(o)}while(o&&(n[o].low>c||s>n[o].lim));i=o,o=t;for(;(o=e.parent(o))!==i;)u.push(o);return{path:a.concat(u.reverse()),lca:i}}(e,n,o.v,o.w),a=i.path,u=i.lca,c=0,s=a[c],f=!0;r!==o.w;){if(t=e.node(r),f){for(;(s=a[c])!==u&&e.node(s).maxRank<t.rank;)c++;s===u&&(f=!1)}if(!f){for(;c<a.length-1&&e.node(s=a[c+1]).minRank<=t.rank;)c++;s=a[c]}e.setParent(r,s),r=e.successors(r)[0]}}))};var ue=o,ce=b,se={run:function(e){var n=ce.addDummyNode(e,"root",{},"_root"),r=function(e){var n={};function r(t,o){var i=e.children(t);i&&i.length&&ue.forEach(i,(function(e){r(e,o+1)})),n[t]=o}return ue.forEach(e.children(),(function(e){r(e,1)})),n}(e),t=ue.max(ue.values(r))-1,o=2*t+1;e.graph().nestingRoot=n,ue.forEach(e.edges(),(function(n){e.edge(n).minlen*=o}));var i=function(e){return ue.reduce(e.edges(),(function(n,r){return n+e.edge(r).weight}),0)}(e)+1;ue.forEach(e.children(),(function(a){fe(e,n,o,i,t,r,a)})),e.graph().nodeRankFactor=o},cleanup:function(e){var n=e.graph();e.removeNode(n.nestingRoot),delete n.nestingRoot,ue.forEach(e.edges(),(function(n){e.edge(n).nestingEdge&&e.removeEdge(n)}))}};function fe(e,n,r,t,o,i,a){var u=e.children(a);if(u.length){var c=ce.addBorderNode(e,"_bt"),s=ce.addBorderNode(e,"_bb"),f=e.node(a);e.setParent(c,a),f.borderTop=c,e.setParent(s,a),f.borderBottom=s,ue.forEach(u,(function(u){fe(e,n,r,t,o,i,u);var f=e.node(u),d=f.borderTop?f.borderTop:u,h=f.borderBottom?f.borderBottom:u,l=f.borderTop?t:2*t,v=d!==h?1:o-i[a]+1;e.setEdge(c,d,{weight:l,minlen:v,nestingEdge:!0}),e.setEdge(h,s,{weight:l,minlen:v,nestingEdge:!0})})),e.parent(a)||e.setEdge(n,c,{weight:0,minlen:o+i[a]})}else a!==n&&e.setEdge(n,a,{weight:0,minlen:r})}var de=o,he=b,le=function(e){de.forEach(e.children(),(function n(r){var t=e.children(r),o=e.node(r);if(t.length&&de.forEach(t,n),de.has(o,"minRank")){o.borderLeft=[],o.borderRight=[];for(var i=o.minRank,a=o.maxRank+1;i<a;++i)ve(e,"borderLeft","_bl",r,o,i),ve(e,"borderRight","_br",r,o,i)}}))};function ve(e,n,r,t,o,i){var a={width:0,height:0,rank:i,borderType:n},u=o[n][i-1],c=he.addDummyNode(e,"border",a,r);o[n][i]=c,e.setParent(c,t),u&&e.setEdge(u,c,{weight:1})}var ge=o,pe={adjust:function(e){var n=e.graph().rankdir.toLowerCase();"lr"!==n&&"rl"!==n||me(e)},undo:function(e){var n=e.graph().rankdir.toLowerCase();"bt"!==n&&"rl"!==n||function(e){ge.forEach(e.nodes(),(function(n){Ee(e.node(n))})),ge.forEach(e.edges(),(function(n){var r=e.edge(n);ge.forEach(r.points,Ee),ge.has(r,"y")&&Ee(r)}))}(e);"lr"!==n&&"rl"!==n||(!function(e){ge.forEach(e.nodes(),(function(n){ye(e.node(n))})),ge.forEach(e.edges(),(function(n){var r=e.edge(n);ge.forEach(r.points,ye),ge.has(r,"x")&&ye(r)}))}(e),me(e))}};function me(e){ge.forEach(e.nodes(),(function(n){we(e.node(n))})),ge.forEach(e.edges(),(function(n){we(e.edge(n))}))}function we(e){var n=e.width;e.width=e.height,e.height=n}function Ee(e){e.y=-e.y}function ye(e){var n=e.x;e.x=e.y,e.y=n}var be=o,_e=function(e){var n={},r=be.filter(e.nodes(),(function(n){return!e.children(n).length})),t=be.max(be.map(r,(function(n){return e.node(n).rank}))),o=be.map(be.range(t+1),(function(){return[]}));function i(r){if(!be.has(n,r)){n[r]=!0;var t=e.node(r);o[t.rank].push(r),be.forEach(e.successors(r),i)}}var a=be.sortBy(r,(function(n){return e.node(n).rank}));return be.forEach(a,i),o};var xe=o,ke=function(e,n){for(var r=0,t=1;t<n.length;++t)r+=Ne(e,n[t-1],n[t]);return r};function Ne(e,n,r){for(var t=xe.zipObject(r,xe.map(r,(function(e,n){return n}))),o=xe.flatten(xe.map(n,(function(n){return xe.sortBy(xe.map(e.outEdges(n),(function(n){return{pos:t[n.w],weight:e.edge(n).weight}})),"pos")})),!0),i=1;i<r.length;)i<<=1;var a=2*i-1;i-=1;var u=xe.map(new Array(a),(function(){return 0})),c=0;return xe.forEach(o.forEach((function(e){var n=e.pos+i;u[n]+=e.weight;for(var r=0;n>0;)n%2&&(r+=u[n+1]),u[n=n-1>>1]+=e.weight;c+=e.weight*r}))),c}var Ie=o;var qe=o;var Me=o,Te=b;function Re(e,n,r){for(var t;n.length&&(t=Me.last(n)).i<=r;)n.pop(),e.push(t.vs),r++;return r}var Le=o,Ce=function(e,n){return Ie.map(n,(function(n){var r=e.inEdges(n);if(r.length){var t=Ie.reduce(r,(function(n,r){var t=e.edge(r),o=e.node(r.v);return{sum:n.sum+t.weight*o.order,weight:n.weight+t.weight}}),{sum:0,weight:0});return{v:n,barycenter:t.sum/t.weight,weight:t.weight}}return{v:n}}))},Pe=function(e,n){var r={};return qe.forEach(e,(function(e,n){var t=r[e.v]={indegree:0,in:[],out:[],vs:[e.v],i:n};qe.isUndefined(e.barycenter)||(t.barycenter=e.barycenter,t.weight=e.weight)})),qe.forEach(n.edges(),(function(e){var n=r[e.v],t=r[e.w];qe.isUndefined(n)||qe.isUndefined(t)||(t.indegree++,n.out.push(r[e.w]))})),function(e){var n=[];function r(e){return function(n){n.merged||(qe.isUndefined(n.barycenter)||qe.isUndefined(e.barycenter)||n.barycenter>=e.barycenter)&&function(e,n){var r=0,t=0;e.weight&&(r+=e.barycenter*e.weight,t+=e.weight);n.weight&&(r+=n.barycenter*n.weight,t+=n.weight);e.vs=n.vs.concat(e.vs),e.barycenter=r/t,e.weight=t,e.i=Math.min(n.i,e.i),n.merged=!0}(e,n)}}function t(n){return function(r){r.in.push(n),0==--r.indegree&&e.push(r)}}for(;e.length;){var o=e.pop();n.push(o),qe.forEach(o.in.reverse(),r(o)),qe.forEach(o.out,t(o))}return qe.map(qe.filter(n,(function(e){return!e.merged})),(function(e){return qe.pick(e,["vs","i","barycenter","weight"])}))}(qe.filter(r,(function(e){return!e.indegree})))},Se=function(e,n){var r=Te.partition(e,(function(e){return Me.has(e,"barycenter")})),t=r.lhs,o=Me.sortBy(r.rhs,(function(e){return-e.i})),i=[],a=0,u=0,c=0;t.sort((s=!!n,function(e,n){return e.barycenter<n.barycenter?-1:e.barycenter>n.barycenter?1:s?n.i-e.i:e.i-n.i})),c=Re(i,o,c),Me.forEach(t,(function(e){c+=e.vs.length,i.push(e.vs),a+=e.barycenter*e.weight,u+=e.weight,c=Re(i,o,c)}));var s;var f={vs:Me.flatten(i,!0)};u&&(f.barycenter=a/u,f.weight=u);return f},Be=function e(n,r,t,o){var i=n.children(r),a=n.node(r),u=a?a.borderLeft:void 0,c=a?a.borderRight:void 0,s={};u&&(i=Le.filter(i,(function(e){return e!==u&&e!==c})));var f=Ce(n,i);Le.forEach(f,(function(r){if(n.children(r.v).length){var i=e(n,r.v,t,o);s[r.v]=i,Le.has(i,"barycenter")&&(a=r,u=i,Le.isUndefined(a.barycenter)?(a.barycenter=u.barycenter,a.weight=u.weight):(a.barycenter=(a.barycenter*a.weight+u.barycenter*u.weight)/(a.weight+u.weight),a.weight+=u.weight))}var a,u}));var d=Pe(f,t);!function(e,n){Le.forEach(e,(function(e){e.vs=Le.flatten(e.vs.map((function(e){return n[e]?n[e].vs:e})),!0)}))}(d,s);var h=Se(d,o);if(u&&(h.vs=Le.flatten([u,h.vs,c],!0),n.predecessors(u).length)){var l=n.node(n.predecessors(u)[0]),v=n.node(n.predecessors(c)[0]);Le.has(h,"barycenter")||(h.barycenter=0,h.weight=0),h.barycenter=(h.barycenter*h.weight+l.order+v.order)/(h.weight+2),h.weight+=2}return h};var Ge=o,je=t.Graph,Oe=function(e,n,r){var t=function(e){var n;for(;e.hasNode(n=Ge.uniqueId("_root")););return n}(e),o=new je({compound:!0}).setGraph({root:t}).setDefaultNodeLabel((function(n){return e.node(n)}));return Ge.forEach(e.nodes(),(function(i){var a=e.node(i),u=e.parent(i);(a.rank===n||a.minRank<=n&&n<=a.maxRank)&&(o.setNode(i),o.setParent(i,u||t),Ge.forEach(e[r](i),(function(n){var r=n.v===i?n.w:n.v,t=o.edge(r,i),a=Ge.isUndefined(t)?0:t.weight;o.setEdge(r,i,{weight:e.edge(n).weight+a})})),Ge.has(a,"minRank")&&o.setNode(i,{borderLeft:a.borderLeft[n],borderRight:a.borderRight[n]}))})),o};var Ae=o;var Ve=o,De=_e,Fe=ke,Ue=Be,ze=Oe,Ye=function(e,n,r){var t,o={};Ae.forEach(r,(function(r){for(var i,a,u=e.parent(r);u;){if((i=e.parent(u))?(a=o[i],o[i]=u):(a=t,t=u),a&&a!==u)return void n.setEdge(a,u);u=i}}))},We=t.Graph,Je=b,Ke=function(e){var n=Je.maxRank(e),r=He(e,Ve.range(1,n+1),"inEdges"),t=He(e,Ve.range(n-1,-1,-1),"outEdges"),o=De(e);Xe(e,o);for(var i,a=Number.POSITIVE_INFINITY,u=0,c=0;c<4;++u,++c){Qe(u%2?r:t,u%4>=2),o=Je.buildLayerMatrix(e);var s=Fe(e,o);s<a&&(c=0,i=Ve.cloneDeep(o),a=s)}Xe(e,i)};function He(e,n,r){return Ve.map(n,(function(n){return ze(e,n,r)}))}function Qe(e,n){var r=new We;Ve.forEach(e,(function(e){var t=e.graph().root,o=Ue(e,t,r,n);Ve.forEach(o.vs,(function(n,r){e.node(n).order=r})),Ye(e,r,o.vs)}))}function Xe(e,n){Ve.forEach(n,(function(n){Ve.forEach(n,(function(n,r){e.node(n).order=r}))}))}var Ze=o,$e=t.Graph,en=b,nn=function(e){var n,r=en.buildLayerMatrix(e),t=Ze.merge(rn(e,r),tn(e,r)),o={};Ze.forEach(["u","d"],(function(i){n="u"===i?r:Ze.values(r).reverse(),Ze.forEach(["l","r"],(function(r){"r"===r&&(n=Ze.map(n,(function(e){return Ze.values(e).reverse()})));var a=("u"===i?e.predecessors:e.successors).bind(e),u=un(e,n,t,a),c=cn(e,n,u.root,u.align,"r"===r);"r"===r&&(c=Ze.mapValues(c,(function(e){return-e}))),o[i+r]=c}))}));var i=sn(e,o);return fn(o,i),dn(o,e.graph().align)};function rn(e,n){var r={};return Ze.reduce(n,(function(n,t){var o=0,i=0,a=n.length,u=Ze.last(t);return Ze.forEach(t,(function(n,c){var s=function(e,n){if(e.node(n).dummy)return Ze.find(e.predecessors(n),(function(n){return e.node(n).dummy}))}(e,n),f=s?e.node(s).order:a;(s||n===u)&&(Ze.forEach(t.slice(i,c+1),(function(n){Ze.forEach(e.predecessors(n),(function(t){var i=e.node(t),a=i.order;!(a<o||f<a)||i.dummy&&e.node(n).dummy||on(r,t,n)}))})),i=c+1,o=f)})),t})),r}function tn(e,n){var r={};function t(n,t,o,i,a){var u;Ze.forEach(Ze.range(t,o),(function(t){u=n[t],e.node(u).dummy&&Ze.forEach(e.predecessors(u),(function(n){var t=e.node(n);t.dummy&&(t.order<i||t.order>a)&&on(r,n,u)}))}))}return Ze.reduce(n,(function(n,r){var o,i=-1,a=0;return Ze.forEach(r,(function(u,c){if("border"===e.node(u).dummy){var s=e.predecessors(u);s.length&&(o=e.node(s[0]).order,t(r,a,c,i,o),a=c,i=o)}t(r,a,r.length,o,n.length)})),r})),r}function on(e,n,r){if(n>r){var t=n;n=r,r=t}var o=e[n];o||(e[n]=o={}),o[r]=!0}function an(e,n,r){if(n>r){var t=n;n=r,r=t}return Ze.has(e[n],r)}function un(e,n,r,t){var o={},i={},a={};return Ze.forEach(n,(function(e){Ze.forEach(e,(function(e,n){o[e]=e,i[e]=e,a[e]=n}))})),Ze.forEach(n,(function(e){var n=-1;Ze.forEach(e,(function(e){var u=t(e);if(u.length){u=Ze.sortBy(u,(function(e){return a[e]}));for(var c=(u.length-1)/2,s=Math.floor(c),f=Math.ceil(c);s<=f;++s){var d=u[s];i[e]===e&&n<a[d]&&!an(r,e,d)&&(i[d]=e,i[e]=o[e]=o[d],n=a[d])}}}))})),{root:o,align:i}}function cn(e,n,r,t,o){var i={},a=function(e,n,r,t){var o=new $e,i=e.graph(),a=function(e,n,r){return function(t,o,i){var a,u=t.node(o),c=t.node(i),s=0;if(s+=u.width/2,Ze.has(u,"labelpos"))switch(u.labelpos.toLowerCase()){case"l":a=-u.width/2;break;case"r":a=u.width/2}if(a&&(s+=r?a:-a),a=0,s+=(u.dummy?n:e)/2,s+=(c.dummy?n:e)/2,s+=c.width/2,Ze.has(c,"labelpos"))switch(c.labelpos.toLowerCase()){case"l":a=c.width/2;break;case"r":a=-c.width/2}return a&&(s+=r?a:-a),a=0,s}}(i.nodesep,i.edgesep,t);return Ze.forEach(n,(function(n){var t;Ze.forEach(n,(function(n){var i=r[n];if(o.setNode(i),t){var u=r[t],c=o.edge(u,i);o.setEdge(u,i,Math.max(a(e,n,t),c||0))}t=n}))})),o}(e,n,r,o),u=o?"borderLeft":"borderRight";function c(e,n){for(var r=a.nodes(),t=r.pop(),o={};t;)o[t]?e(t):(o[t]=!0,r.push(t),r=r.concat(n(t))),t=r.pop()}return c((function(e){i[e]=a.inEdges(e).reduce((function(e,n){return Math.max(e,i[n.v]+a.edge(n))}),0)}),a.predecessors.bind(a)),c((function(n){var r=a.outEdges(n).reduce((function(e,n){return Math.min(e,i[n.w]-a.edge(n))}),Number.POSITIVE_INFINITY),t=e.node(n);r!==Number.POSITIVE_INFINITY&&t.borderType!==u&&(i[n]=Math.max(i[n],r))}),a.successors.bind(a)),Ze.forEach(t,(function(e){i[e]=i[r[e]]})),i}function sn(e,n){return Ze.minBy(Ze.values(n),(function(n){var r=Number.NEGATIVE_INFINITY,t=Number.POSITIVE_INFINITY;return Ze.forIn(n,(function(n,o){var i=function(e,n){return e.node(n).width}(e,o)/2;r=Math.max(n+i,r),t=Math.min(n-i,t)})),r-t}))}function fn(e,n){var r=Ze.values(n),t=Ze.min(r),o=Ze.max(r);Ze.forEach(["u","d"],(function(r){Ze.forEach(["l","r"],(function(i){var a,u=r+i,c=e[u];if(c!==n){var s=Ze.values(c);(a="l"===i?t-Ze.min(s):o-Ze.max(s))&&(e[u]=Ze.mapValues(c,(function(e){return e+a})))}}))}))}function dn(e,n){return Ze.mapValues(e.ul,(function(r,t){if(n)return e[n.toLowerCase()][t];var o=Ze.sortBy(Ze.map(e,t));return(o[1]+o[2])/2}))}var hn=o,ln=b,vn=nn;var gn=o,pn=w,mn=I,wn=re,En=b.normalizeRanks,yn=ae,bn=b.removeEmptyRanks,_n=se,xn=le,kn=pe,Nn=Ke,In=function(e){(function(e){var n=ln.buildLayerMatrix(e),r=e.graph().ranksep,t=0;hn.forEach(n,(function(n){var o=hn.max(hn.map(n,(function(n){return e.node(n).height})));hn.forEach(n,(function(n){e.node(n).y=t+o/2})),t+=o+r}))})(e=ln.asNonCompoundGraph(e)),hn.forEach(vn(e),(function(n,r){e.node(r).x=n}))},qn=b,Mn=t.Graph,Tn=function(e,n){var r=n&&n.debugTiming?qn.time:qn.notime;r("layout",(function(){var n=r("  buildLayoutGraph",(function(){return function(e){var n=new Mn({multigraph:!0,compound:!0}),r=An(e.graph());return n.setGraph(gn.merge({},Ln,On(r,Rn),gn.pick(r,Cn))),gn.forEach(e.nodes(),(function(r){var t=An(e.node(r));n.setNode(r,gn.defaults(On(t,Pn),Sn)),n.setParent(r,e.parent(r))})),gn.forEach(e.edges(),(function(r){var t=An(e.edge(r));n.setEdge(r,gn.merge({},Gn,On(t,Bn),gn.pick(t,jn)))})),n}(e)}));r("  runLayout",(function(){!function(e,n){n("    makeSpaceForEdgeLabels",(function(){!function(e){var n=e.graph();n.ranksep/=2,gn.forEach(e.edges(),(function(r){var t=e.edge(r);t.minlen*=2,"c"!==t.labelpos.toLowerCase()&&("TB"===n.rankdir||"BT"===n.rankdir?t.width+=t.labeloffset:t.height+=t.labeloffset)}))}(e)})),n("    removeSelfEdges",(function(){!function(e){gn.forEach(e.edges(),(function(n){if(n.v===n.w){var r=e.node(n.v);r.selfEdges||(r.selfEdges=[]),r.selfEdges.push({e:n,label:e.edge(n)}),e.removeEdge(n)}}))}(e)})),n("    acyclic",(function(){pn.run(e)})),n("    nestingGraph.run",(function(){_n.run(e)})),n("    rank",(function(){wn(qn.asNonCompoundGraph(e))})),n("    injectEdgeLabelProxies",(function(){!function(e){gn.forEach(e.edges(),(function(n){var r=e.edge(n);if(r.width&&r.height){var t=e.node(n.v),o={rank:(e.node(n.w).rank-t.rank)/2+t.rank,e:n};qn.addDummyNode(e,"edge-proxy",o,"_ep")}}))}(e)})),n("    removeEmptyRanks",(function(){bn(e)})),n("    nestingGraph.cleanup",(function(){_n.cleanup(e)})),n("    normalizeRanks",(function(){En(e)})),n("    assignRankMinMax",(function(){!function(e){var n=0;gn.forEach(e.nodes(),(function(r){var t=e.node(r);t.borderTop&&(t.minRank=e.node(t.borderTop).rank,t.maxRank=e.node(t.borderBottom).rank,n=gn.max(n,t.maxRank))})),e.graph().maxRank=n}(e)})),n("    removeEdgeLabelProxies",(function(){!function(e){gn.forEach(e.nodes(),(function(n){var r=e.node(n);"edge-proxy"===r.dummy&&(e.edge(r.e).labelRank=r.rank,e.removeNode(n))}))}(e)})),n("    normalize.run",(function(){mn.run(e)})),n("    parentDummyChains",(function(){yn(e)})),n("    addBorderSegments",(function(){xn(e)})),n("    order",(function(){Nn(e)})),n("    insertSelfEdges",(function(){!function(e){var n=qn.buildLayerMatrix(e);gn.forEach(n,(function(n){var r=0;gn.forEach(n,(function(n,t){var o=e.node(n);o.order=t+r,gn.forEach(o.selfEdges,(function(n){qn.addDummyNode(e,"selfedge",{width:n.label.width,height:n.label.height,rank:o.rank,order:t+ ++r,e:n.e,label:n.label},"_se")})),delete o.selfEdges}))}))}(e)})),n("    adjustCoordinateSystem",(function(){kn.adjust(e)})),n("    position",(function(){In(e)})),n("    positionSelfEdges",(function(){!function(e){gn.forEach(e.nodes(),(function(n){var r=e.node(n);if("selfedge"===r.dummy){var t=e.node(r.e.v),o=t.x+t.width/2,i=t.y,a=r.x-o,u=t.height/2;e.setEdge(r.e,r.label),e.removeNode(n),r.label.points=[{x:o+2*a/3,y:i-u},{x:o+5*a/6,y:i-u},{x:o+a,y:i},{x:o+5*a/6,y:i+u},{x:o+2*a/3,y:i+u}],r.label.x=r.x,r.label.y=r.y}}))}(e)})),n("    removeBorderNodes",(function(){!function(e){gn.forEach(e.nodes(),(function(n){if(e.children(n).length){var r=e.node(n),t=e.node(r.borderTop),o=e.node(r.borderBottom),i=e.node(gn.last(r.borderLeft)),a=e.node(gn.last(r.borderRight));r.width=Math.abs(a.x-i.x),r.height=Math.abs(o.y-t.y),r.x=i.x+r.width/2,r.y=t.y+r.height/2}})),gn.forEach(e.nodes(),(function(n){"border"===e.node(n).dummy&&e.removeNode(n)}))}(e)})),n("    normalize.undo",(function(){mn.undo(e)})),n("    fixupEdgeLabelCoords",(function(){!function(e){gn.forEach(e.edges(),(function(n){var r=e.edge(n);if(gn.has(r,"x"))switch("l"!==r.labelpos&&"r"!==r.labelpos||(r.width-=r.labeloffset),r.labelpos){case"l":r.x-=r.width/2+r.labeloffset;break;case"r":r.x+=r.width/2+r.labeloffset}}))}(e)})),n("    undoCoordinateSystem",(function(){kn.undo(e)})),n("    translateGraph",(function(){!function(e){var n=Number.POSITIVE_INFINITY,r=0,t=Number.POSITIVE_INFINITY,o=0,i=e.graph(),a=i.marginx||0,u=i.marginy||0;function c(e){var i=e.x,a=e.y,u=e.width,c=e.height;n=Math.min(n,i-u/2),r=Math.max(r,i+u/2),t=Math.min(t,a-c/2),o=Math.max(o,a+c/2)}gn.forEach(e.nodes(),(function(n){c(e.node(n))})),gn.forEach(e.edges(),(function(n){var r=e.edge(n);gn.has(r,"x")&&c(r)})),n-=a,t-=u,gn.forEach(e.nodes(),(function(r){var o=e.node(r);o.x-=n,o.y-=t})),gn.forEach(e.edges(),(function(r){var o=e.edge(r);gn.forEach(o.points,(function(e){e.x-=n,e.y-=t})),gn.has(o,"x")&&(o.x-=n),gn.has(o,"y")&&(o.y-=t)})),i.width=r-n+a,i.height=o-t+u}(e)})),n("    assignNodeIntersects",(function(){!function(e){gn.forEach(e.edges(),(function(n){var r,t,o=e.edge(n),i=e.node(n.v),a=e.node(n.w);o.points?(r=o.points[0],t=o.points[o.points.length-1]):(o.points=[],r=a,t=i),o.points.unshift(qn.intersectRect(i,r)),o.points.push(qn.intersectRect(a,t))}))}(e)})),n("    reversePoints",(function(){!function(e){gn.forEach(e.edges(),(function(n){var r=e.edge(n);r.reversed&&r.points.reverse()}))}(e)})),n("    acyclic.undo",(function(){pn.undo(e)}))}(n,r)})),r("  updateInputGraph",(function(){!function(e,n){gn.forEach(e.nodes(),(function(r){var t=e.node(r),o=n.node(r);t&&(t.x=o.x,t.y=o.y,n.children(r).length&&(t.width=o.width,t.height=o.height))})),gn.forEach(e.edges(),(function(r){var t=e.edge(r),o=n.edge(r);t.points=o.points,gn.has(o,"x")&&(t.x=o.x,t.y=o.y)})),e.graph().width=n.graph().width,e.graph().height=n.graph().height}(e,n)}))}))};var Rn=["nodesep","edgesep","ranksep","marginx","marginy"],Ln={ranksep:50,edgesep:20,nodesep:50,rankdir:"tb"},Cn=["acyclicer","ranker","rankdir","align"],Pn=["width","height"],Sn={width:0,height:0},Bn=["minlen","weight","width","height","labeloffset"],Gn={minlen:1,weight:1,width:0,height:0,labeloffset:10,labelpos:"r"},jn=["labelpos"];function On(e,n){return gn.mapValues(gn.pick(e,n),Number)}function An(e){var n={};return gn.forEach(e,(function(e,r){n[r.toLowerCase()]=e})),n}var Vn=o,Dn=b,Fn=t.Graph;var Un={graphlib:t,layout:Tn,debug:{debugOrdering:function(e){var n=Dn.buildLayerMatrix(e),r=new Fn({compound:!0,multigraph:!0}).setGraph({});return Vn.forEach(e.nodes(),(function(n){r.setNode(n,{label:n}),r.setParent(n,"layer"+e.node(n).rank)})),Vn.forEach(e.edges(),(function(e){r.setEdge(e.v,e.w,{},e.name)})),Vn.forEach(n,(function(e,n){var t="layer"+n;r.setNode(t,{rank:"same"}),Vn.reduce(e,(function(e,n){return r.setEdge(e,n,{style:"invis"}),n}))})),r}},util:{time:b.time,notime:b.notime},version:"0.8.5"},zn={exports:{}};function Yn(e,n){var r=e.subgraphs,t=e.nodes,o=e.links,i=e.hierarchy,a=new Un.graphlib.Graph({multigraph:!0,compound:!0,directed:!1!==n.digraph}).setGraph(n).setDefaultNodeLabel((function(){return{}})).setDefaultEdgeLabel((function(){return{}}));r.forEach((function(e){a.setNode(e.id,e)})),t.forEach((function(e){a.setNode(e.id,e)})),o.forEach((function(e){a.setEdge(e.source.id,e.target.id,e,e.id)})),i.forEach((function(e){a.setParent(e.child,e.parent)})),Un.layout(a,{debugTiming:!1});var u=-a.graph().width/2||0,c=-a.graph().height/2;return a.nodes().forEach((function(e){var n=a.node(e);n.x+=u,n.y+=c})),a.edges().forEach((function(e){var n=a.edge(e);n.points=n.points.map((function(e){return[e.x+u,e.y+c]}))})),{subgraphs:r,nodes:t,links:o}}zn.exports=function(){function e(e){var n=typeof e;return null!==e&&("object"===n||"function"===n)}function r(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},o=0,i=void 0,a=void 0,u=function(e,n){y[o]=e,y[o+1]=n,2===(o+=2)&&(a?a(b):x())};function c(e){a=e}function s(e){u=e}var f="undefined"!=typeof window?window:void 0,d=f||{},h=d.MutationObserver||d.WebKitMutationObserver,l="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),v="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function g(){return function(){return process.nextTick(b)}}function p(){return void 0!==i?function(){i(b)}:E()}function m(){var e=0,n=new h(b),r=document.createTextNode("");return n.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}function w(){var e=new MessageChannel;return e.port1.onmessage=b,function(){return e.port2.postMessage(0)}}function E(){var e=setTimeout;return function(){return e(b,1)}}var y=new Array(1e3);function b(){for(var e=0;e<o;e+=2)(0,y[e])(y[e+1]),y[e]=void 0,y[e+1]=void 0;o=0}function _(){try{var e=Function("return this")().require("vertx");return i=e.runOnLoop||e.runOnContext,p()}catch(e){return E()}}var x=void 0;function k(e,n){var r=this,t=new this.constructor(q);void 0===t[I]&&J(t);var o=r._state;if(o){var i=arguments[o-1];u((function(){return U(o,t,i,r._result)}))}else D(r,t,e,n);return t}function N(e){var n=this;if(e&&"object"==typeof e&&e.constructor===n)return e;var r=new n(q);return j(r,e),r}x=l?g():h?m():v?w():void 0===f?_():E();var I=Math.random().toString(36).substring(2);function q(){}var M=void 0,T=1,R=2;function L(){return new TypeError("You cannot resolve a promise with itself")}function C(){return new TypeError("A promises callback cannot return that same promise.")}function P(e,n,r,t){try{e.call(n,r,t)}catch(e){return e}}function S(e,n,r){u((function(e){var t=!1,o=P(r,n,(function(r){t||(t=!0,n!==r?j(e,r):A(e,r))}),(function(n){t||(t=!0,V(e,n))}),"Settle: "+(e._label||" unknown promise"));!t&&o&&(t=!0,V(e,o))}),e)}function B(e,n){n._state===T?A(e,n._result):n._state===R?V(e,n._result):D(n,void 0,(function(n){return j(e,n)}),(function(n){return V(e,n)}))}function G(e,n,t){n.constructor===e.constructor&&t===k&&n.constructor.resolve===N?B(e,n):void 0===t?A(e,n):r(t)?S(e,n,t):A(e,n)}function j(n,r){if(n===r)V(n,L());else if(e(r)){var t=void 0;try{t=r.then}catch(e){return void V(n,e)}G(n,r,t)}else A(n,r)}function O(e){e._onerror&&e._onerror(e._result),F(e)}function A(e,n){e._state===M&&(e._result=n,e._state=T,0!==e._subscribers.length&&u(F,e))}function V(e,n){e._state===M&&(e._state=R,e._result=n,u(O,e))}function D(e,n,r,t){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=n,o[i+T]=r,o[i+R]=t,0===i&&e._state&&u(F,e)}function F(e){var n=e._subscribers,r=e._state;if(0!==n.length){for(var t=void 0,o=void 0,i=e._result,a=0;a<n.length;a+=3)t=n[a],o=n[a+r],t?U(r,t,o,i):o(i);e._subscribers.length=0}}function U(e,n,t,o){var i=r(t),a=void 0,u=void 0,c=!0;if(i){try{a=t(o)}catch(e){c=!1,u=e}if(n===a)return void V(n,C())}else a=o;n._state!==M||(i&&c?j(n,a):!1===c?V(n,u):e===T?A(n,a):e===R&&V(n,a))}function z(e,n){try{n((function(n){j(e,n)}),(function(n){V(e,n)}))}catch(n){V(e,n)}}var Y=0;function W(){return Y++}function J(e){e[I]=Y++,e._state=void 0,e._result=void 0,e._subscribers=[]}function K(){return new Error("Array Methods must be provided an Array")}var H=function(){function e(e,n){this._instanceConstructor=e,this.promise=new e(q),this.promise[I]||J(this.promise),t(n)?(this.length=n.length,this._remaining=n.length,this._result=new Array(this.length),0===this.length?A(this.promise,this._result):(this.length=this.length||0,this._enumerate(n),0===this._remaining&&A(this.promise,this._result))):V(this.promise,K())}return e.prototype._enumerate=function(e){for(var n=0;this._state===M&&n<e.length;n++)this._eachEntry(e[n],n)},e.prototype._eachEntry=function(e,n){var r=this._instanceConstructor,t=r.resolve;if(t===N){var o=void 0,i=void 0,a=!1;try{o=e.then}catch(e){a=!0,i=e}if(o===k&&e._state!==M)this._settledAt(e._state,n,e._result);else if("function"!=typeof o)this._remaining--,this._result[n]=e;else if(r===ne){var u=new r(q);a?V(u,i):G(u,e,o),this._willSettleAt(u,n)}else this._willSettleAt(new r((function(n){return n(e)})),n)}else this._willSettleAt(t(e),n)},e.prototype._settledAt=function(e,n,r){var t=this.promise;t._state===M&&(this._remaining--,e===R?V(t,r):this._result[n]=r),0===this._remaining&&A(t,this._result)},e.prototype._willSettleAt=function(e,n){var r=this;D(e,void 0,(function(e){return r._settledAt(T,n,e)}),(function(e){return r._settledAt(R,n,e)}))},e}();function Q(e){return new H(this,e).promise}function X(e){var n=this;return t(e)?new n((function(r,t){for(var o=e.length,i=0;i<o;i++)n.resolve(e[i]).then(r,t)})):new n((function(e,n){return n(new TypeError("You must pass an array to race."))}))}function Z(e){var n=new this(q);return V(n,e),n}function $(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function ee(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}var ne=function(){function e(n){this[I]=W(),this._result=this._state=void 0,this._subscribers=[],q!==n&&("function"!=typeof n&&$(),this instanceof e?z(this,n):ee())}return e.prototype.catch=function(e){return this.then(null,e)},e.prototype.finally=function(e){var n=this,t=n.constructor;return r(e)?n.then((function(n){return t.resolve(e()).then((function(){return n}))}),(function(n){return t.resolve(e()).then((function(){throw n}))})):n.then(e,e)},e}();function re(){var e=void 0;if(void 0!==n)e=n;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var r=e.Promise;if(r){var t=null;try{t=Object.prototype.toString.call(r.resolve())}catch(e){}if("[object Promise]"===t&&!r.cast)return}e.Promise=ne}return ne.prototype.then=k,ne.all=Q,ne.race=X,ne.resolve=N,ne.reject=Z,ne._setScheduler=c,ne._setAsap=s,ne._asap=u,ne.polyfill=re,ne.Promise=ne,ne}(),zn.exports.polyfill(),self.onmessage=function(e){var n=Yn.apply(void 0,e.data);self.postMessage(n)}}();`;

    const workerBlob = new Blob([workerCode], { type: "application/javascript" });
    const workerUrl = URL.createObjectURL(workerBlob);
    const worker = new Worker(workerUrl);
    const response = new Promise<string>(resolve => {
        worker.onmessage = event => {
            resolve(event.data);
            worker.terminate();
            URL.revokeObjectURL(workerUrl);
        };
        worker.postMessage([data, options]);
    });
    return {
        terminate: () => worker.terminate(),
        response
    };
}
