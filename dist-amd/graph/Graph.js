!function(e,t){"function"==typeof define&&define.amd?define(["d3","../common/SVGWidget","../common/Palette","../api/IGraph","./Vertex","./Edge","./GraphData","./GraphLayouts","../common/Utility","css!./Graph"],t):e.graph_Graph=t(e.d3,e.common_SVGWidget,e.common_Palette,e.api_IGraph,e.graph_Vertex,e.graph_Edge,e.graph_GraphData,e.graph_GraphLayouts,e.common_Utility)}(this,function(e,t,i,r,o,a,s,n,h){function c(){t.call(this),r.call(this),this.graphData=new s,this.highlight={zoom:1.1,opacity:.33,edge:"1.25px"},this._selection=new h.Selection}return c.prototype=Object.create(t.prototype),c.prototype.constructor=c,c.prototype._class+=" graph_Graph",c.prototype["implements"](r.prototype),c.prototype.Vertex=o,c.prototype.Edge=a,c.prototype.publish("allowDragging",!0,"boolean","Allow Dragging of Vertices",null,{tags:["Advanced"]}),c.prototype.publish("layout","Circle","set","Default Layout",["Circle","ForceDirected","ForceDirected2","Hierarchy","None"],{tags:["Basic"]}),c.prototype.publish("scale","100%","set","Zoom Level",["all","width","selection","100%","90%","75%","50%","25%","10%"],{tags:["Basic"]}),c.prototype.publish("applyScaleOnLayout",!1,"boolean","Shrink to fit on Layout",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverVertex",!1,"boolean","Highlight Vertex on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("highlightOnMouseOverEdge",!1,"boolean","Highlight Edge on Mouse Over",null,{tags:["Basic"]}),c.prototype.publish("transitionDuration",250,"number","Transition Duration",null,{tags:["Intermediate"]}),c.prototype.publish("showEdges",!0,"boolean","Show Edges",null,{tags:["Intermediate"]}),c.prototype.publish("snapToGrid",0,"number","Snap to Grid",null,{tags:["Private"]}),c.prototype.publish("hierarchyRankDirection","TB","set","Direction for Rank Nodes",["TB","BT","LR","RL"],{tags:["Advanced"]}),c.prototype.publish("hierarchyNodeSeparation",50,"number","Number of pixels that separate nodes horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyEdgeSeparation",10,"number","Number of pixels that separate edges horizontally in the layout",null,{tags:["Advanced"]}),c.prototype.publish("hierarchyRankSeparation",50,"number","Number of pixels between each rank in the layout",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkDistance",300,"number","Target distance between linked nodes",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedLinkStrength",1,"number","Strength (rigidity) of links",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedFriction",.9,"number","Friction coefficient",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedCharge",-25,"number","Charge strength ",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedChargeDistance",1e4,"number","Maximum distance over which charge forces are applied",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedTheta",.8,"number","Barnesâ€“Hut approximation criterion",null,{tags:["Advanced"]}),c.prototype.publish("forceDirectedGravity",.1,"number","Gravitational strength",null,{tags:["Advanced"]}),c.prototype.getOffsetPos=function(){return{x:0,y:0}},c.prototype.size=function(e){var i=t.prototype.size.apply(this,arguments);return arguments.length&&this._svgZoom&&this._svgZoom.attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),i},c.prototype.clear=function(){this.data({vertices:[],edges:[],hierarchy:[],merge:!1})},c.prototype.data=function(e){var i=t.prototype.data.apply(this,arguments);if(arguments.length){this.data().merge||(this.graphData=new s,this._renderCount=0);var r=this.graphData.setData(this.data().vertices||[],this.data().edges||[],this.data().hierarchy||[],this.data().merge||!1),o=this;r.addedVertices.forEach(function(e){e.pos({x:10*+Math.random()/2-5,y:10*+Math.random()/2-5})}),r.addedEdges.forEach(function(e){e._graphID=o._id});var a={};this.graphData.edgeValues().forEach(function(e){a[e._sourceVertex._id]||(a[e._sourceVertex._id]={}),a[e._sourceVertex._id][e._targetVertex._id]||(a[e._sourceVertex._id][e._targetVertex._id]=0);var t=++a[e._sourceVertex._id][e._targetVertex._id];e.arcDepth(16*t)})}return i},c.prototype.selection=function(e){return arguments.length?(this._selection.set(e),this):this._selection.get()},c.prototype.setZoom=function(e,t,i){this.zoom&&(this.zoom.translate(e),this.zoom.scale(t),this.applyZoom(i))},c.prototype.applyZoom=function(t){e.event&&e.event.sourceEvent&&e.event.sourceEvent.ctrlKey&&("wheel"===e.event.sourceEvent.type||"mousewheel"===e.event.sourceEvent.type||"DOMMouseScroll"===e.event.sourceEvent.type)&&e.event.sourceEvent.wheelDelta&&(this.zoom.translate([this.prevTranslate[0],this.prevTranslate[1]+e.event.sourceEvent.wheelDelta]),this.zoom.scale(this.prevScale)),(t?this.svg.transition().duration(t):this.svg).attr("transform","translate("+this.zoom.translate()+")scale("+this.zoom.scale()+")"),this.prevTranslate=this.zoom.translate(),this.prevScale!==this.zoom.scale()&&(this._fixIEMarkers(),this.prevScale=this.zoom.scale()),this.brush.x(e.scale.identity().domain([1*(-this.prevTranslate[0]-this._size.width/2)/this.zoom.scale(),1*(-this.prevTranslate[0]+this._size.width/2)/this.zoom.scale()])),this.brush.y(e.scale.identity().domain([1*(-this.prevTranslate[1]-this._size.height/2)/this.zoom.scale(),1*(-this.prevTranslate[1]+this._size.height/2)/this.zoom.scale()]))},c.prototype.enter=function(i,r){function o(t){if(n.allowDragging()){if(e.event.sourceEvent.stopPropagation(),n._dragging=!0,n.forceLayout){var i=n.forceLayout.vertexMap[t.id()];i.fixed=!0}n.svgMarkerGlitch&&n.graphData.nodeEdges(t.id()).forEach(function(e){var t=n.graphData.edge(e);n._pushMarkers(t.element(),t)})}}function a(t){if(n.allowDragging()){if(e.event.sourceEvent.stopPropagation(),t.move({x:e.event.x,y:e.event.y}),n.forceLayout){var i=n.forceLayout.vertexMap[t.id()];i.fixed=!0,i.x=i.px=e.event.x,i.y=i.py=e.event.y}n.refreshIncidentEdges(t,!0)}}function s(t){if(n.allowDragging()){if(e.event.sourceEvent.stopPropagation(),n._dragging=!1,n.snapToGrid()){var i=t.calcSnap(n.snapToGrid());t.move(i[0]),n.refreshIncidentEdges(t,!0)}if(n.forceLayout){var r=n.forceLayout.vertexMap[t.id()];r.fixed=!1}n.svgMarkerGlitch&&n.graphData.nodeEdges(t.id()).forEach(function(e){var t=n.graphData.edge(e);n._popMarkers(t.element(),t)})}}t.prototype.enter.apply(this,arguments);var n=this;this.prevTranslate=[0,0],this.prevScale=1,this.zoom=e.behavior.zoom().scaleExtent([.01,4]).on("zoomstart",function(t){switch(n.prevTranslate=n.zoom.translate(),n.prevScale=n.zoom.scale(),e.event.sourceEvent&&e.event.sourceEvent.shiftKey&&e.event.sourceEvent.ctrlKey?n._zoomMode="selection":e.event.sourceEvent&&e.event.sourceEvent.shiftKey?(n._zoomMode="selection",n._selection.clear()):n._zoomMode="zoom",n._zoomMode){case"selection":r.select(".extent").style("visibility",null);break;default:r.select(".extent").style("visibility","hidden")}}).on("zoomend",function(e){switch(n._zoomMode){case"selection":n.zoom.translate(n.prevTranslate),n.zoom.scale(n.prevScale)}n._svgBrush.call(n.brush.clear())}).on("zoom",function(e){switch(n._zoomMode){case"selection":break;default:n.applyZoom()}}),this.brush=e.svg.brush().x(e.scale.identity().domain([-n._size.width/2,n._size.width/2])).y(e.scale.identity().domain([-n._size.height/2,n._size.height/2])).on("brushstart",function(e){switch(n._zoomMode){case"selection":}}).on("brushend",function(t){switch(n._zoomMode){case"selection":var i=e.event.target.extent();n.svgV.selectAll(".graphVertex").select("*").each(function(e){i[0][0]<=e.x()&&e.x()<i[1][0]&&i[0][1]<=e.y()&&e.y()<i[1][1]&&n._selection.append(e)}),n.graph_selection(n.selection())}}).on("brush",function(){switch(n._zoomMode){case"selection":var t=n.zoom.translate();console.log(t[0]);var i=e.event.target.extent();n.svgV.selectAll(".graphVertex").select("*").classed("selected",function(e){return n._selection.isSelected(e)||i[0][0]<=e.x()&&e.x()<i[1][0]&&i[0][1]<=e.y()&&e.y()<i[1][1]})}}),this.drag=e.behavior.drag().origin(function(e){return e.pos()}).on("dragstart",o).on("dragend",s).on("drag",a),this._svgZoom=r.append("rect").attr("class","zoom").attr("x",-this._size.width/2).attr("y",-this._size.height/2).attr("width",this._size.width).attr("height",this._size.height),this.defs=r.append("defs"),this.addMarkers(),r.call(this.zoom),this.svg=r.append("g"),this._svgBrush=this.svg.append("g").attr("class","selectionBrush").call(this.brush),this._svgBrush.select(".background").style("cursor",null),n._svgBrush.call(n.brush.clear()),this.svgC=this.svg.append("g").attr("id",this._id+"C"),this.svgE=this.svg.append("g").attr("id",this._id+"E"),this.svgV=this.svg.append("g").attr("id",this._id+"V")},c.prototype.getBounds=function(e,t){var i=[[null,null],[null,null]];return e.forEach(function(e){var r=t?t.nodePos(e._id):{x:e.x(),y:e.y(),width:e.width(),height:e.height()};if(r){var o=r.x-r.width/2,a=r.x+r.width/2,s=r.y-r.height/2,n=r.y+r.height/2;(null===i[0][0]||i[0][0]>o)&&(i[0][0]=o),(null===i[0][1]||i[0][1]>s)&&(i[0][1]=s),(null===i[1][0]||i[1][0]<a)&&(i[1][0]=a),(null===i[1][1]||i[1][1]<n)&&(i[1][1]=n)}}),i},c.prototype.getVertexBounds=function(e){return this.getBounds(this.graphData.nodeValues(),e)},c.prototype.getSelectionBounds=function(e){return this.getBounds(this._selection.get(),e)},c.prototype.shrinkToFit=function(e,t){var i=this.width(),r=this.height(),o=e[1][0]-e[0][0],a=e[1][1]-e[0][1],s=(e[0][0]+e[1][0])/2,n=(e[0][1]+e[1][1])/2,h=1/Math.max(o/i,a/r);h>1&&(h=1);var c=[-h*s,-h*n];this.setZoom(c,h,t)},c.prototype._origScale=c.prototype.scale,c.prototype.scale=function(e,t){var i=c.prototype._origScale.apply(this,arguments);return arguments.length&&this.zoomTo(e,t),i},c.prototype.zoomTo=function(e,t){switch(e){case"all":this.shrinkToFit(this.getVertexBounds(),t);break;case"width":var i=this.getVertexBounds();i[0][1]=0,i[1][1]=0,this.shrinkToFit(i,t);break;case"selection":this.shrinkToFit(this._selection.isEmpty()?this.getVertexBounds():this.getSelectionBounds(),t);break;default:var r=parseInt(e);(isNaN(r)||0>=r||r>200)&&(r=100),this.zoom.scale(r/100),this.applyZoom(t)}},c.prototype.centerOn=function(e,t){var i=(e[0][0]+e[1][0])/2,r=(e[0][1]+e[1][1])/2,o=[i,r];this.setZoom(o,1,t)},c.prototype._origLayout=c.prototype.layout,c.prototype.layout=function(e,t){var i=c.prototype._origLayout.apply(this,arguments);if(arguments.length&&this._renderCount){this.forceLayout&&(this.forceLayout.force.stop(),this.forceLayout=null);var r=this,o=this.getLayoutEngine();if("ForceDirected2"===this.layout())this.forceLayout=o,this.forceLayout.force.on("tick",function(e){if(o.vertices.forEach(function(e){if(e.fixed)e.x=e.px,e.y=e.py;else{e.px=e.x,e.py=e.y;var t=r.graphData.node(e.id);t&&t.move({x:e.x,y:e.y})}}),r.graphData.edgeValues().forEach(function(e){e.points([],!1,!1)}),r.applyScaleOnLayout()){var t=r.getVertexBounds(o);r.shrinkToFit(t)}}),this.forceLayout.force.start();else if(o){if(this.forceLayout=null,r._dragging=!0,r.graphData.nodeValues().forEach(function(e){var i=o.nodePos(e._id);e.move({x:i.x,y:i.y},t),i.width&&i.height&&!e.width()&&!e.height()&&e.width(i.width).height(i.height).render()}),r.graphData.edgeValues().forEach(function(e){var i=o.edgePoints(e);e.points(i,t)}),r.applyScaleOnLayout()){var a=r.getVertexBounds(o);r.shrinkToFit(a,t)}this._fixIEMarkers(),setTimeout(function(){r._dragging=!1},t?t+50:50)}}return i},c.prototype.update=function(i,r){function o(e){e.target(this).render(),e.element().call(h.drag),e.dispatch&&(e.dispatch.on("sizestart",function(e,t){e.allowResize(h.allowDragging()),h.allowDragging()&&(h._dragging=!0)}),e.dispatch.on("size",function(e,t){h.refreshIncidentEdges(e,!1)}),e.dispatch.on("sizeend",function(e,t){if(h._dragging=!1,h.snapToGrid()){var i=e.calcSnap(h.snapToGrid());e.pos(i[0]).size(i[1]).render(),h.refreshIncidentEdges(e,!1)}}))}function a(e){e.target(this).render()}function s(e){e.render()}function n(e){e.render()}t.prototype.update.apply(this,arguments);var h=this,c=this.svgV.selectAll("#"+this._id+"V > .graphVertex").data(this.graphData.nodeValues(),function(e){return e.id()});c.enter().append("g").attr("class","graphVertex").style("opacity",1e-6).on("click.selectionBag",function(t){h._selection.click(t,e.event)}).on("click",function(t){var i=e.select(this).select(".graph_Vertex"),r=!1;i.empty()||(r=i.classed("selected")),h.vertex_click(h.rowToObj(t.data()),"",r,{vertex:t})}).on("dblclick",function(t){var i=e.select(this).select(".graph_Vertex"),r=!1;i.empty()||(r=i.classed("selected")),h.vertex_dblclick(h.rowToObj(t.data()),"",r,{vertex:t})}).on("mouseover",function(t){h._dragging||h.vertex_mouseover(e.select(this),t)}).on("mouseout",function(t){h._dragging||h.vertex_mouseout(e.select(this),t)}).each(o).transition().duration(750).style("opacity",1);var l=this.svgE.selectAll("#"+this._id+"E > .graphEdge").data(this.showEdges()?this.graphData.edgeValues():[],function(e){return e.id()});l.enter().append("g").attr("class","graphEdge").style("opacity",1e-6).on("click.selectionBag",function(t){h._selection.click(t,e.event)}).on("click",function(t){var i=e.select(this).select(".graph_Edge"),r=!1;i.empty()||(r=i.classed("selected")),h.edge_click(h.rowToObj(t.data()),"",r,{edge:t})}).on("dblclick",function(t){var i=e.select(this).select(".graph_Edge"),r=!1;i.empty()||(r=i.classed("selected")),h.edge_dblclick(h.rowToObj(t.data()),"",r,{edge:t})}).on("mouseover",function(t){h._dragging||h.edge_mouseover(e.select(this),t)}).on("mouseout",function(t){h._dragging||h.edge_mouseout(e.select(this),t)}).each(a).transition().duration(750).style("opacity",1),c.each(s),l.each(n),c.exit().each(function(e){e.target(null)}).remove(),l.exit().each(function(e){e.target(null)}).remove(),this._renderCount||(this._renderCount++,this.setZoom([0,0],1),this.layout(this.layout()))},c.prototype.getLayoutEngine=function(){switch(this.layout()){case"Circle":return new n.Circle(this.graphData,this._size.width,this._size.height);case"ForceDirected":return new n.ForceDirected(this.graphData,this._size.width,this._size.height,{oneShot:!0,linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"ForceDirected2":return new n.ForceDirected(this.graphData,this._size.width,this._size.height,{linkDistance:this.forceDirectedLinkDistance(),linkStrength:this.forceDirectedLinkStrength(),friction:this.forceDirectedFriction(),charge:this.forceDirectedCharge(),chargeDistance:this.forceDirectedChargeDistance(),theta:this.forceDirectedTheta(),gravity:this.forceDirectedGravity()});case"Hierarchy":return new n.Hierarchy(this.graphData,this._size.width,this._size.height,{rankdir:this.hierarchyRankDirection(),nodesep:this.hierarchyNodeSeparation(),edgesep:this.hierarchyEdgeSeparation(),ranksep:this.hierarchyRankSeparation()})}return null},c.prototype.getNeighborMap=function(e){var t={},i={};if(e)for(var r=this.graphData.nodeEdges(e.id()),o=0;o<r.length;++o){var a=this.graphData.edge(r[o]);i[a.id()]=a,a._sourceVertex.id()!==e.id()&&(t[a._sourceVertex.id()]=a._sourceVertex),a._targetVertex.id()!==e.id()&&(t[a._targetVertex.id()]=a._targetVertex)}return{vertices:t,edges:i}},c.prototype.highlightVerticies=function(e){var t=this,i=this.svgV.selectAll(".graphVertex");return i.classed("graphVertex-highlighted",function(t){return!e||e[t.id()]}).transition().duration(this.transitionDuration()).each("end",function(t){e&&e[t.id()]&&t._parentElement.node()&&t._parentElement.node().parentNode&&t._parentElement.node().parentNode.appendChild(t._parentElement.node())}).style("opacity",function(i){return!e||e[i.id()]?1:t.highlight.opacity}),this},c.prototype.highlightEdges=function(e){var t=this,i=this.svgE.selectAll(".graphEdge");return i.classed("graphEdge-highlighted",function(t){return!e||e[t.id()]}).style("stroke-width",function(i){return e&&e[i.id()]?t.highlight.edge:"1px"}).transition().duration(this.transitionDuration()).style("opacity",function(i){return!e||e[i.id()]?1:t.highlight.opacity}),this},c.prototype.highlightVertex=function(e,t){if(this.highlightOnMouseOverVertex())if(t){var i=this.getNeighborMap(t);i.vertices[t.id()]=t,this.highlightVerticies(i.vertices),this.highlightEdges(i.edges)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.highlightEdge=function(e,t){if(this.highlightOnMouseOverEdge())if(t){var i={};i[t._sourceVertex.id()]=t._sourceVertex,i[t._targetVertex.id()]=t._targetVertex;var r={};r[t.id()]=t,this.highlightVerticies(i),this.highlightEdges(r)}else this.highlightVerticies(null),this.highlightEdges(null)},c.prototype.refreshIncidentEdges=function(e,t){var i=this;this.graphData.nodeEdges(e.id()).forEach(function(e){var r=i.graphData.edge(e);r.points([],!1,t)})},c.prototype.graph_selection=function(e){},c.prototype.vertex_click=function(e,t,i,o){o&&o.vertex&&o.vertex._parentElement.node().parentNode.appendChild(o.vertex._parentElement.node()),r.prototype.vertex_click.apply(this,arguments)},c.prototype.vertex_dblclick=function(e,t,i,r){},c.prototype.vertex_mouseover=function(e,t){this.highlightVertex(e,t)},c.prototype.vertex_mouseout=function(e,t){this.highlightVertex(null,null)},c.prototype.edge_mouseover=function(e,t){this.highlightEdge(e,t)},c.prototype.edge_mouseout=function(e,t){this.highlightEdge(null,null)},c.prototype.addMarkers=function(e){e&&(this.defs.select("#"+this._id+"_arrowHead").remove(),this.defs.select("#"+this._id+"_circleFoot").remove(),this.defs.select("#"+this._id+"_circleHead").remove()),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_arrowHead").attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",8).attr("markerHeight",8).attr("markerUnits","strokeWidth").attr("orient","auto").append("polyline").attr("points","0,0 10,5 0,10 1,5"),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleFoot").attr("viewBox","0 0 10 10").attr("refX",1).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4),this.defs.append("marker").attr("class","marker").attr("id",this._id+"_circleHead").attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerWidth",7).attr("markerHeight",7).attr("markerUnits","strokeWidth").attr("orient","auto").append("circle").attr("cx",5).attr("cy",5).attr("r",4)},c});