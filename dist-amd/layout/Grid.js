!function(t,e){"function"==typeof define&&define.amd?define(["d3","grid-list","../common/HTMLWidget","./Cell","../common/TextBox","../common/Utility","css!./Grid"],e):t.layout_Grid=e(t.d3,t.GridList,t.common_HTMLWidget,t.layout_Cell,t.common_TextBox,t.common_Utility)}(this,function(t,e,i,n,r,o){function l(){i.call(this),this._tag="div",this._selectionBag=new o.Selection,this.content([])}return l.prototype=Object.create(i.prototype),l.prototype.constructor=l,l.prototype._class+=" layout_Grid",l.prototype.publish("designMode",!1,"boolean","Design Mode",null,{tags:["Basic"]}),l.prototype.publish("fitTo","all","set","Sizing Strategy",["all","width"],{tags:["Basic"]}),l.prototype.publish("snapping","vertical","set","Snapping Strategy",["vertical","horizontal"]),l.prototype.publish("snappingLanes",12,"number","Snapping Lanes"),l.prototype.publish("gutter",6,"number","Gap Between Widgets",null,{tags:["Basic"]}),l.prototype.publish("surfaceShadow",!0,"boolean","3D Shadow"),l.prototype.publish("surfacePadding",null,"string","Cell Padding (px)",null,{tags:["Intermediate"]}),l.prototype.publish("surfaceBorderWidth",1,"number","Width (px) of Cell Border",null,{tags:["Intermediate"]}),l.prototype.publish("surfaceBackgroundColor",null,"html-color","Surface Background Color",null,{tags:["Advanced"]}),l.prototype.publish("content",[],"widgetArray","widgets",null,{tags:["Basic"],render:!1}),l.prototype.getDimensions=function(){var t={width:0,height:0};return this.content().forEach(function(e){t.width<e.gridCol()+e.gridColSpan()&&(t.width=e.gridCol()+e.gridColSpan()),t.height<e.gridRow()+e.gridRowSpan()&&(t.height=e.gridRow()+e.gridRowSpan())},this),t},l.prototype.clearContent=function(t){this.content(this.content().filter(function(e){if(!t)return e.target(null),!1;for(var i=e;i;){if(t===i)return e.target(null),!1;i=i.widget?i.widget():null}return!0}))},l.prototype.setContent=function(t,e,i,r,o,l){if(o=o||1,l=l||1,r=r||"",this.content(this.content().filter(function(i){return i.gridRow()===t&&i.gridCol()===e?(i.target(null),!1):!0})),i){var s=(new n).gridRow(t).gridCol(e).widget(i).title(r).gridRowSpan(o).gridColSpan(l);this.content().push(s)}return this},l.prototype.sortedContent=function(){return this.content().sort(function(t,e){return t.gridRow()===e.gridRow()?t.gridCol()-e.gridCol():t.gridRow()-e.gridRow()})},l.prototype.getCell=function(t,e){var i=null;return this.content().some(function(n){return t>=n.gridRow()&&t<n.gridRow()+n.gridRowSpan()&&e>=n.gridCol()&&e<n.gridCol()+n.gridColSpan()?(i=n,!0):!1}),i},l.prototype.getWidgetCell=function(t){var e=null;return this.content().some(function(i){return i.widget()._id===t?(e=i,!0):!1}),e},l.prototype.getContent=function(t){var e=null;return this.content().some(function(i){return i.widget()._id===t?(e=i.widget(),!0):!1}),e},l.prototype.cellToGridItem=function(t){return{x:t.gridCol(),y:t.gridRow(),w:t.gridColSpan(),h:t.gridRowSpan(),id:t.id(),cell:t}},l.prototype.gridItemToCell=function(t){t.cell.gridCol(t.x).gridRow(t.y).gridColSpan(t.w).gridRowSpan(t.h)},l.prototype.initGridList=function(){this.itemsMap={},this.items=this.content().map(function(t){var e=this.cellToGridItem(t);return this.itemsMap[e.id]=e,e},this),this.gridList=new e(this.items,{direction:this.snapping(),lanes:this.snappingLanes()})},l.prototype.killGridList=function(){this.gridList=null,delete this.items,delete this.itemsMap},l.prototype.enter=function(e,n){i.prototype.enter.apply(this,arguments),this._scrollBarWidth=this.getScrollbarWidth();var r=this;this._d3Drag=t.behavior.drag().origin(function(t){var e=r.cellToGridItem(t);return{x:e.x*r.cellWidth,y:e.y*r.cellHeight}}).on("dragstart",function(e){if(r.designMode()){t.event.sourceEvent.stopPropagation(),r.initGridList();var i=r.itemsMap[e.id()];r.dragItem=n.append("div").attr("class","dragging").style("transform",function(){return"translate("+i.x*r.cellWidth+"px, "+i.y*r.cellHeight+"px)"}).style("width",function(){return i.w*r.cellWidth-r.gutter()+"px"}).style("height",function(){return i.h*r.cellHeight-r.gutter()+"px"}),r.selectionBagClick(e)}}).on("drag",function(e){if(r.designMode()){t.event.sourceEvent.stopPropagation();var i=r.itemsMap[e.id()],n=[Math.max(0,Math.floor((t.event.x+r.cellWidth/2)/r.cellWidth)),Math.max(0,Math.floor((t.event.y+r.cellHeight/2)/r.cellHeight))];n[0]+i.w>r.snappingLanes()&&(n[0]=i.w-r.snappingLanes()),n[1]+i.h>r.snappingLanes()&&(n[1]=i.h-r.snappingLanes()),(i.x!==n[0]||i.y!==n[1])&&(r.gridList.moveItemToPosition(i,n),r.items.forEach(r.gridItemToCell),r.updateGrid(!1,100)),r.dragItem.style("transform",function(){return"translate("+t.event.x+"px, "+t.event.y+"px)"}).style("width",function(){return i.w*r.cellWidth+"px"}).style("height",function(){return i.h*r.cellHeight+"px"})}}).on("dragend",function(){r.designMode()&&(t.event.sourceEvent.stopPropagation(),r.dragItem.remove(),r.dragItem=null,r.killGridList())}),this._d3DragResize=t.behavior.drag().origin(function(t){var e=r.cellToGridItem(t);return{x:(e.x+e.w-1)*r.cellWidth,y:(e.y+e.h-1)*r.cellHeight}}).on("dragstart",function(e){if(r.designMode()){t.event.sourceEvent.stopPropagation(),r.initGridList();var i=r.itemsMap[e.id()];r.dragItem=n.append("div").attr("class","resizing").style("transform",function(){return"translate("+i.x*r.cellWidth+"px, "+i.y*r.cellHeight+"px)"}).style("width",function(){return i.w*r.cellWidth-r.gutter()+"px"}).style("height",function(){return i.h*r.cellHeight-r.gutter()+"px"}),r.dragItemPos={x:i.x,y:i.y}}}).on("drag",function(e){if(r.designMode()){t.event.sourceEvent.stopPropagation();var i=r.itemsMap[e.id()],n=[Math.max(0,Math.round(t.event.x/r.cellWidth)),Math.max(0,Math.round(t.event.y/r.cellHeight))],o={w:Math.max(1,n[0]-i.x+1),h:Math.max(1,n[1]-i.y+1)};(i.w!==o.w||i.h!==o.h)&&(r.gridList.resizeItem(i,o),r.items.forEach(r.gridItemToCell),r.updateGrid(i.id,100)),r.dragItem.style("width",function(){return(-i.x+1)*r.cellWidth+t.event.x-r.gutter()+"px"}).style("height",function(){return(-i.y+1)*r.cellHeight+t.event.y-r.gutter()+"px"})}}).on("dragend",function(){r.designMode()&&(t.event.sourceEvent.stopPropagation(),r.dragItem.remove(),r.dragItem=null,r.killGridList())})},l.prototype.updateGrid=function(t,e,i){e=e||0;var n=this;this.divItems.classed("draggable",this.designMode()).transition().duration(e).style("left",function(t){return t.gridCol()*n.cellWidth+n.gutter()/2+"px"}).style("top",function(t){return t.gridRow()*n.cellHeight+n.gutter()/2+"px"}).style("width",function(t){return t.gridColSpan()*n.cellWidth-n.gutter()+"px"}).style("height",function(t){return t.gridRowSpan()*n.cellHeight-n.gutter()+"px"}).each("end",function(e){e.surfaceShadow_default(n.surfaceShadow()).surfacePadding_default(n.surfacePadding()).surfaceBorderWidth_default(n.surfaceBorderWidth()).surfaceBackgroundColor_default(n.surfaceBackgroundColor()),(t===!0||t===e.id())&&e.resize().lazyRender()})},l.prototype.update=function(e,n){i.prototype.update.apply(this,arguments);var r=this.getDimensions(),o=this.width()-("width"===this.fitTo()?this._scrollBarWidth:0);if(this.cellWidth=o/r.width,this.cellHeight="all"===this.fitTo()?this.height()/r.height:this.cellWidth,this.designMode()){var l=r.width/this.snappingLanes(),s=Math.floor(this.cellWidth*l);this.cellWidth=s,this.cellHeight=this.cellWidth}var a=this;this.divItems=n.selectAll("#"+this.id()+" > .ddCell").data(this.content(),function(t){return t.id()}),this.divItems.enter().append("div").attr("class","ddCell").call(this._d3Drag).each(function(e){e.target(this),e.__grid_watch=e.monitor(function(t,i,n){a._renderCount&&0===t.indexOf("grid")&&i!==n&&(a.gridList||(a.initGridList(),a.gridList.resizeGrid(a.snappingLanes()),a.items.forEach(a.gridItemToCell),a.updateGrid(e.id(),100),a.killGridList()))});var i=t.select(this);i.append("div").attr("class","resizeHandle").call(a._d3DragResize).append("div").attr("class","resizeHandleDisplay")}),this.divItems.select(".resizeHandle").style("display",this.designMode()?null:"none"),this.updateGrid(!0),this.divItems.exit().each(function(t){t.target(null),t.__grid_watch&&t.__grid_watch.remove()}).remove();var d=n.selectAll("#"+this.id()+" > .laneBackground").data(this.designMode()?[""]:[]);d.enter().insert("div",":first-child").attr("class","laneBackground").style("left","1px").style("top","1px").on("click",function(){a.selectionBagClear()}),d.style("width",o+10+"px").style("height",this.height()+"px"),d.exit().each(function(t){a.selectionBagClear()}).remove();var c=n.selectAll("#"+this.id()+" > .lane").data(this.designMode()?[""]:[]);c.enter().append("div").attr("class","lane").style("left","1px").style("top","1px"),c.style("width",o+10+"px").style("height",this.height()+"px").style("background-image","linear-gradient(to right, grey 1px, transparent 1px), linear-gradient(to bottom, grey 1px, transparent 1px)").style("background-size",this.cellWidth+"px "+this.cellHeight+"px"),c.exit().remove()},l.prototype.exit=function(t,e){i.prototype.exit.apply(this,arguments)},l.prototype._createSelectionObject=function(t){return{_id:t._id,element:function(){return t._element},widget:t}},l.prototype.selection=function(t){return arguments.length?(this._selectionBag.set(t.map(function(t){return this._createSelectionObject(t)},this)),this):this._selectionBag.get().map(function(t){return t._id})},l.prototype.selectionBagClear=function(){this._selectionBag.isEmpty()||(this._selectionBag.clear(),this.postSelectionChange())},l.prototype.selectionBagClick=function(e){if(null!==e){var i=this._createSelectionObject(e);t.event.sourceEvent.ctrlKey?this._selectionBag.isSelected(i)?(this._selectionBag.remove(i),this.postSelectionChange()):(this._selectionBag.append(i),this.postSelectionChange()):(this._selectionBag.set([i]),this.postSelectionChange())}},l.prototype.postSelectionChange=function(){},l});