(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGWidget","../common/Utility","css!./Axis"],t):e.chart_Axis=t(e.d3,e.common_SVGWidget,e.common_Utility)})(this,function(e,t,n){function r(){t.call(this),this._drawStartPos="origin",this.d3Axis=e.svg.axis(),this.d3Guides=e.svg.axis(),this.updateScale()}r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype._class+=" chart_Axis",r.prototype.publish("title","","string","Title"),r.prototype.publish("orientation","bottom","set","Orientation",["left","top","right","bottom"]),r.prototype.publish("type","linear","set","Type",["none","ordinal","linear","pow","log","time"]),r.prototype.publish("timePattern","%Y-%m-%d","string","Time Series Pattern",null,{disable:function(e){return e.type()!=="time"}}),r.prototype.publish("powExponent",2,"number","Exponent for Pow on Value Axis",null,{disable:function(e){return e.type()!=="pow"}}),r.prototype.publish("logBase",10,"number","Base for log on Value Axis",null,{disable:function(e){return e.type()!=="log"}}),r.prototype.publish("ordinals",[],"array","Ordinal Values",null,{disable:function(e){return e.type()!=="ordinal"}}),r.prototype.publish("tickCount",null,"number","Tick Count",null,{optional:!0,disable:function(e){return e.type()==="ordinal"}}),r.prototype.publish("tickFormat",null,"string","Tick Format",null,{optional:!0,disable:function(e){return e.type()==="ordinal"}}),r.prototype.publish("tickLength",null,"number","Tick Length",{optional:!0}),r.prototype.publish("low",null,"any","Low",null,{optional:!0,disable:function(e){return e.type()==="ordinal"}}),r.prototype.publish("high",null,"any","High",null,{optional:!0,disable:function(e){return e.type()==="ordinal"}}),r.prototype.publish("overlapMode","none","set","Label Overlap Mode",["none","stagger","hide","rotate","linebreak","wrap"]),r.prototype.publish("labelRotation",33,"number","Label Rotation",null,{optional:!0,disable:function(e){return e.overlapMode()!=="rotate"}}),r.prototype.publish("shrinkToFit","both","set","Size to fit",["none","low","high","both"]),r.prototype.publish("extend",5,"number","Extend axis %",{optional:!0,disable:function(e){return e.type()==="ordinal"}});var i=r.prototype.type;r.prototype.type=function(e){var t=i.apply(this,arguments);return arguments.length&&this.updateScale(),t};var s=r.prototype.timePattern;return r.prototype.timePattern=function(e){var t=s.apply(this,arguments);return arguments.length&&this.updateScale(),t},r.prototype.lowValue=function(){return this.parse(this.low())},r.prototype.highValue=function(){return this.parse(this.high())},r.prototype.parse=function(e,t){if(e instanceof Array)return e.map(function(e){return this.parse(e)},this);if(e!==undefined&&e!==null){if(this.parser)return this.parser.parse(typeof e=="number"?e.toString():e);if(t&&typeof e=="string")return+e}return e},r.prototype.parseInvert=function(e){return e instanceof Array?e.map(function(e){return this.parseInvert(e)},this):this.parser?this.parser(e):e},r.prototype.format=function(e){return e instanceof Array?e.map(function(e){return this.format(e)},this):e!==undefined&&e!==null&&this.formatter?this.formatter(e):e},r.prototype.scalePos=function(e){var t=this.d3Scale(this.parse(e));return this.type()==="ordinal"&&(t+=this.d3Scale.rangeBand()/2),t},r.prototype.isHorizontal=function(){switch(this.orientation()){case"left":case"right":return!1}return!0},r.prototype.domain=function(e){return arguments.length?(this.d3Scale.domain(e),this):this.d3Scale.domain()},r.prototype.range=function(e){if(!arguments.length){if(this.d3Scale.rangeRoundBands)return this.d3Scale.rangeExtent();if(this.d3Scale.rangeRound)return this.d3Scale.range()}return this.d3Scale.rangeRoundBands?this.d3Scale.rangeRoundBands(e,.1):this.d3Scale.rangeRound&&this.d3Scale.range(e),this},r.prototype.invert=function(e){return this.d3Scale.invert(e)},r.prototype.guideTarget=function(t){this._guideElement=e.select(t).attr("class",this._class)},r.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this.svg=n.append("g"),this.svgAxis=this.svg.append("g").attr("class","axis"),this.svgText=this.svgAxis.append("text"),this.svg2=(this._guideElement||n).append("g"),this.svgGuides=this.svg2.attr("class","guide")},r.prototype.updateScale=function(){switch(this.type()){case"ordinal":this.d3Scale=e.scale.ordinal(),this.ordinals_exists()&&this.d3Scale.domain(this.ordinals()),this.parser=null,this.formatter=null;break;case"linear":this.d3Scale=e.scale.linear(),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?e.format(this.tickFormat()):null;break;case"pow":this.d3Scale=e.scale.pow().exponent(this.powExponent()),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?e.format(this.tickFormat()):null;break;case"log":this.d3Scale=e.scale.log().base(this.logBase()),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?e.format(this.tickFormat()):null;break;case"time":this.d3Scale=e.time.scale(),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=this.timePattern_exists()?e.time.format(this.timePattern()):null,this.formatter=this.tickFormat_exists()?e.time.format(this.tickFormat()):null}if(this.extend())switch(this.type()){case"ordinal":break;default:var t,n,r,i;this.isHorizontal()?(t=this.width(),this.d3Scale.range([0,t]),n=t*this.extend()/100,r=this.d3Scale.invert(-n),i=this.d3Scale.invert(t+n)):(t=this.height(),this.d3Scale.range([t,0]),n=t*this.extend()/100,r=this.d3Scale.invert(t+n),i=this.d3Scale.invert(-n)),this.d3Scale.domain([r,i])}this.d3Axis.orient(this.orientation()).scale(this.d3Scale).tickFormat(this.formatter).ticks(this.tickCount()),this.d3Guides.orient(this.orientation()).scale(this.d3Scale).tickSize(-this.tickLength()).tickFormat("").ticks(this.tickCount())},r.prototype.adjustText=function(t,n){var r=this.isHorizontal(),i=this.orientation()==="left",s=this.orientation()==="bottom",o=this;if(this.overlapMode()==="linebreak")this.type()==="ordinal"&&t.selectAll(".tick > text").call(function(){return o.linebreak.apply(o,arguments)},this.d3Scale.rangeBand());else if(this.overlapMode()==="wrap")this.type()==="ordinal"&&t.selectAll(".tick > text").call(function(){return o.wrap.apply(o,arguments)},this.d3Scale.rangeBand());else switch(r?this.overlapMode():"none"){case"stagger":t.selectAll(".tick > text").style("text-anchor","middle").attr("dy",function(e,t){return(s?1:-1)*((s?.71:0)+t%n)+"em"}).attr("dx",0).attr("visibility",null).attr("transform","rotate(0)");break;case"hide":t.selectAll(".tick > text").style("text-anchor","middle").attr("dy",(s?.71:0)+"em").attr("dx",0).attr("visibility",function(e,t){return t%n?"hidden":null}).attr("transform","rotate(0)");break;case"rotate":var u=-this.labelRotation()||0;if(u!==0&&n>1){t.selectAll(".tick > text").each(function(){var t=e.select(this),n=t.node().getBBox(),r=(s?1:-1)*Math.sin(Math.PI*(-Math.abs(u)/180));t.style("text-anchor",u>0?s?"start":"end":s?"end":"start").attr("dy",n.height/2*r+"px").attr("dx",u>0?s?"0.71em":"-0.71em":s?"-0.71em":"0.71em").attr("transform","rotate("+u+")").attr("visibility",null)});break};default:t.selectAll(".tick > text").style("text-anchor",r?"middle":i?"end":"start").attr("dy",r?(s?.71:0)+"em":"0.32em").attr("dx",0).attr("visibility",null).attr("transform","rotate(0)")}},r.prototype.calcTickOverlapModulus=function(e){var t=1;switch(this.overlapMode()){case"rotate":case"stagger":case"hide":var n=[];e.selectAll(".tick > text").each(function(e){var r=this.getBoundingClientRect();for(var i=n.length-1;i>=0;--i){if(n[i].right<r.left)break;n.length+1-i>t&&(t=n.length+1-i)}n.push(r)})}return t},r.prototype.calcOverflow=function(e,t){this.updateScale();var n=this.isHorizontal();this.range(n?[0,this.width()]:[this.height(),0]);var r=e.append("g").attr("class",this.classID()).append("g");r.attr("class",n?"x":"y").call(this.d3Axis),t&&e.selectAll(".tick > text").remove();var i={left:0,top:0,right:0,bottom:0,tickOverlapModulus:this.calcTickOverlapModulus(r)};this.adjustText(r,i.tickOverlapModulus);var s=r.node().getBBox();i.depth=n?s.height:s.width;switch(this.shrinkToFit()){case"low":case"both":i.left=n?-s.x:0,i.bottom=n?0:-(this.height()-(s.height+s.y))}switch(this.shrinkToFit()){case"high":case"both":i.top=n?0:-s.y,i.right=n?-(this.width()-s.x-s.width):0}return r.remove(),i},r.prototype.wrap=function(t,n,r){r=r||/\s+/;var i=this;t.each(function(){var t=e.select(this),s=t.text().split(r).reverse(),o,u=[],a=0,f=1.1,l=t.attr("x"),c=t.attr("y"),h=parseFloat(t.style("font-size"))||10,p=Math.floor(n/(h*f))-1,d=i.isHorizontal()?1:Math.ceil(s.length/p),v=parseFloat(t.attr("dy")),m=t.text(null).append("tspan").attr("x",l).attr("y",c).attr("dy",v+"em"),g=0;while(o=s.pop())u.push(o),m.text(u.join(" ")),g++,m.node().getComputedTextLength()>n&&g>=d&&(u.pop(),m.text(u.join(" ")),u=[o],m=t.append("tspan").attr("x",l).attr("y",c).attr("dy",++a*f+v+"em").text(o),g=0);i.isHorizontal()||t.selectAll("tspan").attr("y",-a/2+"em")})},r.prototype.linebreak=function(e,t){this.wrap(e,t,"\n")},r.prototype.update=function(e,n){function s(e){e.attr("transform",function(e){switch(i.orientation()){case"left":return"translate("+r.depth+", "+r.top+")";case"top":return"translate(0,"+r.depth+")";case"right":return"translate("+(i.width()-r.depth)+", "+r.top+")";case"bottom":return"translate(0,"+(i.height()-r.depth)+")"}return"translate(0,0)"})}t.prototype.update.apply(this,arguments);var r=this.calcOverflow(n);this.range(this.isHorizontal()?[r.left,this.width()-r.right]:[this.height()-r.top-r.bottom,0]);var i=this;this.svg.style("visibility",this.type()==="none"?"hidden":null).transition().call(s),this._guideElement&&this.svg2.transition().call(s),this.svgAxis.call(this.d3Axis),this.adjustText(this.svgAxis,r.tickOverlapModulus);var o=this.svgAxis.select("path.domain"),u=o.node().getBBox();switch(this.orientation()){case"left":this.svgText.transition().attr("transform","rotate(-90)").attr("x",-2).attr("y",2).attr("dx",null).attr("dy",".71em").style("text-anchor","end").text(this.title());break;case"right":this.svgText.transition().attr("transform","rotate(-90)").attr("x",-2).attr("y",4).attr("dx",null).attr("dy","-.71em").style("text-anchor","end").text(this.title());break;case"top":this.svgText.transition().attr("transform","rotate(0)").attr("x",u.x+u.width-2).attr("y",2).attr("dx",null).attr("dy",".71em").style("text-anchor","end").text(this.title());break;case"bottom":this.svgText.transition().attr("transform","rotate(0)").attr("x",u.x+u.width-2).attr("y",-2).attr("dx",null).attr("dy",null).style("text-anchor","end").text(this.title())}this.svgGuides.call(this.d3Guides)},r.prototype.postUpdate=function(e,n){t.prototype.postUpdate.apply(this,arguments),this._guideElement&&this._guideElement.attr("transform",this._element.attr("transform"))},r});