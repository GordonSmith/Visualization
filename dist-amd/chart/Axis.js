!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/SVGWidget","../common/Utility","css!./Axis"],e):t.chart_Axis=e(t.d3,t.common_SVGWidget,t.common_Utility)}(this,function(t,e,i){function r(){e.call(this),this._drawStartPos="origin",this.d3Axis=t.svg.axis(),this.d3Guides=t.svg.axis(),this.type("linear").timePattern(this.timePattern())}r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" chart_Axis",r.prototype.publish("title","","string","Title"),r.prototype.publish("orientation","bottom","set","Orientation",["left","top","right","bottom"]),r.prototype.publish("type","ordinal","set","Type",["none","ordinal","linear","pow","log","time"]),r.prototype.publish("timePattern","%Y-%m-%d","string","Time Series Pattern",null,{disable:function(t){return"time"!==t.type()}}),r.prototype.publish("powExponent",2,"number","Exponent for Pow on Value Axis",null,{disable:function(t){return"pow"!==t.type()}}),r.prototype.publish("logBase",10,"number","Base for log on Value Axis",null,{disable:function(t){return"log"!==t.type()}}),r.prototype.publish("ordinals",[],"array","Ordinal Values",null,{disable:function(t){return"ordinal"!==t.type()}}),r.prototype.publish("tickCount",null,"number","Tick Count",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),r.prototype.publish("tickFormat",null,"string","Tick Format",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),r.prototype.publish("tickLength",null,"number","Tick Length",{optional:!0}),r.prototype.publish("low",null,"any","Low",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),r.prototype.publish("high",null,"any","High",null,{optional:!0,disable:function(t){return"ordinal"===t.type()}}),r.prototype.publish("overlapMode","none","set","Label Overlap Mode",["none","stagger","hide","rotate","linebreak","wrap"]),r.prototype.publish("labelRotation",33,"number","Label Rotation",null,{optional:!0,disable:function(t){return"rotate"!==t.overlapMode()}}),r.prototype.publish("shrinkToFit","both","set","Size to fit",["none","low","high","both"]),r.prototype.publish("extend",5,"number","Extend axis %",{optional:!0,disable:function(t){return"ordinal"===t.type()}});var s=r.prototype.type;r.prototype.type=function(t){var e=s.apply(this,arguments);return arguments.length&&this.updateScale(),e};var a=r.prototype.timePattern;return r.prototype.timePattern=function(t){var e=a.apply(this,arguments);return arguments.length&&this.updateScale(),e},r.prototype.lowValue=function(){return this.parse(this.low())},r.prototype.highValue=function(){return this.parse(this.high())},r.prototype.parse=function(t,e){if(t instanceof Array)return t.map(function(t){return this.parse(t)},this);if(void 0!==t&&null!==t){if(this.parser)return this.parser.parse("number"==typeof t?t.toString():t);if(e&&"string"==typeof t)return+t}return t},r.prototype.parseInvert=function(t){return t instanceof Array?t.map(function(t){return this.parseInvert(t)},this):this.parser?this.parser(t):t},r.prototype.format=function(t){return t instanceof Array?t.map(function(t){return this.format(t)},this):void 0!==t&&null!==t&&this.formatter?this.formatter(t):t},r.prototype.scalePos=function(t){var e=this.d3Scale(this.parse(t));return"ordinal"===this.type()&&(e+=this.d3Scale.rangeBand()/2),e},r.prototype.isHorizontal=function(){switch(this.orientation()){case"left":case"right":return!1}return!0},r.prototype.domain=function(t){return arguments.length?(this.d3Scale.domain(t),this):this.d3Scale.domain()},r.prototype.range=function(t){if(!arguments.length){if(this.d3Scale.rangeRoundBands)return this.d3Scale.rangeExtent();if(this.d3Scale.rangeRound)return this.d3Scale.range()}return this.d3Scale.rangeRoundBands?this.d3Scale.rangeRoundBands(t,.1):this.d3Scale.rangeRound&&this.d3Scale.range(t),this},r.prototype.invert=function(t){return this.d3Scale.invert(t)},r.prototype.guideTarget=function(e){this._guideElement=t.select(e).attr("class",this._class)},r.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this.svg=i.append("g"),this.svgAxis=this.svg.append("g").attr("class","axis"),this.svgText=this.svgAxis.append("text"),this.svg2=(this._guideElement||i).append("g"),this.svgGuides=this.svg2.attr("class","guide")},r.prototype.updateScale=function(){switch(this.type()){case"ordinal":this.d3Scale=t.scale.ordinal(),this.ordinals_exists()&&this.d3Scale.domain(this.ordinals()),this.parser=null,this.formatter=null;break;case"linear":this.d3Scale=t.scale.linear(),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?t.format(this.tickFormat()):null;break;case"pow":this.d3Scale=t.scale.pow().exponent(this.powExponent()),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?t.format(this.tickFormat()):null;break;case"log":this.d3Scale=t.scale.log().base(this.logBase()),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=null,this.formatter=this.tickFormat_exists()?t.format(this.tickFormat()):null;break;case"time":this.d3Scale=t.time.scale(),this.low_exists()&&this.high_exists()&&this.d3Scale.domain([this.lowValue(),this.highValue()]),this.parser=this.timePattern_exists()?t.time.format(this.timePattern()):null,this.formatter=this.tickFormat_exists()?t.time.format(this.tickFormat()):null}if(this.extend())switch(this.type()){case"ordinal":break;default:var e,i,r,s;this.isHorizontal()?(e=this.width(),this.d3Scale.range([0,e]),i=e*this.extend()/100,r=this.d3Scale.invert(-i),s=this.d3Scale.invert(e+i)):(e=this.height(),this.d3Scale.range([e,0]),i=e*this.extend()/100,r=this.d3Scale.invert(e+i),s=this.d3Scale.invert(-i)),this.d3Scale.domain([r,s])}this.d3Axis.orient(this.orientation()).scale(this.d3Scale).tickFormat(this.formatter).ticks(this.tickCount()),this.d3Guides.orient(this.orientation()).scale(this.d3Scale).tickSize(-this.tickLength()).tickFormat("").ticks(this.tickCount())},r.prototype.adjustText=function(e,i){var r=this.isHorizontal(),s="left"===this.orientation(),a="bottom"===this.orientation(),n=this;if("linebreak"===this.overlapMode())"ordinal"===this.type()&&e.selectAll(".tick > text").call(function(){return n.linebreak.apply(n,arguments)},this.d3Scale.rangeBand());else if("wrap"===this.overlapMode())"ordinal"===this.type()&&e.selectAll(".tick > text").call(function(){return n.wrap.apply(n,arguments)},this.d3Scale.rangeBand());else switch(r?this.overlapMode():"none"){case"stagger":e.selectAll(".tick > text").style("text-anchor","middle").attr("dy",function(t,e){return(a?1:-1)*((a?.71:0)+e%i)+"em"}).attr("dx",0).attr("visibility",null).attr("transform","rotate(0)");break;case"hide":e.selectAll(".tick > text").style("text-anchor","middle").attr("dy",(a?.71:0)+"em").attr("dx",0).attr("visibility",function(t,e){return e%i?"hidden":null}).attr("transform","rotate(0)");break;case"rotate":var o=-this.labelRotation()||0;if(0!==o&&i>1){e.selectAll(".tick > text").each(function(){var e=t.select(this),i=e.node().getBBox(),r=(a?1:-1)*Math.sin(Math.PI*(-Math.abs(o)/180));e.style("text-anchor",o>0?a?"start":"end":a?"end":"start").attr("dy",i.height/2*r+"px").attr("dx",o>0?a?"0.71em":"-0.71em":a?"-0.71em":"0.71em").attr("transform","rotate("+o+")").attr("visibility",null)});break}default:e.selectAll(".tick > text").style("text-anchor",r?"middle":s?"end":"start").attr("dy",r?(a?.71:0)+"em":"0.32em").attr("dx",0).attr("visibility",null).attr("transform","rotate(0)")}},r.prototype.calcTickOverlapModulus=function(t){var e=1;switch(this.overlapMode()){case"rotate":case"stagger":case"hide":var i=[];t.selectAll(".tick > text").each(function(t){for(var r=this.getBoundingClientRect(),s=i.length-1;s>=0&&!(i[s].right<r.left);--s)i.length+1-s>e&&(e=i.length+1-s);i.push(r)})}return e},r.prototype.calcOverflow=function(t,e){this.updateScale();var i=this.isHorizontal();this.range(i?[0,this.width()]:[this.height(),0]);var r=t.append("g").attr("class",this.classID()).append("g");r.attr("class",i?"x":"y").call(this.d3Axis),e&&t.selectAll(".tick > text").remove();var s={left:0,top:0,right:0,bottom:0,tickOverlapModulus:this.calcTickOverlapModulus(r)};this.adjustText(r,s.tickOverlapModulus);var a=r.node().getBBox();switch(s.depth=i?a.height:a.width,this.shrinkToFit()){case"low":case"both":s.left=i?-a.x:0,s.bottom=i?0:-(this.height()-(a.height+a.y))}switch(this.shrinkToFit()){case"high":case"both":s.top=i?0:-a.y,s.right=i?-(this.width()-a.x-a.width):0}return r.remove(),s},r.prototype.wrap=function(e,i,r){r=r||/\s+/;var s=this;e.each(function(){for(var e,a=t.select(this),n=a.text().split(r).reverse(),o=[],l=0,h=1.1,p=a.attr("x"),c=a.attr("y"),u=parseFloat(a.style("font-size"))||10,d=Math.floor(i/(u*h))-1,g=s.isHorizontal()?1:Math.ceil(n.length/d),m=parseFloat(a.attr("dy")),y=a.text(null).append("tspan").attr("x",p).attr("y",c).attr("dy",m+"em"),f=0;e=n.pop();)o.push(e),y.text(o.join(" ")),f++,y.node().getComputedTextLength()>i&&f>=g&&(o.pop(),y.text(o.join(" ")),o=[e],y=a.append("tspan").attr("x",p).attr("y",c).attr("dy",++l*h+m+"em").text(e),f=0);s.isHorizontal()||a.selectAll("tspan").attr("y",-l/2+"em")})},r.prototype.linebreak=function(t,e){this.wrap(t,e,"\n")},r.prototype.update=function(t,i){function r(t){t.attr("transform",function(t){switch(a.orientation()){case"left":return"translate("+s.depth+", "+s.top+")";case"top":return"translate(0,"+s.depth+")";case"right":return"translate("+(a.width()-s.depth)+", "+s.top+")";case"bottom":return"translate(0,"+(a.height()-s.depth)+")"}return"translate(0,0)"})}e.prototype.update.apply(this,arguments);var s=this.calcOverflow(i);this.range(this.isHorizontal()?[s.left,this.width()-s.right]:[this.height()-s.top-s.bottom,0]);var a=this;this.svg.style("visibility","none"===this.type()?"hidden":null).transition().call(r),this._guideElement&&this.svg2.transition().call(r),this.svgAxis.call(this.d3Axis),this.adjustText(this.svgAxis,s.tickOverlapModulus);var n=this.svgAxis.select("path.domain"),o=n.node().getBBox();switch(this.orientation()){case"left":this.svgText.transition().attr("transform","rotate(-90)").attr("x",-2).attr("y",2).attr("dx",null).attr("dy",".71em").style("text-anchor","end").text(this.title());break;case"right":this.svgText.transition().attr("transform","rotate(-90)").attr("x",-2).attr("y",4).attr("dx",null).attr("dy","-.71em").style("text-anchor","end").text(this.title());break;case"top":this.svgText.transition().attr("transform","rotate(0)").attr("x",o.x+o.width-2).attr("y",2).attr("dx",null).attr("dy",".71em").style("text-anchor","end").text(this.title());break;case"bottom":this.svgText.transition().attr("transform","rotate(0)").attr("x",o.x+o.width-2).attr("y",-2).attr("dx",null).attr("dy",null).style("text-anchor","end").text(this.title())}this.svgGuides.call(this.d3Guides)},r.prototype.postUpdate=function(t,i){e.prototype.postUpdate.apply(this,arguments),this._guideElement&&this._guideElement.attr("transform",this._element.attr("transform"))},r});