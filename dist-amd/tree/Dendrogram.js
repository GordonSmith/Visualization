(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGZoomWidget","../common/PropertyExt","../api/ITree","css!./Dendrogram"],t):e.tree_Dendrogram=t(e.d3,e.common_SVGZoomWidget,e.common_PropertyExt,e.api_ITree)})(this,function(e,t,n,r){function i(e){n.call(this),this._owner=e}function s(n){t.call(this),r.call(this),this._drawStartPos="origin";var i=this;this._d3LayoutCluster=e.layout.cluster(),this._d3LayoutTree=e.layout.tree(),this._d3Diagonal=e.svg.diagonal().projection(function(e){return i.orientation()==="horizontal"?[e.y,e.x]:[e.x,e.y]}),this._d3DiagonalRadial=e.svg.diagonal.radial().projection(function(e){return[e.y,e.x/180*Math.PI]})}return i.prototype=Object.create(n.prototype),i.prototype.constructor=i,i.prototype._class+=" tree_Dendrogram.Column",i.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),s.prototype=Object.create(t.prototype),s.prototype.constructor=s,s.prototype._class+=" tree_Dendrogram",s.prototype.implements(r.prototype),s.prototype.Column=i,s.prototype.publish("paletteID","default","set","Palette ID",s.prototype._palette.switch(),{tags:["Basic","Shared"]}),s.prototype.publish("useClonedPalette",!1,"boolean","Enable or disable using a cloned palette",null,{tags:["Intermediate","Shared"]}),s.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:i}),s.prototype.publish("circleRadius",4.5,"number","Text offset from circle"),s.prototype.publish("separation",240,"number","Leaf Separation"),s.prototype.publish("dendrogram",!0,"boolean","Dendrogram"),s.prototype.publish("radial",!1,"boolean","Radial"),s.prototype.publish("orientation","horizontal","set","Orientation",["horizontal","vertical"],{tags:["Private"],disabled:function(){return this.radial()}}),s.prototype.dendrogramData=function(){function n(e){return{label:e.key,children:e.values.filter(function(e){return!(e instanceof Array)}).map(function(e){return n(e)})}}if(!this.mappings().filter(function(e){return e.column()}).length)return this.data();var e=this._db.rollupView(this.mappings().map(function(e){return e.column()})),t={key:"root",values:e.entries()};return n(t)},s.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._renderElement.attr("opacity",0)},s.prototype.update=function(n,r,i){function h(e){return s.radial()?"rotate("+(e.x-90)+")translate("+e.y+")":s.orientation()==="horizontal"?"translate("+e.y+","+e.x+")":"translate("+e.x+","+e.y+")"}t.prototype.update.apply(this,arguments);var s=this;this._palette=this._palette.switch(this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id())),this._renderElement.transition().duration(500).attr("opacity",1),this._d3Layout=this.dendrogram()?this._d3LayoutCluster:this._d3LayoutTree,this.radial()?(this._d3Layout.size([360,this.separation()*2]),this._d3Layout.separation(function(t,n){return(t.parent===n.parent?1:2)/t.depth})):(this._d3Layout.nodeSize([14,this.separation()]),this._d3Layout.separation(function(t,n){return t.parent===n.parent?1:2}));var o=this.dendrogramData(),u=this._d3Layout.nodes(o),a=this._d3Layout.links(u),f=this._renderCount?500:0,l=this._renderElement.selectAll(".link").data(a);l.enter().append("path").attr("class","link").attr("d",this.radial()?this._d3DiagonalRadial:this._d3Diagonal),l.transition().duration(f).attr("d",this.radial()?this._d3DiagonalRadial:this._d3Diagonal),l.exit().remove();var c=this.circleRadius()+2,p=this._renderElement.selectAll(".node").data(u);p.transition().duration(f).attr("transform",h),p.enter().append("g").attr("class","node").attr("transform",h).on("click",function(e){s.click(e)}).each(function(t,n){var r=e.select(this);r.append("circle"),r.append("text")}),p.select("circle").attr("r",this.circleRadius()).style("fill",function(e){return s._palette(e.label)}).append("title").text(function(e){return e.label}),p.select("text").attr("dx",function(e){return s.radial()?e.children?e.x<180?-c:c:e.x<180?c:-c:s.orientation()==="vertical"?e.children?c:-c:e.children?-c:c}).attr("dy","0.25em").style("text-anchor",function(e){return s.radial()?e.children?e.x<180?"end":"start":e.x<180?"start":"end":s.orientation()==="vertical"?e.children?"start":"end":e.children?"end":"start"}).attr("transform",function(e){return s.radial()?e.x<180?null:"rotate(180)":s.orientation()==="vertical"?"rotate(-66)":null}).text(function(e){return e.label}),p.exit().remove(),this._renderCount||s.zoomToFit()},s});