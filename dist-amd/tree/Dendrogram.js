!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/SVGZoomWidget","../common/PropertyExt","../api/ITree","css!./Dendrogram"],e):t.tree_Dendrogram=e(t.d3,t.common_SVGZoomWidget,t.common_PropertyExt,t.api_ITree)}(this,function(t,e,r,n){function a(t){r.call(this),this._owner=t}function o(r){e.call(this),n.call(this),this._drawStartPos="origin";var a=this;this._d3LayoutCluster=t.layout.cluster(),this._d3LayoutTree=t.layout.tree(),this._d3Diagonal=t.svg.diagonal().projection(function(t){return"horizontal"===a.orientation()?[t.y,t.x]:[t.x,t.y]}),this._d3DiagonalRadial=t.svg.diagonal.radial().projection(function(t){return[t.y,t.x/180*Math.PI]})}return a.prototype=Object.create(r.prototype),a.prototype.constructor=a,a.prototype._class+=" tree_Dendrogram.Column",a.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype._class+=" tree_Dendrogram",o.prototype["implements"](n.prototype),o.prototype.Column=a,o.prototype.publish("paletteID","default","set","Palette ID",o.prototype._palette["switch"](),{tags:["Basic","Shared"]}),o.prototype.publish("useClonedPalette",!1,"boolean","Enable or disable using a cloned palette",null,{tags:["Intermediate","Shared"]}),o.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:a}),o.prototype.publish("circleRadius",4.5,"number","Text offset from circle"),o.prototype.publish("separation",240,"number","Leaf Separation"),o.prototype.publish("dendrogram",!0,"boolean","Dendrogram"),o.prototype.publish("radial",!1,"boolean","Radial"),o.prototype.publish("orientation","horizontal","set","Orientation",["horizontal","vertical"],{tags:["Private"],disabled:function(){return this.radial()}}),o.prototype.dendrogramData=function(){function t(e){return{label:e.key,children:e.values.filter(function(t){return!(t instanceof Array)}).map(function(e){return t(e)})}}if(!this.mappings().filter(function(t){return t.column()}).length)return this.data();var e=this._db.rollupView(this.mappings().map(function(t){return t.column()})),r={key:"root",values:e.entries()};return t(r)},o.prototype.enter=function(t,r){e.prototype.enter.apply(this,arguments),this._renderElement.attr("opacity",0)},o.prototype.update=function(r,n,a){function o(t){return i.radial()?"rotate("+(t.x-90)+")translate("+t.y+")":"horizontal"===i.orientation()?"translate("+t.y+","+t.x+")":"translate("+t.x+","+t.y+")"}e.prototype.update.apply(this,arguments);var i=this;this._palette=this._palette["switch"](this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id())),this._renderElement.transition().duration(500).attr("opacity",1),this._d3Layout=this.dendrogram()?this._d3LayoutCluster:this._d3LayoutTree,this.radial()?(this._d3Layout.size([360,2*this.separation()]),this._d3Layout.separation(function(t,e){return(t.parent===e.parent?1:2)/t.depth})):(this._d3Layout.nodeSize([14,this.separation()]),this._d3Layout.separation(function(t,e){return t.parent===e.parent?1:2}));var l=this.dendrogramData(),s=this._d3Layout.nodes(l),p=this._d3Layout.links(s),d=this._renderCount?500:0,u=this._renderElement.selectAll(".link").data(p);u.enter().append("path").attr("class","link").attr("d",this.radial()?this._d3DiagonalRadial:this._d3Diagonal),u.transition().duration(d).attr("d",this.radial()?this._d3DiagonalRadial:this._d3Diagonal),u.exit().remove();var c=this.circleRadius()+2,h=this._renderElement.selectAll(".node").data(s);h.transition().duration(d).attr("transform",o),h.enter().append("g").attr("class","node").attr("transform",o).on("click",function(t){i.click(t)}).each(function(e,r){var n=t.select(this);n.append("circle"),n.append("text")}),h.select("circle").attr("r",this.circleRadius()).style("fill",function(t){return i._palette(t.label)}).append("title").text(function(t){return t.label}),h.select("text").attr("dx",function(t){return i.radial()?t.children?t.x<180?-c:c:t.x<180?c:-c:"vertical"===i.orientation()?t.children?c:-c:t.children?-c:c}).attr("dy","0.25em").style("text-anchor",function(t){return i.radial()?t.children?t.x<180?"end":"start":t.x<180?"start":"end":"vertical"===i.orientation()?t.children?"start":"end":t.children?"end":"start"}).attr("transform",function(t){return i.radial()?t.x<180?null:"rotate(180)":"vertical"===i.orientation()?"rotate(-66)":null}).text(function(t){return t.label}),h.exit().remove(),this._renderCount||i.zoomToFit()},o});