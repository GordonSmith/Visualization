(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGWidget","../api/IInput","../chart/Axis","../common/Icon","css!./Slider"],t):e.form_Slider=t(e.d3,e.common_SVGWidget,e.api_IInput,e.chart_Axis,e.common_Icon)})(this,function(e,t,n,r,i){function s(){t.call(this),n.call(this),this.selectionLabel(""),this._playing=!1,this._loop=!1,this.axis=new r;var s=this;this._playIcon=(new i).faChar(""),this._playIcon.click=function(t){e.event.stopPropagation(),s._playing?s.pause():s.play()},this._loopIcon=(new i).faChar("").image_colorFill(this._loop?null:"#bbb").shape_colorFill(this._loop?null:"white").paddingPercent(33),this._loopIcon.click=function(e){s._loop?s._loop=!1:s._loop=!0,s._loopIcon.image_colorFill(s._loop?null:"#bbb").shape_colorFill(s._loop?null:"white").render()},this.brush=e.svg.brush().extent([0,0]).on("brushstart",function(e){s.brushstart(e,this)}).on("brush",function(e){s.brushmove(e,this)}).on("brushend",function(e){s.brushend(e,this)}),this.brush.empty=function(){return!1},this._inputElement=[]}s.prototype=Object.create(t.prototype),s.prototype.constructor=s,s.prototype._class+=" form_Slider",s.prototype.implements(n.prototype),s.prototype.publish("padding",16,"number","Outer Padding",null,{tags:["Basic"]}),s.prototype.publish("fontSize",null,"number","Font Size",null,{tags:["Basic"]}),s.prototype.publish("fontFamily",null,"string","Font Name",null,{tags:["Basic"]}),s.prototype.publish("fontColor",null,"html-color","Font Color",null,{tags:["Basic"]}),s.prototype.publish("allowRange",!1,"boolean","Allow Range Selection",null,{tags:["Intermediate"]}),s.prototype.publish("low","0","string","Low",null,{tags:["Intermediate"]}),s.prototype.publish("high","100","string","High",null,{tags:["Intermediate"]}),s.prototype.publish("step",10,"number","Step",null,{tags:["Intermediate"]}),s.prototype.publish("selectionLabel","","string","Selection Label",null,{tags:["Intermediate"]}),s.prototype.publishProxy("tickCount","axis","tickCount"),s.prototype.publishProxy("tickFormat","axis","tickFormat"),s.prototype.publishProxy("type","axis"),s.prototype.publishProxy("timePattern","axis"),s.prototype.publishProxy("powExponent","axis","powExponent"),s.prototype.publishProxy("logBase","axis","logBase"),s.prototype.publishProxy("overlapMode","axis"),s.prototype.publishProxy("labelRotation","axis"),s.prototype.publish("showPlay",!1,"boolean","Show Play Button"),s.prototype.publish("playInterval",1e3,"number","Play Interval"),s.prototype.publishProxy("playDiameter","_playIcon","diameter",32),s.prototype.publish("playGutter",4,"number","Play Gutter"),s.prototype.publishProxy("loopDiameter","_loopIcon","diameter",24),s.prototype.publish("loopGutter",4,"number","Play Gutter"),s.prototype.name=function(e){return s.prototype.columns.apply(this,arguments)};var o=s.prototype.value;return s.prototype.value=function(e){var n=o.apply(this,arguments);return arguments.length&&t.prototype.data.apply(this,arguments),n},s.prototype.play=function(){this._playing=!0,this._playIcon.faChar("").render();var e=this.data();if(e<this.low()||e>=this.high())e=this.low(),this.data(e).render(),this._click();var t=this;this.intervalHandler=setInterval(function(){e+=t.step(),e>t.high()?t._loop===!0?(e=t.low(),t.data(e).render(),t._click()):t.pause():(t.data(e).render(),t._click())},t.playInterval())},s.prototype.pause=function(){this._playing=!1,this._playIcon.faChar("").render(),clearInterval(this.intervalHandler)},s.prototype.data=function(e){var n=t.prototype.data.apply(this,arguments);return arguments.length&&this.brushg&&this.brushg.call(this.brush.extent(this.allowRange()?this.data():[this.data(),this.data()])),n},s.prototype.enter=function(e,t){this.sliderElement=t.append("g"),this._inputElement.push(this.sliderElement),this.axis.target(this.sliderElement.node()).x(this.width()).y(0).width(this.width()-this.padding()).low(this.low()).high(this.high()).render(),this.axis.d3Axis.tickSize(0).tickPadding(12),this.brushg=this.sliderElement.append("g").attr("class","brush").call(this.brush),this.brushg.select(".background").attr("y",-9).attr("height",18),this.brushg.select(".extent").attr("y","-10").attr("height","20"),this.brushg.selectAll(".resize").select("rect").attr("x",function(e){return e==="e"?0:-8}).attr("y","-10").attr("width","8").attr("height","20"),this.handle=this.brushg.selectAll(".resize").append("path").attr("class","handle").attr("transform","translate(0,-27)"),this._playIcon.target(this.sliderElement.node()).render(),this._loopIcon.target(this.sliderElement.node()).render()},s.prototype.update=function(e,t){var n=this,r=this.width()-this.padding()/2;this._playIcon.pos({x:r-(this.loopDiameter()+this.loopGutter()+this.playDiameter()/2),y:0}).diameter(this.playDiameter()).display(this.showPlay()).render(),this._loopIcon.pos({x:r-this.loopDiameter()/2,y:0}).diameter(this.loopDiameter()).display(this.showPlay()).render(),(this.high()-this.low())/this.step()<=10;var i=this.showPlay()?this.loopDiameter()+this.loopGutter()+this.playDiameter()+this.playGutter():0;r-=i;var s=this.axis.calcOverflow(t);this.axis.x(this.width()/2-i/2).y(s.depth).width(this.width()-this.padding()-i).low(this.low()).high(this.high()).render(),this.brushg.attr("transform","translate("+this.padding()/2+", 0)"),this.handle.attr("d",function(e){return n.handlePath(e)}),this.data().length===0&&(this.allowRange()?this.data([this.low(),this.low()]):this.data(this.low())),this.axis.d3Scale.clamp(!0),this.brush.x(this.axis.d3Scale),this.brushg.call(this.brush.extent(this.allowRange()?this.data():[this.data(),this.data()]));var o=this.sliderElement.node().getBBox();this.sliderElement.attr("transform","translate("+ -this.width()/2+", "+ -(o.y+o.height/2)+")")},s.prototype.brushstart=function(t,n){if(!e.event||!e.event.sourceEvent)return;e.event.sourceEvent.stopPropagation()},s.prototype.brushmove=function(t,n){if(!e.event||!e.event.sourceEvent)return;e.event.sourceEvent.stopPropagation();if(!this.allowRange()){var r=this.axis.invert(e.mouse(n)[0]);e.select(n).call(this.brush.extent([r,r]))}},s.prototype.brushend=function(t,n){if(!e.event||!e.event.sourceEvent)return;e.event.sourceEvent.stopPropagation();if(!this.allowRange()){var r=this.nearestStep(this.axis.invert(e.mouse(n)[0]));e.select(n).call(this.brush.extent([r,r])),this.value(this.axis.parseInvert(r)),this._click()}else{var i=this.brush.extent();i[0]=this.nearestStep(i[0]),i[1]=this.nearestStep(i[1]),e.select(n).call(this.brush.extent(i)),this.newSelection(this.axis.parseInvert(i[0]),this.axis.parseInvert(i[1]))}},s.prototype.nearestStep=function(e){switch(this.type()){case"time":return e;default:return+this.axis.parse(this.low())+Math.round((e- +this.axis.parse(this.low()))/+this.step())*+this.step()}},s.prototype.handlePath=function(e,t){var n=+(e==="e"),r=n?1:-1,i=this.allowRange()?.5:0,s=18,o="M"+i*r+","+s+"A6,6 0 0 "+n+" "+6.5*r+","+(s+6)+"V"+(2*s-6)+"A6,6 0 0 "+n+" "+i*r+","+2*s;return this.allowRange()?o+="ZM"+2.5*r+","+(s+8)+"V"+(2*s-8)+"M"+4.5*r+","+(s+8)+"V"+(2*s-8):o+="M"+1*r+","+(s+8)+"V"+(2*s-8),o},s.prototype._click=function(){if(this.selectionLabel()){var e={};e[this.selectionLabel()]=this.data(),this.click(e)}else this.click(this.data())},s.prototype.newSelection=function(e,t){console.log("newSelection:  "+e+", "+t)},s});