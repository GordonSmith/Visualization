(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/Class","../common/PropertyExt","../common/Utility","./HipieDDL","../other/Persist","../layout/Surface","./FlyoutButton"],t):e.marshaller_HipieDDLMixin=t(e.d3,e.common_Class,e.common_PropertyExt,e.common_PropertyExt,e.common_Utility,e.other_Persist,e.layout_Surface,e.marshaller_FlyoutButton)})(this,function(e,t,n,r,i,s,o,u){function a(){t.call(this),n.call(this)}a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype.mixin(n),a.prototype._class+=" marshaller_HipieDDLMixin",a.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),a.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),a.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),a.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),a.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),a.prototype.publish("missingDataString","***MISSING***","string","Missing data display string"),a.prototype._gatherDashboards=function(e,t){t instanceof Object||t&&(t=JSON.parse(t)),this._ddlDashboards=[],this._ddlVisualizations=[],this._ddlPopupVisualizations=[],this._ddlLayerVisualizations=[];var n=this,r=null;e.accept({visit:function(e){e instanceof i.Dashboard?(r={dashboard:e,visualizations:[],layerVisualizations:[],popupVisualizations:[]},n._ddlDashboards.push(r)):e instanceof i.DataSource?e.databomb&&t[e.id]&&e.comms.databomb(t[e.id]):e instanceof i.Output?e.dataSource.databomb&&e.dataSource.comms.databombOutput(e.from,e.id):e instanceof i.Visualization&&e.widget&&(e.properties.flyout?(r.popupVisualizations.push(e),n._ddlPopupVisualizations.push(e)):e.parentVisualization?(r.layerVisualizations.push(e),n._ddlLayerVisualizations.push(e)):(r.visualizations.push(e),n._ddlVisualizations.push(e)))}})},a.prototype._marshallerRender=function(t,n){function c(){var e=!1;l._gatherDashboards(l._marshaller,l.databomb()),l._ddlVisualizations.forEach(function(t){f.remove(t.id),l._marshaller.widgetMappings().get(t.id)||(t.newWidgetSurface=null,t.widget instanceof o||t.widget.classID()==="composite_MegaChart"?t.newWidgetSurface=t.widget:t.newWidgetSurface=(new o).widget(t.widget),t.newWidgetSurface.title(t.title),t.widget.size({width:0,height:0})),e||(e=t.widget.data().length)}),l._ddlPopupVisualizations.forEach(function(e){f.remove(e.id);var t=e.events.getUpdatesVisualizations();t.forEach(function(t){switch(t.widget.classID()){case"composite_MegaChart":var n=(new u).title(e.title).widget(e.widget);t.widget.toolbarWidgets().push(n)}})}),f.forEach(function(e,t){l.clearContent(t)}),l.populateContent(),t.render.call(l,function(t){l._initialState&&(l._marshaller.deserializeState(l._initialState.marshaller),delete l._initialState),e?n&&n(t):l._marshaller.fetchData().then(function(e){n&&n(t)})})}if(this.ddlUrl()===""||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return this._marshaller&&this._marshaller.proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()),t.render.call(this,function(e){n&&n(e)});this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var r=[];s.widgetArrayWalker(this.content(),function(e){r.push(e)});var a=e.map(r,function(e){return e.id()}),f=e.map(r.filter(function(e){return e.id().indexOf(e._idSeed)!==0&&e.id().indexOf("_pe")!==0}),function(e){return e.id()}),l=this;this._marshaller=(new i.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()).widgetMappings(a).on("commsEvent",function(e,t){l.commsEvent.apply(l,arguments)}).on("vizEvent",function(){l.vizEvent.apply(l,arguments)}),this.ddlUrl()[0]==="["||this.ddlUrl()[0]==="{"?this._marshaller.parse(this.ddlUrl(),c):this._marshaller.url(this.ddlUrl(),c)},a.prototype.dashboards=function(){var e={};for(var t in this._marshaller.dashboards)e[t]={},this._marshaller.dashboards[t].visualizations.forEach(function(n){e[t][n.id]=n.widget},this);return e},a.prototype.visualizations=function(){return this._marshaller._visualizationArray.map(function(e){return e.newWidgetSurface||e.widget})};var f="<!doctype html><html><head><meta charset='utf-8'><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz.js'></script><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz-common.js'></script></head><body style='padding:0px; margin:0px; overflow:hidden'><div id='placeholder' style='width:100%; height:100vh'></div><script>   require(['src/other/Persist'], function (Persist) {\n       Persist.create({STATE}, function(widget) {\n           widget\n               .target('placeholder')\n               .ddlUrl('{DDL}')\n               .databomb('{DATABOMB}')\n               .render()\n           ;\n       });\n   });</script></body></html>";return a.prototype.generateTestPage=function(){if(this._marshaller){var e=this,t=s.serialize(e,function(e,t){return t.id==="databomb"||t.id==="ddlUrl"?!0:!1}),n=this._marshaller.createDatabomb(),i=f.replace("{VERSION}",e.version()).replace("{STATE}",t).replace("{DDL}",e._marshaller._json.replace("WUID","databomb")).replace("{DATABOMB}",JSON.stringify(n));r.downloadBlob("html",i,"test")}},a.prototype.vizEvent=function(e,t,n,r,i){},a.prototype.commsEvent=function(e,t,n,r){},a.prototype.serializeState=function(){return{marshaller:this._marshaller?this._marshaller.serializeState():{}}},a.prototype.deserializeState=function(e){return this._marshaller?this._marshaller.deserializeState(e.marshaller):this._initialState=e,this},a});