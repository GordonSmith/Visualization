!function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/FlyoutButton",["../form/Button","../layout/Popup","../layout/Surface"],e):t.marshaller_FlyoutButton=e(t.form_Button,t.layout_Popup,t.layout_Surface)}(this,function(t,e,i){function s(){t.call(this),this.value("^");var s=this;this._popupSurface=(new i).surfaceBackgroundColor("rgb(234, 249, 255)").buttonAnnotations([{id:"",label:"",width:20,padding:"0px 5px","class":"close",font:"FontAwesome"}]).on("click",function(t){"close"===t["class"]&&s._popup.visible(!1).popupState(!1).render()}),this._popup=(new e).size({width:400,height:400}).position("absolute").widget(this._popupSurface)}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,s.prototype._class+=" marshaller_FlyoutButton",s.prototype.publishProxy("title","_popupSurface"),s.prototype.publishProxy("widget","_popupSurface"),s.prototype.publish("autoClose",!0,"boolean","Auto Close"),s.prototype.reference=function(e){var i=(new t).value(this.value()),s=this;return i.click=function(t){s.click()},i},s.prototype.click=function(t){var e=this;this._popup.visible(!0).popupState(!0).render(function(t){var i=e._popupSurface.widget().getBBox();e._popupSurface.resize({width:i.width,height:i.height+e._popupSurface.calcHeight(e._popupSurface.element().select(".surfaceTitle"))+18}),e._popup.render()})},s.prototype.enter=function(e,i){t.prototype.enter.apply(this,arguments);for(var s=this;s&&-1===["marshaller_HTML","marshaller_Graph","composite_MegaChart"].indexOf(s.classID());)s=s.locateParentWidget();s&&(this._popupParentWidget=s,this._popup.target(s.node()))},s.prototype.render=function(e){var i=this,s=this._popup.popupState();t.prototype.render.call(i,function(t){var a=i._popupParentWidget.getBBox(),o=t.getBBox();i._popup.left(o.x-a.x+o.width-i._popup.width()).top(o.y-a.y+o.height).visible(s&&i.autoClose()?!1:s).popupState(s&&i.autoClose()?!1:s).render(),e&&e(t)})},s}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/HipieDDL",["d3","../common/Class","../common/Database","../common/Utility","../other/Comms","../common/Widget","../composite/MegaChart","../chart/MultiChart","../other/Table","require","es6-promise"],e):t.marshaller_HipieDDL=e(t.d3,t.common_Class,t.common_Database,t.common_Utility,t.other_Comms,t.common_Widget,t.composite_MegaChart,t.chart_MultiChart,t.other_Table,t.require)}(this,function(t,e,i,s,a,o,r,n,u,p){function l(t){return t?String.fromCharCode(parseInt(t)):t}function h(t){switch(t){case"bool":case"boolean":return"boolean";case"integer":case"float":case"double":return"number";case"date":case"time":return"time";case"geohash":return"geohash";case"dataset":return"dataset";case"visualization":return"widget";default:if(t){if(0===t.indexOf("unsigned"))return"number";if(0===t.indexOf("integer"))return"number";if(0===t.indexOf("real"))return"number";if(0===t.indexOf("string"))return"string"}}return window.__hpcc_debug&&console.log("unknown hipieType:  "+t),"string"}function c(t,e){this.visualization=t;var i={};for(var s in e)e[s]instanceof Array?e[s].forEach(function(t,e){i[0===e?s:s+"_"+e]=t}):i[s]=e[s];this.mappings=i,this.hasMappings=!1,this.reverseMappings={},this.columns=[],this.columnsIdx={},this.columnsRHS=[],this.columnsRHSIdx={}}function d(t,e){c.call(this,t,e),this.columns=["label","weight"],this.columnsIdx={label:0,weight:1},this.init()}function f(t,e){c.call(this,t,e),e.state?(this.columns=["state","weight"],this.columnsIdx={state:0,weight:1}):e.county?(this.columns=["county","weight"],this.columnsIdx={county:0,weight:1}):e.geohash&&(this.columns=["geohash","weight"],this.columnsIdx={geohash:0,weight:1}),this.init()}function g(t,e){c.call(this,t,e),e.state?(this.columns=["state"],this.columnsIdx={state:0}):e.county?(this.columns=["county"],this.columnsIdx={county:0}):e.geohash&&(this.columns=["geohash","label"],this.columnsIdx={geohash:0,label:1});var i=this.columns.length;e.weight instanceof Array&&e.weight.forEach(function(t,e){this.columns.push(t),this.columnsIdx[0===e?"weight":"weight_"+e]=e+i},this),this.init()}function m(t,e){c.call(this,t,e),this.columns=["x","y","weight"],this.columnsIdx={x:0,y:1,weight:2},this.init()}function y(t,e){var i={label:e.x[0]};e.y.forEach(function(t,e){i[t]=t}),c.call(this,t,i),this.init()}function v(t,e){var i={};for(var s in e)e[s].forEach(function(e,s){i[t.label[s]]=e});c.call(this,t,i),this.init()}function _(t,e,i){c.call(this,t,e),this.icon=t.icon||{},this.fields=t.fields(),this.columns=["uid","label","weight","flags"],this.columnsIdx={uid:0,label:1,weight:2,flags:3},this.init(),this.link=i,this.linkMappings=new c(t,this.link.mappings),this.linkMappings.columns=["uid"],this.linkMappings.columnsIdx={uid:0,label:1},this.visualization=t}function w(t,e){if(this.visualization=t,e){switch(this._id=e.id,this._output=e.output,this.mappings=null,e.mappings||console.log("no mappings for:"+t.id+"->"+e.id),this.visualization.type){case"LINE":this.mappings=new y(this.visualization,e.mappings);break;case"TABLE":this.mappings=new v(this.visualization,e.mappings);break;case"GRAPH":this.mappings=new _(this.visualization,e.mappings,e.link);break;case"CHORO":e.mappings.weight instanceof Array&&e.mappings.weight.length?(this.mappings=new g(this.visualization,e.mappings),e.mappings.weight.length>1&&(this.visualization.type="LINE")):this.mappings=new f(this.visualization,e.mappings);break;case"HEAT_MAP":this.mappings=new m(this.visualization,e.mappings);break;default:this.mappings=new d(this.visualization,e.mappings)}this.first=e.first,this.reverse=e.reverse,this.sort=e.sort,this.properties=e.properties}}function b(t,e,i){this.event=t,this.dashboard=t.visualization.dashboard,this._col=e.col,this._visualization=e.visualization,this._instance=e.instance,this._datasource=e.datasource,this._merge=e.merge,this._mappings=e.mappings||i}function z(t,e,i){this.visualization=t,this.eventID=e,this._updates=[],this._mappings=i.mappings,i&&(this._updates=i.updates.map(function(t){return new b(this,t,i.mappings)},this))}function D(t,e){this.visualization=t,this.events={};for(var i in e)this.events[i]=new z(t,i,e[i])}function x(t){this._id=t.id,this._label=t.label,this._properties=t.properties||{}}function S(t,i,a){switch(e.call(this),this.dashboard=t,this.parentVisualization=a,this.type=i.type,this.id=i.id,this.type){case"TABLE":this.label=i.label;break;case"GRAPH":this.label=i.label,this.icon=i.icon||{faChar:""},this.flags=i.flag||[]}this.title=i.title||i.id,this._fields=(i.fields||[]).map(function(t){return new x(t)}),this._fieldsMap={},this._fields.forEach(function(t){this._fieldsMap[t.id()]=t},this),this.properties=i.properties||(i.source?i.source.properties:null)||{},this.source=new w(this,i.source),this.events=new D(this,i.events),this.layers=[],this.hasVizDeclarations=!1,this.vizDeclarations={},"CHORO"===this.type?this.layers=(i.visualizations||[]).map(function(e){return t.createVisualization(e,this)},this):(i.visualizations||[]).forEach(function(e){this.vizDeclarations[e.id]=t.createVisualization(e,this),this.hasVizDeclarations=!0},this);var o=this;switch(this.type){case"CHORO":var r=i.properties&&i.properties.charttype?i.properties.charttype:"";if(a)switch(r){case"MAP_PINS":this.loadWidget("../map/Pins",function(t){try{t.id(i.id).columns(o.source.getColumns()).geohashColumn("geohash").tooltipColumn("label").fillColor(i.color?i.color:null).projection("albersUsaPr")}catch(e){console.log("Unexpected widget type:  "+t.classID())}})}else r=r||"CHORO","CHORO"===r&&(this.source.mappings.contains("state")?r="CHORO_USSTATES":this.source.mappings.contains("county")?r="CHORO_USCOUNTIES":this.source.mappings.contains("country")&&(r="CHORO_COUNTRIES")),Promise.all(o.layers.map(function(t){return t.loadedPromise()})).then(function(){o.loadWidget("../composite/MegaChart",function(t){var e=o.layers.map(function(t){return t.widget});try{switch(t.classID()){case"composite_MegaChart":t.id(i.id).showChartSelect_default(!1).chartType_default(r).chartTypeDefaults({autoScaleMode:e.length?"data":"mesh"}).chartTypeProperties({layers:e});break;default:t.id(i.id).autoScaleMode(e.length?"data":"mesh").layers(e)}}catch(s){console.log("Unexpected widget type:  "+t.classID())}})});break;case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":this.loadWidget("../composite/MegaChart",function(t){try{t.id(i.id).chartType_default(o.properties.chartType||o.properties.charttype||o.type)}catch(e){console.log("Unexpected widget type:  "+t.classID())}});break;case"LINE":this.loadWidget("../composite/MegaChart",function(t){try{t.id(i.id).chartType_default(o.properties.chartType||o.properties.charttype||o.type)}catch(e){console.log("Unexpected widget type:  "+t.classID())}});break;case"TABLE":this.loadWidget("../composite/MegaChart",function(t){try{t.id(i.id).showChartSelect_default(!1).chartType_default("TABLE")}catch(e){console.log("Unexpected widget type:  "+t.classID())}});break;case"SLIDER":this.loadWidget("../form/Slider",function(t){try{if(t.id(i.id),i.range){var e="";if(s.exists("events.click.updates",i)&&i.events.click.updates.length)for(var a in i.events.click.updates[0].mappings){e=a;break}t.low_default(+i.range[0]).high_default(+i.range[1]).step_default(+i.range[2]).selectionLabel_default(e).selectionLabel(e)}}catch(o){console.log("Unexpected widget type:  "+t.classID())}});break;case"GRAPH":this.loadWidget("../composite/MegaChart",function(t){try{t.id(i.id).showChartSelect_default(!1).chartType_default("GRAPH").chartTypeDefaults({layout:"ForceDirected2",applyScaleOnLayout:!0})}catch(e){console.log("Unexpected widget type:  "+t.classID())}});break;case"FORM":this.loadWidgets(["../form/Form","../form/Input","../form/Button","../form/CheckBox","../form/ColorInput","../form/Radio","../form/Range","../form/Select","../form/Slider","../form/TextArea","../form/InputRange"],function(t,e){var s=e[1],a=e[3],r=e[5],n=e[7],u=e[9],p=e[10];try{t.id(i.id).inputs(o.fields().map(function(t){var e,i=[],o=[];switch(t.charttype()||"range"!==t.type()||t.charttype("RANGE"),t.charttype()){case"TEXT":e=(new s).type_default("text");break;case"TEXTAREA":e=new u;break;case"CHECKBOX":e=new a;break;case"RADIO":e=new r;break;case"HIDDEN":e=(new s).type_default("hidden");break;case"RANGE":e=new p;break;default:if(t.enumvals()){e=new n,o=t.enumvals();for(var l in o)i.push([l,o[l]])}else e=(new s).type_default("text")}if(e.name_default(t.id()).label_default(t.label()).value_default(t["default"]()),e instanceof a||e instanceof r){var h=Object.keys(t.enumvals());e.selectOptions_default(h)}else i.length&&e.selectOptions_default(i);return e}))}catch(l){console.log("Unexpected widget type:  "+t.classID())}});break;case"HEAT_MAP":this.loadWidgets(["../other/HeatMap"],function(t){try{t.id(i.id).image_default(o.properties.imageUrl)}catch(e){console.log("Unexpected widget type:  "+t.classID())}});break;default:this.loadWidget("../common/TextBox",function(t){try{t.id(i.id).text_default(o.id+"\nTODO:  "+o.type)}catch(e){console.log("Unexpected widget type:  "+t.classID())}})}}function M(t,e){this.datasource=t,"string"==typeof e&&(e={fieldid:e,nullable:!0,rule:"=="}),this.fieldid=e.fieldid,this.nullable=e.nullable,this.rule=e.rule||"==",this.minid=e.minid,this.maxid=e.maxid,this.calcRequestFieldID()}function I(t,e){this.datasource=t,this.id=e.id,this.from=e.from,this.notify=e.notify||[],this.filters=(e.filter||[]).map(function(t){return new M(this.datasource,t)},this)}function E(){this.datasourceRequests={}}function R(t){this.skipClear=t,this.visualizationRequests={}}function C(t,e,i,s){this.marshaller=t,this.id=e.id,this.WUID=e.WUID,this.URL=t.espUrl&&t.espUrl.url()?t.espUrl.url():e.URL,this.databomb=e.databomb,this.filters=(e.filter||[]).map(function(t){return new M(this,t)},this),this._loadedCount=0;var o=this;this._outputs={},this._outputArray=[];var r=[];e.outputs.forEach(function(t){var e=new I(o,t);o._outputs[t.id]=e,o._outputArray.push(e),r.push({id:t.id,from:t.from,filters:e.filters||this.filters})},this),this.WUID?this.comms=(new a.HIPIEWorkunit).url(this.URL).proxyMappings(i).timeout(s).hipieResults(r):this.databomb?this.comms=(new a.HIPIEDatabomb).hipieResults(r):this.comms=(new a.HIPIERoxie).url(e.URL).proxyMappings(i).timeout(s).hipieResults(r)}function A(t,e,i,s){this.marshaller=t,this.id=e.id,this.title=e.title,this._datasources={},this._datasourceArray=[],this._datasourceTotal=0,e.datasources&&e.datasources.forEach(function(t){this.createDatasource(t,i,s)},this),this._datasourceTotal=this._datasourceArray.length,this._visualizations={},this._visualizationArray=[],e.visualizations.forEach(function(t){this.createVisualization(t)},this),this._visualizationTotal=this._visualizationArray.length}function O(){e.call(this),this._proxyMappings={},this._widgetMappings=t.map(),this._clearDataOnUpdate=!0,this._propogateClear=!1,this.id="Marshaller",this._missingDataString="",this.dashboards={},this.dashboardArray=[],this._datasources={},this._datasourceArray=[],this._visualizations={},this._visualizationArray=[]}var U="...loading...",V="_changed";c.prototype.init=function(){for(var t in this.mappings)this.reverseMappings[this.mappings[t]]=t,void 0===this.columnsIdx[t]&&(this.columns.push(t),this.columnsIdx[t]=this.columns.length-1),this.columnsRHS[this.columnsIdx[t]]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=this.columnsIdx[t],this.hasMappings=!0},c.prototype.init=function(){for(var t in this.mappings)this.reverseMappings[this.mappings[t]]=t,void 0===this.columnsIdx[t]&&(this.columns.push(t),this.columnsIdx[t]=this.columns.length-1),this.columnsRHS[this.columnsIdx[t]]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=this.columnsIdx[t],this.hasMappings=!0},c.prototype.getFields=function(){return this.visualization.fields()?Object.keys(this.mappings).map(function(t){var e=this.visualization.field(t);return e||console.log("Unknown mapping field:  "+t),new i.Field(e.id()).type(e.jsType()).label(this.reverseMappings[e.id()])},this):null},c.prototype.contains=function(t){return void 0!==this.mappings[t]},c.prototype.doMap=function(t){var e=[];for(var i in this.mappings){var s=this.mappings[i];try{var a=t[s];void 0===a&&(a=t[s.toLowerCase()]),e[this.columnsIdx[i]]=a}catch(o){console.log("Invalid Mapping:  "+this.visualization.id+" ["+s+"->"+t+"]")}}return e},c.prototype.doReverseMap=function(t){var e={};for(var i in this.mappings){var s=this.mappings[i];try{var a=t[i];void 0===a&&(a=t[i.toLowerCase()]),e[s]=a}catch(o){console.log("Invalid Mapping:  "+this.visualization.id+" ["+i+"->"+t+"]")}}return e},c.prototype.doMapAll=function(t){return t.hipieMappings(this.columnsRHS.map(function(t){return this.visualization.field(t)},this),this.visualization.dashboard.marshaller.missingDataString())},c.prototype.getMap=function(t){return this.mappings[t]},c.prototype.getReverseMap=function(t){return this.reverseMappings[t]},c.prototype.hipieMapSortArray=function(t){return t.map(function(t){var e=!1;0===t.indexOf("-")&&(t=t.substring(1),e=!0);var i=this.columnsRHS.indexOf(t);return 0>i&&console.log("SourceMappings.prototype.hipieMapSortArray:  Invalid sort array - "+t),{idx:i,reverse:e}},this).filter(function(t){return t.idx>=0})},d.prototype=Object.create(c.prototype),f.prototype=Object.create(c.prototype),g.prototype=Object.create(c.prototype),m.prototype=Object.create(c.prototype),y.prototype=Object.create(c.prototype),v.prototype=Object.create(c.prototype),v.prototype.init=function(){this.visualization.label.forEach(function(t,e){this.reverseMappings[this.mappings[t]]=t,this.columns.push(t),this.columnsIdx[t]=e,this.columnsRHS[e]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=e,this.hasMappings=!0},this)},v.prototype.doMapAll=function(t){var e=c.prototype.doMapAll.apply(this,arguments);if(e instanceof Array){var i=this.visualization.source.getColumnsRHSIdx();this.visualization.fields().forEach(function(t){var s=t.jsType(),a=i[t.id()];void 0===a?console.log("Invalid Mapping:  "+t.id()):e=e.map(function(e){var i=e[a];if(i&&i.Row&&(i=i.Row),i instanceof Array)switch(s){case"dataset":var o=[],r={},n=i.map(function(t,e){var i=[];i.length=o.length;for(var s in t)0===e&&(r[s]=o.length,o.push(s)),i[r[s]]=t[s];return i}),p=(new u).columns(o).data(n);e[a]=p;break;case"widget":var l=this.visualization.vizDeclarations[t.localVisualizationID()],h=l.source.getOutput(),c=h.db;h.setData(i,[]);var d=l.widget,f=(new d.constructor).showToolbar(!1).chartType(d.chartType()).chartTypeDefaults(d.chartTypeDefaults()).columns(l.source.getColumns()).data(l.source.getData());h.db=c,e[a]=f}return e},this)},this)}return e},_.prototype=Object.create(c.prototype),_.prototype.calcIconInfo=function(t,e,i){function s(t,e){if(t)for(var s in t)switch(s){case"faChar":e.faChar=l(t.faChar);break;default:i&&0===s.indexOf("icon_")?(console.log("Deprecated flag property:  "+s),e[s.split("icon_")[1]]=t[s]):e[s]=t[s]}}var a={};if(e&&e[t.fieldid]&&t.valuemappings){var o=t.valuemappings[e[t.fieldid]];s(o,a)}for(var r in a)return a;return null},_.prototype.doMapAll=function(t){function e(t,e){var i="uid_"+t[0],r=a[i];if(!r&&e){r=(new n.Vertex).faChar(s.icon&&s.icon.faChar?l(s.icon.faChar):"").text(t[1]?t[1]:"").data(t),r.__hpcc_uid=t[0],a[i]=r,o.push(r);var u=s.calcIconInfo(s.visualization.icon,e,!1);if(u)for(var p in u)r[p]&&r[p](u[p]);var h=[];s.visualization.flags.forEach(function(t){var i=s.calcIconInfo(t,e,!0);i&&h.push(i)}),r.annotationIcons(h)}return r}var i=t.jsonObj(),s=this,a={},o=[],r=this.visualization.widget,n=r.chart(),u=[];return i.forEach(function(t){var i=s.doMap(t);e(i,t)}),i.forEach(function(t){var i=s.doMap(t),a=e(i,t);if(t[s.link.childfile]&&t[s.link.childfile]instanceof Array){var o=t[s.link.childfile];o.forEach(function(t,i){var o=s.linkMappings.doMap(t),r=e(o);if(r&&a.id()!==r.id()){var p=(new n.Edge).sourceVertex(a).targetVertex(r).sourceMarker("circle").targetMarker("arrow").text(o[1]?o[1]:"").data(o);u.push(p)}})}}),{vertices:o,edges:u,merge:!1}},w.prototype.getQualifiedID=function(){return this.visualization.getQualifiedID()+"."+this._id},w.prototype.exists=function(){return this._id},w.prototype.getDatasource=function(){return this.visualization.dashboard.getDatasource(this._id)},w.prototype.getOutput=function(){var t=this.getDatasource();return t&&t._outputs?t._outputs[this._output]:null},w.prototype.hasData=function(){return this.getOutput().db?!0:!1},w.prototype.getFields=function(){return this.mappings.getFields()},w.prototype.getColumnsRHS=function(){return this.mappings.columnsRHS},w.prototype.getColumnsRHSIdx=function(){return this.mappings.columnsRHSIdx},w.prototype.getColumns=function(){return this.mappings&&this.mappings.columns?this.mappings.columns:[]},w.prototype.getData=function(){var t=this.getOutput().db,e=this.mappings.doMapAll(t);return e.length&&this.sort&&s.multiSort(e,this.mappings.hipieMapSortArray(this.sort)),this.reverse&&e.reverse(),this.first&&e.length>this.first&&(e.length=this.first),e},w.prototype.getXTitle=function(){return this.mappings.columns[0]},w.prototype.getYTitle=function(){return this.mappings.columns.filter(function(t,e){return e>0}).join(" / ")},w.prototype.getMap=function(t){return this.mappings&&this.mappings.hasMappings?this.mappings.getMap(t):t},w.prototype.getReverseMap=function(t){return this.mappings&&this.mappings.hasMappings?this.mappings.getReverseMap(t):t},b.prototype.getDatasource=function(){return this.dashboard.getDatasource(this._datasource)},b.prototype.getVisualization=function(){return this.dashboard.getVisualization(this._visualization)},b.prototype.mapData=function(t){var e={};if(t)for(var i in this._mappings){var s=this.getReverseMap(i);e[this._mappings[i]]=t[s]}return e},b.prototype.getMap=function(t){return this.event.visualization.source.getMap(t)},b.prototype.getReverseMap=function(t){return this.event.visualization.source.getReverseMap(t)},b.prototype.selectedRow=function(){return this.event.visualization.hasSelection()?this.event.visualization._widgetState.row:{}},b.prototype.mapSelected=function(){return this.mapData(this.selectedRow())},b.prototype.calcRequestFor=function(t){var e={},i=this.getVisualization();return i.getInputVisualizations().forEach(function(s,a){var o=s===t;s.getUpdatesForVisualization(i).forEach(function(t){var i=t.mapSelected();for(var s in i)e[s]&&e[s]!==i[s]?(console.log("Duplicate Filter with mismatched value (defaulting to 'first' or 'first changed' instance):  "+s),o&&(e[s]=i[s],e[s+V]=o)):(e[s]=i[s],e[s+V]=o)})}),e},z.prototype.exists=function(){return this._updates.length},z.prototype.getUpdates=function(){return this._updates.filter(function(t){return t._col?t._col===t.getMap(this.visualization._widgetState.col):!0},this)},z.prototype.getUpdatesDatasources=function(){var t={},e=[];return this.getUpdatesVisualizations().forEach(function(i,s){var a=i.source.getDatasource();a&&!t[a.id]&&(t[a.id]=!0,e.push(a))},this),e},z.prototype.getUpdatesVisualizations=function(){var t={},e=[];return this._updates.forEach(function(i,s){var a=i.getVisualization();t[a.id]||(t[a.id]=!0,e.push(a))},this),e},z.prototype.fetchData=function(){var t=new R;return this.getUpdates().forEach(function(e){t.appendRequest(e.getDatasource(),e.calcRequestFor(this.visualization),e.getVisualization())},this),t.fetchData()},D.prototype.setWidget=function(t){var e=this;for(var i in this.events)t["vertex_"+i]&&(t["vertex_"+i]=function(t,s,a){e.visualization.processEvent(i,e.events[i],t,s,a)}),t[i]&&(t[i]=function(t,s,a){e.visualization.processEvent(i,e.events[i],t,s,a)})},D.prototype.exists=function(){return void 0!==this._updates},D.prototype.getUpdates=function(){var t=[];for(var e in this.events)t=t.concat(this.events[e].getUpdates());return t},D.prototype.getUpdatesDatasources=function(){var t=[];for(var e in this.events)t=t.concat(this.events[e].getUpdatesDatasources());return t},D.prototype.getUpdatesVisualizations=function(){var t=[];for(var e in this.events)t=t.concat(this.events[e].getUpdatesVisualizations());return t},x.prototype=Object.create(e.prototype),x.prototype.constructor=x,x.prototype.id=function(){return this._id},x.prototype.label=function(){return this._properties.label||this._label},x.prototype.type=function(){return this._properties.type||""},x.prototype.jsType=function(){return h(this.type())},x.prototype.charttype=function(t){return arguments.length?(this._properties.charttype=t,this):this._properties.charttype||""},x.prototype.localVisualizationID=function(){return this._properties.localVisualizationID||""},x.prototype.enumvals=function(){return this._properties.enumvals},x.prototype.hasDefault=function(){return void 0!==this["default"]()},x.prototype["default"]=function(){return"range"===this.type()?this._properties["default"]||["",""]:this._properties["default"]instanceof Array&&this._properties["default"].length?this._properties["default"][0]:this._properties["default"]||""},x.prototype.hasFunction=function(){return void 0!==this["function"]()},x.prototype["function"]=function(){return this._properties["function"]},x.prototype.params=function(){var t=[],e=this._properties.params||{};for(var i in e)t.push(e[i]);return t},x.prototype.properties=function(){return this._properties},S.prototype=Object.create(e.prototype),S.prototype.constructor=S,S.prototype.getQualifiedID=function(){return this.id},S.prototype.fields=function(){return this._fields},S.prototype.hasField=function(t){return void 0!==this.field[t]},S.prototype.field=function(t){return this._fieldsMap[t]},S.prototype.loadedPromise=function(){var t=this;return new Promise(function(e,i){var s=setInterval(function(){t.isLoaded()&&(clearInterval(s),e())},100)})},S.prototype.isLoading=function(){return null===this.widget},S.prototype.isLoaded=function(){return this.widget instanceof o},S.prototype.loadMegaChartWidget=function(t,e){this.loadWidgets(["../composite/MegaChart",t],function(t,i){var s=new i[1];t.chartType_default(n.prototype._allChartTypesByClass[s.classID()].id).chart(s),e&&e(t,s,i)})},S.prototype.loadWidget=function(t,e){this.loadWidgets([t],e)},S.prototype.loadWidgets=function(t,e){this.widget=null;var i=this;p(t,function(t){var s=i.dashboard.marshaller.getWidget(i.id);s?(t.prototype._class!==s.classID()&&console.log("Unexpected persisted widget type (old persist string?)"),i.setWidget(s)):i.setWidget(new t),e&&e(i.widget,arguments)})},S.prototype.setWidget=function(t){if(this.widget=t,this.events.setWidget(t),this.widget.columns){var e=this.source.getColumns();this.widget.columns(e,!0)}for(var i in this.properties)switch(t.classID()){case"chart_MultiChart":case"composite_MegaChart":t[i+"_default"]&&t[i+"_default"](this.properties[i]),t.chartTypeDefaults()[i]=this.properties[i];break;default:if(this.widget[i+"_default"])try{this.widget[i+"_default"](this.properties[i])}catch(s){console.log("Invalid Property:"+this.id+".properties."+i)}}return this.widget},S.prototype.accept=function(t){t.visit(this)},S.prototype.getUpdates=function(){return this.events.getUpdates()},S.prototype.getUpdatesForDatasource=function(t){return this.events.getUpdates().filter(function(e){return e.getDatasource()===t})},S.prototype.getUpdatesForVisualization=function(t){return this.events.getUpdates().filter(function(e){return e.getVisualization()===t})},S.prototype.getInputFields=function(t){var e={},i=this.getInputVisualizations();return i.forEach(function(i){i.hasSelection()&&i.getUpdatesForVisualization(this).forEach(function(i){var s=t?i.mapSelected():i.selectedRow();for(var a in s)e[a]=s[a]})},this),e},S.prototype.update=function(t){var e=null;if(!this.parentVisualization)for(e=this.widget;e&&!e.title;)e=e.locateParentWidget();if(!t){t="";var i="";e&&e.ddlParamsFormat&&(i=e.ddlParamsFormat());var a={};if(i)t=s.template(i,this.getInputFields());else{var o=[],r=this.getInputFields(!0);for(var n in r)r[n]&&(a[n]||(a[n]=!0,o.push(r[n])));t=o.join(", ")}}var u=this;return new Promise(function(i,s){if(e){var a=e.title(),o=a.split(" (");e.title(o[0]+(t.trim()?" ("+t+")":"")).render(function(){i()})}else{for(var r=u;r.parentVisualization;)r=r.parentVisualization;r.widget.render(function(){i()})}u.dashboard.marshaller.propogateClear()&&u.events.getUpdatesVisualizations().forEach(function(t){t.update()})})},S.prototype.notify=function(){if(this.widget){var t=this.source.hasData()?this.source.getData():[];if(this.widget.data(t),"GRAPH"===this.type&&t.vertices){var e=this.getInputFields(!0);t.vertices.filter(function(t){return t.__hpcc_uid===e.treeuid}).forEach(function(t){t.centroid(!0)})}return this.update()}return Promise.resolve()},S.prototype.clear=function(){this._widgetState={row:{},selected:!1},this.fields().forEach(function(t){t.hasDefault()&&(this._widgetState.row[t.id()]=t["default"](),this._widgetState.selected=!0)},this),this.widget&&this.dashboard.marshaller.clearDataOnUpdate()&&this.widget.data([]),this.dashboard.marshaller.propogateClear()&&this.events.getUpdatesVisualizations().forEach(function(t){t.clear()})},S.prototype.on=function(t,e){var i=this;return this.overrideMethod(t,function(t,s){t.apply(i,s),setTimeout(function(){e.apply(i,s)},0)}),this},S.prototype.calcRequestFor=function(t){var e={};return this.getUpdatesForVisualization(t).forEach(function(i){e=i.calcRequestFor(t)}),e},S.prototype.processEvent=function(t,e,i,s,a){this._widgetState={row:i,col:s,selected:void 0===a?!0:a};var o=this;setTimeout(function(){e.fetchData().then(function(e){o.dashboard.marshaller.vizEvent(o.widget,"post_"+t,i,s,a)})},0)},S.prototype.hasSelection=function(){return this._widgetState&&this._widgetState.selected},S.prototype.selection=function(){return this.hasSelection()?this._widgetState.row:null},S.prototype.reverseMappedSelection=function(){return this.hasSelection()?this.source.mappings?this.source.mappings.doReverseMap(this._widgetState.row):this._widgetState.row:null},S.prototype.getInputVisualizations=function(){return this.dashboard.marshaller.getVisualizationArray().filter(function(t){var e=t.events.getUpdatesVisualizations();return e.indexOf(this)>=0?!0:!1},this)},S.prototype.serializeState=function(){var t={widgetState:this._widgetState};return this.widget&&(this.widget.serializeState?t.widget=this.widget.serializeState():this.widget.data&&(t.widget={data:this.widget.data()})),t},S.prototype.deserializeState=function(t){return t&&(this._widgetState=t.widgetState,this.widget&&t.widget&&(this.widget.deserializeState?this.widget.deserializeState(t.widget):this.widget.data&&t.widget.data&&this.widget.data(t.widget.data))),this},M.prototype.calcRequestFieldID=function(){switch(this._requestFieldID=this.fieldid,this._requestMinID=this.minid,this._requestMaxID=this.maxid,this.rule){case"<":case"<=":s.endsWith(this.fieldid,"-max")&&(this._requestFieldID=this.fieldid.substring(0,this.fieldid.length-4)+(this.datasource.isRoxie()?"_max":""));break;case">":case">=":s.endsWith(this.fieldid,"-min")&&(this._requestFieldID=this.fieldid.substring(0,this.fieldid.length-4)+(this.datasource.isRoxie()?"_min":""));break;case"set":s.endsWith(this.fieldid,"-set")&&(this._requestFieldID=this.fieldid.substring(0,this.fieldid.length-4)+(this.datasource.isRoxie()?"_set":""));break;case"range":s.endsWith(this.minid,"-min")&&(this._requestMinID=this.minid.substring(0,this.minid.length-4)+(this.datasource.isRoxie()?"_min":"")),s.endsWith(this.maxid,"-max")&&(this._requestMaxID=this.maxid.substring(0,this.maxid.length-4)+(this.datasource.isRoxie()?"_max":""))}},M.prototype.isRange=function(){return"range"===this.rule},M.prototype.isSet=function(){return"set"===this.rule},M.prototype._calcRequest=function(t,e,i,s,a){this.datasource.isRoxie()||(s=i),t[s+V]=e[i+V]||!1,t[s]!==a&&(t[s]=a)},M.prototype.calcRequest=function(t,e,i){if(i||void 0!==e[this.fieldid]){var s=void 0===e[this.fieldid]?null:e[this.fieldid];this.isRange()?s instanceof Array&&2===s.length&&(this._calcRequest(t,e,this.minid,this._requestMinID,s[0]),this._calcRequest(t,e,this.maxid,this._requestMaxID,s[1])):(this._calcRequest(t,e,this.fieldid,this._requestFieldID,s),this.isSet()&&this.datasource.isRoxie()&&(t[this._requestFieldID+".Item$"]=t[this._requestFieldID],delete t[this._requestFieldID]))}},M.prototype.matches=function(t,e){if(void 0===e||null===e||""===e)return this.nullable;var i=t[this._requestFieldID];if(void 0===i&&(i=t[this._requestFieldID.toLowerCase()]),void 0===i)return console.log("Empty cell value:  '"+this._requestFieldID+"'"),!1;switch(this.rule){case"<":return i.localeCompare?i.localeCompare(e)<0:e>i;case">":return i.localeCompare?i.localeCompare(e)>0:i>e;case"<=":return i.localeCompare?i.localeCompare(e)<=0:e>=i;case">=":return i.localeCompare?i.localeCompare(e)>=0:i>=e;case"!=":case"notequals":return i!=e;case"set":return e instanceof Array?e.indexOf(i)>=0:e==i;case"==":return e==i;default:return console.log("Unknown filter rule:  '"+this.rule+"'"),e==i}return!1},I.prototype.getQualifiedID=function(){return this.datasource.getQualifiedID()+"."+this.id},I.prototype.getUpdatesVisualizations=function(){var t=[];return this.notify.forEach(function(e){t.push(this.datasource.marshaller.getVisualization(e))},this),t},I.prototype.accept=function(t){t.visit(this)},I.prototype.vizNotify=function(t){var e=[];return this.notify.filter(function(e){return!t||t.indexOf(e)>=0}).forEach(function(t){var i=this.datasource.marshaller.getVisualization(t);e.push(i.notify())},this),Promise.all(e)},I.prototype.setData=function(t,e){return this.db=(new i.Grid).jsonObj(t),this.vizNotify(e)},E.prototype.appendRequest=function(t,e,i){var s=t.id+"("+JSON.stringify(e)+")";this.datasourceRequests[s]?window.__hpcc_debug&&console.log("Optimized duplicate fetch:  "+s):this.datasourceRequests[s]={updateDatasource:t,request:e,updates:[]};var a=this.datasourceRequests[s];a.updates.indexOf(i.id)<0&&a.updates.push(i.id)},E.prototype.fetchData=function(){var t=[];for(var e in this.datasourceRequests){var i=this.datasourceRequests[e];t.push(i.updateDatasource.fetchData(i.request,i.updates))}return Promise.all(t)},R.prototype.appendRequest=function(t,e,i){if(t&&i){var a=i.id+"("+t.id+")";this.visualizationRequests[a]?window.__hpcc_debug&&console.log("Optimized duplicate fetch:  "+a):this.visualizationRequests[a]={
updateVisualization:i,updateDatasource:t,request:{}};var o=this.visualizationRequests[a];s.mixin(o.request,e)}},R.prototype.fetchData=function(){var t=new E;for(var e in this.visualizationRequests){var i=this.visualizationRequests[e];this.skipClear||"GRAPH"===i.updateVisualization.type||i.updateVisualization.clear(),i.updateVisualization.update(U),t.appendRequest(i.updateDatasource,i.request,i.updateVisualization)}return t.fetchData()},C.prototype.isRoxie=function(){return!(this.isWU()||this.isDatabomb())},C.prototype.isWU=function(){return!!this.WUID},C.prototype.isDatabomb=function(){return!!this.databomb},C.prototype.getQualifiedID=function(){return this.id},C.prototype.getOutputs=function(){return this._outputs},C.prototype.getUpdatesVisualizations=function(){var t=[];for(var e in this._outputs)this._outputs[e].getUpdatesVisualizations().forEach(function(e){t.push(e)});return t},C.prototype.accept=function(t){t.visit(this);for(var e in this._outputs)this._outputs[e].accept(t)},C.prototype.calcRequest=function(t,e){var i={};return this.filters.forEach(function(s){s.calcRequest(i,t,e)}),this._outputArray.forEach(function(s){s.filters.forEach(function(s){s.calcRequest(i,t,e)})}),i};var T=0,P=[];return C.prototype.fetchData=function(t,e){var i=++T;P.push(i);var s=t;s=this.calcRequest(t,this.isRoxie()),s.refresh=t.refresh||!1,window.__hpcc_debug&&console.log("fetchData:  "+JSON.stringify(e)+"("+JSON.stringify(t)+")");for(var a in s)void 0===s[a]&&delete s[a];var o=Date.now();this.marshaller.commsEvent(this,"request",s);var r=this;return new Promise(function(t,a){r.comms.call(s).then(function(a){var n=JSON.parse(JSON.stringify(a)),u=setInterval(function(){P[0]===i&&Date.now()-o>=500&&(clearTimeout(u),r.processResponse(n,s,e).then(function(){P.shift(),t(n),r.marshaller.commsEvent(r,"response",s,n),++r._loadedCount}))},100)})["catch"](function(t){r.marshaller.commsEvent(r,"error",s,t),a(t)})})},C.prototype.processResponse=function(t,e,i){var a={};for(var o in t)a[o.toLowerCase()]=t[o];var r=[];for(var n in this._outputs){var u=this._outputs[n].id;if(s.exists(u,t))!s.exists(u+V,t)||s.exists(u+V,t)&&t[u+V].length&&t[u+V][0][u+V]?r.push(this._outputs[n].setData(t[u],i)):r.push(this._outputs[n].vizNotify(i));else if(s.exists(u,a))console.log("DDL 'Datasource.From' case is Incorrect"),!s.exists(u+V,a)||s.exists(u+V,a)&&t[u+V].length&&a[u+V][0][u+V]?r.push(this._outputs[n].setData(a[u],i)):r.push(this._outputs[n].vizNotify(i));else{var p=[];for(var l in t)p.push(l);console.log("Unable to locate '"+u+"' in response {"+p.join(", ")+"}")}}return Promise.all(r)},C.prototype.isLoaded=function(){return this._loadedCount>0},C.prototype.isRoxie=function(){return!this.WUID&&!this.databomb},C.prototype.serializeState=function(){return{}},C.prototype.deserializeState=function(t){},A.prototype.createDatasource=function(t){var e=this._datasources[t.id];return e||(e=this.marshaller.createDatasource(t),this._datasources[t.id]=e,this._datasourceArray.push(e)),this._datasourceTotal=this._datasourceArray.length,e},A.prototype.createVisualization=function(t,e){var i=new S(this,t,e);return this._visualizations[t.id]=i,this._visualizationArray.push(i),this.marshaller.appendVisualization(i),i},A.prototype.loadedPromise=function(){return Promise.all(this._visualizationArray.map(function(t){return t.loadedPromise()}))},A.prototype.getQualifiedID=function(){return this.id},A.prototype.getDatasources=function(){return this._datasources},A.prototype.getDatasourceArray=function(){return this._datasourceArray},A.prototype.getDatasource=function(t){return this._datasources[t]||this.marshaller.getDatasource(t)},A.prototype.getDataSourceArray=function(){return this._datasourceArray},A.prototype.getVisualization=function(t){return this._visualizations[t]||this.marshaller.getVisualization(t)},A.prototype.getVisualizations=function(){return this._visualizations},A.prototype.getVisualizationArray=function(){return this._visualizationArray},A.prototype.getVisualizationTotal=function(){return this._visualizationTotal},A.prototype.accept=function(t){t.visit(this);for(var e in this._datasources)this._datasources[e].accept(t);this._visualizationArray.forEach(function(e){e.accept(t)},this)},A.prototype.primeData=function(t){var e=new R(!0);return this.getVisualizationArray().forEach(function(e){if(e.clear(),e.update(),t&&t[e.id]&&s.exists("source.mappings.mappings",e))for(var i in e.source.mappings.mappings)t[e.id][e.source.mappings.mappings[i]]&&(e._widgetState.row[i]=t[e.id][e.source.mappings.mappings[i]],e._widgetState.selected=!0)}),this.getVisualizationArray().forEach(function(t){var i=t.getInputVisualizations(),s=t.source.getDatasource(),a=!1;i.forEach(function(i){if(i.hasSelection()){var o=i.calcRequestFor(t);o.refresh=!0,e.appendRequest(s,o,t),a=!0}}),!a&&(s&&s.isRoxie()||0===i.length)&&e.appendRequest(s,{refresh:!0},t)}),e.fetchData()},A.prototype.serializeState=function(){var t={datasources:{},visualizations:{}};for(var e in this._datasources)t.datasources[e]=this._datasources[e].serializeState();for(var i in this._visualizations)t.visualizations[i]=this._visualizations[i].serializeState();return t},A.prototype.deserializeState=function(t){if(t){for(var e in this._datasources)t.datasources[e]&&this._datasources[e].deserializeState(t.datasources[e]);for(var i in this._visualizations)t.visualizations[i]&&this._visualizations[i].deserializeState(t.visualizations[i])}},O.prototype=Object.create(e.prototype),O.prototype.constructor=O,O.prototype.commsDataLoaded=function(){for(var t=0;t<this.dashboardArray.length;t++)for(var e in this.dashboardArray[t].getDatasources())if(!this.dashboardArray[t].getDatasource(e).isLoaded())return!1;return!0},O.prototype.accept=function(t){t.visit(this);for(var e in this._datasources)this._datasources[e].accept(t);this.dashboardTotal=0;for(var i in this.dashboards)this.dashboards[i].accept(t),++this.dashboardTotal},O.prototype.url=function(t,e){this.espUrl=(new a.ESPUrl).url(t);var i=null,o="HIPIE_DDL";this.espUrl.isWorkunitResult()?(o=this.espUrl.param("ResultName"),i=(new a.HIPIEWorkunit).url(t).proxyMappings(this._proxyMappings).timeout(this._timeout)):i=(new a.HIPIERoxie).url(t).proxyMappings(this._proxyMappings).timeout(this._timeout);var r=this;i.fetchResults().then(function(t){return s.exists(o,t)?i.fetchResult(o).then(function(i){var s=i[0][o];r.parse(s,function(){e(t)})})["catch"](function(t){r.commsEvent(r,"error",o,t)}):void 0})["catch"](function(t){r.commsEvent(r,"error","fetchResults",t)})},O.prototype.proxyMappings=function(t){return arguments.length?(this._proxyMappings=t,this):this._proxyMappings},O.prototype.timeout=function(t){return arguments.length?(this._timeout=t,this):this._timeout},O.prototype.widgetMappings=function(t){return arguments.length?(this._widgetMappings=t,this):this._widgetMappings},O.prototype.clearDataOnUpdate=function(t){return arguments.length?(this._clearDataOnUpdate=t,this):this._clearDataOnUpdate},O.prototype.propogateClear=function(t){return arguments.length?(this._propogateClear=t,this):this._propogateClear},O.prototype.missingDataString=function(t){return arguments.length?(this._missingDataString=t,this):this._missingDataString},O.prototype.parse=function(t,e){var i=this;this._json=t,this._jsonParsed=JSON.parse(this._json),this._datasources={},this._datasourceArray=[],this._jsonParsed.datasources&&this._jsonParsed.datasources.forEach(function(t){i.createDatasource(t)}),this.dashboards={},this.dashboardArray=[],this._visualizations={},this._visualizationArray=[];var s=this._jsonParsed.dashboards||this._jsonParsed;return s.forEach(function(t){var e=new A(i,t,i._proxyMappings,i._timeout);i.dashboards[t.id]=e,i.dashboardArray.push(e)}),this.dashboardTotal=this.dashboardArray.length,this._visualizationArray.forEach(function(t){t.on("processEvent",function(e,s,a,o,r){i.vizEvent(t.widget,e,a,o,r)})}),this._datasourceTotal=this._datasourceArray.length,this.ready(e),this},O.prototype.dashboardsLoaded=function(){return Promise.all(this.dashboardArray.map(function(t){return t.loadedPromise()}))},O.prototype.createDatasource=function(t){var e=this._datasources[t.id];return e||(e=new C(this,t,this._proxyMappings,this._timeout),this._datasources[t.id]=e,this._datasourceArray.push(e)),this._datasourceTotal=this._datasourceArray.length,e},O.prototype.getDatasource=function(t){return this._datasources[t]},O.prototype.getDatasources=function(){return this._datasources},O.prototype.getDatasourceArray=function(){return this._datasourceArray},O.prototype.appendVisualization=function(t){this._visualizations[t.id]=t,this._visualizationArray.push(t)},O.prototype.getVisualization=function(t){return this._visualizations[t]},O.prototype.appendDataSource=function(t){this._datasources[t.id]=t,this._datasourceArray.push(t)},O.prototype.getVisualizations=function(){return this._visualizations},O.prototype.getVisualizationArray=function(){return this._visualizationArray},O.prototype.getWidget=function(t){return this._widgetMappings.get(t)},O.prototype.on=function(t,e){var i=this;return this.overrideMethod(t,function(t,s){var a=t.apply(i,s);return e.apply(i,s)||a}),this},O.prototype.ready=function(t){t&&this.dashboardsLoaded().then(function(){t()})},O.prototype.vizEvent=function(t,e,i,s,a){console.log("Marshaller.vizEvent:  "+t.id()+"-"+e)},O.prototype.commsEvent=function(t,e,i,s){switch(e){case"request":window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+t.id+"-"+e+":  "+JSON.stringify(i));break;case"response":case"error":window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+t.id+"-"+e+":  "+JSON.stringify(s));break;default:window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+JSON.stringify(arguments))}},O.prototype.createDatabomb=function(){var t={};return this.dashboardArray.forEach(function(e){for(var i in e.getDatasources()){var s=e.getDatasource(i).comms;t[i]={};for(var a in s._hipieResults){var o=s._hipieResults[a];t[i][a]=s._resultNameCache[o.from]}}}),t},O.prototype.primeData=function(t){var e=this.dashboardArray.map(function(e){return e.primeData(t)});return Promise.all(e)},O.prototype.serializeState=function(){var t={};return this.dashboardArray.forEach(function(e,i){t[e.id]=e.serializeState()}),t},O.prototype.deserializeState=function(t){return t?(this.dashboardArray.forEach(function(e,i){e.deserializeState(t[e.id])}),this):void 0},{Marshaller:O,Dashboard:A,Datasource:C,Output:I,Visualization:S}}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/HipieDDLMixin",["d3","../common/Class","../common/PropertyExt","../common/Utility","./HipieDDL","../other/Persist","../layout/Surface","./FlyoutButton"],e):t.marshaller_HipieDDLMixin=e(t.d3,t.common_Class,t.common_PropertyExt,t.common_PropertyExt,t.common_Utility,t.other_Persist,t.layout_Surface,t.marshaller_FlyoutButton)}(this,function(t,e,i,s,a,o,r,n){function u(){e.call(this),i.call(this)}u.prototype=Object.create(e.prototype),u.prototype.constructor=u,u.prototype.mixin(i),u.prototype._class+=" marshaller_HipieDDLMixin",u.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),u.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),u.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),u.prototype.publish("timeout",null,"number","Timout (seconds)",null,{optional:!0}),u.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),u.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),u.prototype.publish("missingDataString","***MISSING***","string","Missing data display string"),u.prototype.publish("autoCloseFlyout",!0,"boolean","Auto Close Flyout Filters"),u.prototype._gatherDashboards=function(t,e){e instanceof Object||e&&(e=JSON.parse(e)),this._ddlDashboards=[],this._ddlVisualizations=[],this._ddlPopupVisualizations=[],this._ddlLayerVisualizations=[];var i=this,s=null;t.accept({visit:function(t){t instanceof a.Dashboard?(s={dashboard:t,visualizations:[],layerVisualizations:[],popupVisualizations:[]},i._ddlDashboards.push(s)):t instanceof a.Datasource?t.databomb&&e[t.id]&&t.comms.databomb(e[t.id]):t instanceof a.Output?t.datasource.databomb&&t.datasource.comms.databombOutput(t.from,t.id):t instanceof a.Visualization&&t.widget&&(t.properties.flyout?(s.popupVisualizations.push(t),i._ddlPopupVisualizations.push(t)):t.parentVisualization?(s.layerVisualizations.push(t),i._ddlLayerVisualizations.push(t)):(s.visualizations.push(t),i._ddlVisualizations.push(t)))}})},u.prototype._marshallerRender=function(e,i){function s(){h._gatherDashboards(h._marshaller,h.databomb()),h._ddlVisualizations.forEach(function(t){l.remove(t.id),h._marshaller.widgetMappings().get(t.id)||(t.newWidgetSurface=null,t.widget instanceof r||"composite_MegaChart"===t.widget.classID()?t.newWidgetSurface=t.widget:t.newWidgetSurface=(new r).widget(t.widget),t.newWidgetSurface.title(t.title),t.widget.size({width:0,height:0}))}),h._ddlPopupVisualizations.forEach(function(t){l.remove(t.id),t.widget.classed({flyout:!0});var e=t.events.getUpdatesVisualizations();e.forEach(function(e){switch(e.widget.classID()){case"composite_MegaChart":t._flyoutButton?e.widget.toolbarWidgets().push(t._flyoutButton.reference()):(t._flyoutButton=(new n).classed({"composite_MegaChart-flyout":!0}).title(t.title).widget(t.widget).autoClose(h.autoCloseFlyout()),e.widget.toolbarWidgets().push(t._flyoutButton))}})}),l.forEach(function(t,e){h.clearContent(e)}),h.populateContent(),h._initialState?(h._marshaller.deserializeState(h._initialState.marshaller),delete h._initialState,e.render.call(h,i)):e.render.call(h,function(t){h._marshaller.primeData().then(function(e){i&&i(t)})})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return this._marshaller&&this._marshaller.proxyMappings(this.proxyMappings()).timeout(this.timeout()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()),e.render.call(this,function(t){i&&i(t)});this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var u=[];o.widgetArrayWalker(this.content(),function(t){u.push(t)});var p=t.map(u,function(t){return t.id()}),l=t.map(u.filter(function(t){return 0!==t.id().indexOf(t._idSeed)&&0!==t.id().indexOf("_pe")}),function(t){return t.id()}),h=this;this._marshaller=(new a.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()).widgetMappings(p).on("commsEvent",function(t,e){h.commsEvent.apply(h,arguments)}).on("vizEvent",function(){h.vizEvent.apply(h,arguments)}),"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this._marshaller.parse(this.ddlUrl(),s):this._marshaller.url(this.ddlUrl(),s)},u.prototype.primeData=function(t){return this._marshaller?this._marshaller.primeData(t):Promise.resolve()},u.prototype.dashboards=function(){var t={};for(var e in this._marshaller.dashboards)t[e]={},this._marshaller.dashboards[e].visualizations.forEach(function(i){t[e][i.id]=i.widget},this);return t},u.prototype.visualizations=function(){return this._marshaller._visualizationArray.map(function(t){return t.newWidgetSurface||t.widget})};var p="<!doctype html><html><head><meta charset='utf-8'><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz.js'></script><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz-common.js'></script></head><body style='padding:0px; margin:0px; overflow:hidden'><div id='placeholder' style='width:100%; height:100vh'></div><script>   require(['src/other/Persist'], function (Persist) {\n       Persist.create({STATE}, function(widget) {\n           widget\n               .target('placeholder')\n               .ddlUrl('{DDL}')\n               .databomb('{DATABOMB}')\n               .render()\n           ;\n       });\n   });</script></body></html>";return u.prototype.generateTestPage=function(){if(this._marshaller){var t=this,e=o.serialize(t,function(t,e){return"databomb"===e.id||"ddlUrl"===e.id?!0:!1}),i=this._marshaller.createDatabomb(),a=p.replace("{VERSION}",t.version()).replace("{STATE}",e).replace("{DDL}",t._marshaller._json.replace("WUID","databomb")).replace("{DATABOMB}",JSON.stringify(i));s.downloadBlob("html",a,"test")}},u.prototype.vizEvent=function(t,e,i,s,a){},u.prototype.commsEvent=function(t,e,i,s){},u.prototype.state=function(t){return arguments.length?(this.deserializeState(t),this):this.serializeState()},u.prototype.serializeState=function(){return{marshaller:this._marshaller?this._marshaller.serializeState():{}}},u.prototype.deserializeState=function(t){return this._marshaller?this._marshaller.deserializeState(t.marshaller):this._initialState=t,this},u.prototype.serializeRequests=function(){var t=null;return this._ddlPopupVisualizations.concat(this._ddlVisualizations).forEach(function(e){e.hasSelection()&&(t||(t={}),t[e.id]=e.reverseMappedSelection())}),t},u}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/Graph",["d3","../common/SVGWidget","../common/TextBox","../common/Surface","../common/ResizeSurface","../chart/MultiChartSurface","../common/Palette","../graph/Graph","../graph/Vertex","../graph/Edge","./HipieDDLMixin"],e):t.marshaller_Graph=e(t.d3,t.common_SVGWidget,t.common_TextBox,t.common_Surface,t.common_ResizeSurface,t.chart_MultiChartSurface,t.common_Palette,t.graph_Graph,t.graph_Vertex,t.graph_Edge,t.marshaller_HipieDDLMixin)}(this,function(t,e,i,s,a,o,r,n,u,p,l){function h(){n.call(this),l.call(this),this._design_mode=!1,this._dashboards=[],this.graphAttributes=["snapToGrid","showEdges"],this.widgetAttributes=["layout","chartType","palette","title","columns","data"],this.layout("Hierarchy"),this.applyScaleOnLayout(!0),this.content([])}return h.prototype=Object.create(n.prototype),h.prototype.constructor=h,h.prototype.mixin(l),h.prototype._class+=" marshaller_Graph",h.prototype.publish("content",[],"widgetArray","widgets",null,{tags:["Basic"]}),h.prototype.populateContent=function(){var t=[],e=[];this._ddlVisualizations.concat(this._ddlPopupVisualizations).forEach(function(e){if(e.widget){var i=null;if(e.widget instanceof a)i=e.widget.size({width:210,height:210});else{var s=280,o=210;i=(new a).showTitle(!0).size({width:s,height:o}).content(e.widget)}i&&(e.newWidgetSurface=i),t.push(i)}e.getInputVisualizations().forEach(function(){},this)},this),this._ddlDashboards.forEach(function(t){t.visualizations.forEach(function(t){t.getInputVisualizations().forEach(function(i){e.push((new p).sourceVertex(i.newWidgetSurface).targetVertex(t.newWidgetSurface).targetMarker("arrowHead"))},this)},this)},this),this.content(t),this.data({vertices:t,edges:e})},h.prototype.enter=function(t,e){n.prototype.enter.apply(this,arguments),e.classed("graph_Graph",!0)},h.prototype.render=function(t){return this._marshallerRender(n.prototype,t),this},h.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},h}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/HTML",["d3","../layout/Grid","./HipieDDLMixin"],e):t.marshaller_HTML=e(t.d3,t.layout_Grid,t.marshaller_HipieDDLMixin)}(this,function(t,e,i){function s(){e.call(this),i.call(this),this.surfacePadding_default(0)}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.mixin(i),s.prototype._class+=" marshaller_HTML",s.prototype.populateContent=function(){var t=0,e=0,i=3;this._ddlDashboards.forEach(function(s){var a=Math.floor(Math.sqrt(s.visualizations.length));s.visualizations.forEach(function(s){if(s.newWidgetSurface){for(;null!==this.getCell(t*i,e*i);)e++,e%a===0&&(t++,e=0);this.setContent(t*i,e*i,s.newWidgetSurface,"",i,i)}},this)},this);var s={};this.content().forEach(function(t){var e=t.widget();e&&"layout_Surface"===e.classID()&&(e=e.widget()),e&&(s[e.id()]=t)}),this._ddlDashboards.forEach(function(t){t.visualizations.forEach(function(t,e){if(!t.properties.flyout&&!t.parentVisualization){var i=t.events.getUpdatesVisualizations(),a=i.filter(function(t){return s[t.id]}).map(function(t){return s[t.id].id()});s[t.id].indicateTheseIds(a)}})},this)},s.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments)},s.prototype.render=function(t){return this._marshallerRender(e.prototype,t),this},s.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},s}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/Tabbed",["d3","../layout/Tabbed","../layout/Grid","./HipieDDLMixin"],e):t.marshaller_Tabbed=e(t.d3,t.layout_Tabbed,t.layout_Grid,t.marshaller_HipieDDLMixin)}(this,function(t,e,i,s){function a(){e.call(this),s.call(this),this.surfacePadding_default(0)}return a.prototype=Object.create(e.prototype),a.prototype.constructor=a,a.prototype.mixin(s),a.prototype._class+=" marshaller_Tabbed",a.prototype.content=function(){var t=[];return this.widgets().forEach(function(e){var i=e.widget();i.content().forEach(function(e){t.push(e)})}),t},a.prototype.populateContent=function(){var t=3;this._ddlDashboards.forEach(function(e){var s=(new i).surfacePadding(0);this.addTab(s,e.dashboard.title);var a=0,o=0,r=Math.floor(Math.sqrt(e.visualizations.length));e.visualizations.forEach(function(e){if(e.newWidgetSurface){for(;null!==s.getCell(a*t,o*t);)o++,o%r===0&&(a++,o=0);s.setContent(a*t,o*t,e.newWidgetSurface,"",t,t)}},this)},this);var e={};this.content().forEach(function(t){var i=t.widget();i&&"layout_Surface"===i.classID()&&(i=i.widget()),i&&(e[i.id()]=t)}),this._ddlDashboards.forEach(function(t){t.visualizations.forEach(function(t,i){if(!t.properties.flyout&&!t.parentVisualization){var s=t.events.getUpdatesVisualizations(),a=s.filter(function(t){return e[t.id]}).map(function(t){return e[t.id].id()});e[t.id].indicateTheseIds(a)}})},this)},a.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments)},a.prototype.render=function(t){return this._marshallerRender(e.prototype,t),this},a.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},a}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/TargetMarshaller",["d3","../common/HTMLWidget","./HipieDDLMixin"],e):t.marshaller_TargetMarshaller=e(t.d3,t.common_HTMLWidget,t.marshaller_HipieDDLMixin)}(this,function(t,e,i){function s(){e.call(this),i.call(this),this._tag="div"}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.mixin(i),s.prototype._class+=" marshaller_TargetMarshaller",s.prototype.publish("configObject",{},"object","TargetMarshaller setup object",null,{tags:["Basic"]}),s.prototype.content=function(){return[]},s.prototype.populateContent=function(){var t=this.configObject();for(var e in this._ddlDashboards)this._ddlDashboards[e].visualizations.forEach(function(i,s){var a=t[i.id];void 0!==a?(void 0!==a.target?i.newWidgetSurface.target(a.target):(console.log("Target not specified for the following:"),console.log("this._ddlDashboards["+e+"].visualizations["+s+"].id = "+i.id)),"function"==typeof a.callback?a.callback(i.widget,i.newWidgetSurface):(console.warn("Callback not specified for the following:"),console.log("this._ddlDashboards["+e+"].visualizations["+s+"].id = "+i.id))):(console.warn("Config not specified for the following:"),console.log("this._ddlDashboards["+e+"].visualizations["+s+"].id = "+i.id))},this)},s.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments)},s.prototype.render=function(t){return this.marshallerRender(e.prototype,t),this},s.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},s}),define("hpcc-viz-marshaller",function(){});