!function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/FlyoutButton",["../form/Button","../layout/Popup","../layout/Surface"],i):t.marshaller_FlyoutButton=i(t.form_Button,t.layout_Popup,t.layout_Surface)}(this,function(t,i,e){function a(){t.call(this),this.value("^");var a=this;this._popupSurface=(new e).surfaceBackgroundColor("rgb(234, 249, 255)").buttonAnnotations([{id:"",label:"ÔÄç",width:20,padding:"0px 5px","class":"close",font:"FontAwesome"}]).on("click",function(t){"close"===t["class"]&&a._popup.visible(!1).popupState(!1).render()}),this._popup=(new i).size({width:400,height:400}).position("absolute").widget(this._popupSurface)}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype._class+=" marshaller_FlyoutButton",a.prototype.publishProxy("title","_popupSurface"),a.prototype.publishProxy("widget","_popupSurface"),a.prototype.click=function(t){var i=this;this._popup.visible(!0).popupState(!0).render(function(t){var e=i._popupSurface.widget().getBBox();i._popupSurface.resize({width:e.width,height:e.height+i._popupSurface.calcHeight(i._popupSurface.element().select(".surfaceTitle"))+18}),i._popup.render()})},a.prototype.enter=function(i,e){t.prototype.enter.apply(this,arguments);for(var a=this;a&&-1===["marshaller_HTML","marshaller_Graph"].indexOf(a.classID());)a=a.locateParentWidget();a&&(this._popupParentWidget=a,this._popup.target(a.node()))},a.prototype.render=function(i){var e=this;t.prototype.render.call(e,function(t){var a=e._popupParentWidget.getBBox(),s=t.getBBox();e._popup.left(s.x-a.x+s.width-e._popup.width()).top(s.y-a.y+s.height).visible(!1).popupState(!1).render(),i&&i(t)})},a}),function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/HipieDDL",["d3","../common/Class","../common/Database","../common/Utility","../other/Comms","../common/Widget","require"],i):t.marshaller_HipieDDL=i(t.d3,t.common_Class,t.common_Database,t.common_Utility,t.other_Comms,t.common_Widget,t.require)}(this,function(t,i,e,a,s,o,r){function n(t,i){for(var e=t.split("."),a=i,s=0;s<e.length;++s){var o=e[s];if(!a||void 0===a[o])return!1;a=a[o]}return!0}function p(t){return t?String.fromCharCode(parseInt(t)):t}function l(t,i){this.visualization=t;var e={};for(var a in i)i[a]instanceof Array?i[a].forEach(function(t,i){e[0===i?a:a+"_"+i]=t}):e[a]=i[a];this.mappings=e,this.hasMappings=!1,this.reverseMappings={},this.columns=[],this.columnsIdx={},this.columnsRHS=[],this.columnsRHSIdx={}}function h(t){switch(t){case"bool":case"boolean":return"boolean";case"integer":case"float":case"double":return"number";case"date":case"time":return"time"}return"string"}function u(t,i){l.call(this,t,i),this.columns=["label","weight"],this.columnsIdx={label:0,weight:1},this.init()}function c(t,i){l.call(this,t,i),i.state?(this.columns=["state","weight"],this.columnsIdx={state:0,weight:1}):i.county?(this.columns=["county","weight"],this.columnsIdx={county:0,weight:1}):i.geohash&&(this.columns=["geohash","weight"],this.columnsIdx={geohash:0,weight:1}),this.init()}function d(t,i){l.call(this,t,i),i.state?(this.columns=["state"],this.columnsIdx={state:0}):i.county?(this.columns=["county"],this.columnsIdx={county:0}):i.geohash&&(this.columns=["geohash"],this.columnsIdx={geohash:0}),i.weight.forEach(function(t,i){this.columns.push(t),this.columnsIdx[0===i?"weight":"weight_"+i]=i+1},this),this.init()}function f(t,i){l.call(this,t,i),this.columns=["x","y","weight"],this.columnsIdx={x:0,y:1,weight:2},this.init()}function g(t,i){var e={label:i.x[0]};i.y.forEach(function(t,i){e[t]=t}),l.call(this,t,e),this.init()}function m(t,i){var e={};for(var a in i)i[a].forEach(function(i,a){e[t.label[a]]=i});l.call(this,t,e),this.init()}function v(t,i,e){l.call(this,t,i),this.icon=t.icon||{},this.fields=t.fields||{},this.columns=["uid","label","weight","flags"],this.columnsIdx={uid:0,label:1,weight:2,flags:3},this.init(),this.link=e,this.linkMappings=new l(t,this.link.mappings),this.linkMappings.columns=["uid"],this.linkMappings.columnsIdx={uid:0},this.visualization=t}function y(t,i){if(this.visualization=t,i){switch(this._id=i.id,this._output=i.output,this.mappings=null,i.mappings||console.log("no mappings for:"+t.id+"->"+i.id),this.visualization.type){case"LINE":this.mappings=new g(this.visualization,i.mappings);break;case"TABLE":this.mappings=new m(this.visualization,i.mappings);break;case"GRAPH":this.mappings=new v(this.visualization,i.mappings,i.link);break;case"CHORO":i.mappings.weight instanceof Array&&i.mappings.weight.length?(this.mappings=new d(this.visualization,i.mappings,i.link),i.mappings.weight.length>1&&(this.visualization.type="LINE")):this.mappings=new c(this.visualization,i.mappings,i.link);break;case"HEAT_MAP":this.mappings=new f(this.visualization,i.mappings,i.link);break;default:this.mappings=new u(this.visualization,i.mappings)}this.first=i.first,this.reverse=i.reverse,this.sort=i.sort}}function _(t,i,e){this.visualization=t,this.eventID=i,e&&(this._updates=e.updates,this.mappings=e.mappings)}function b(t,i){this.visualization=t,this.events={};for(var e in i)this.events[e]=new _(t,e,i[e])}function w(t,e){i.call(this),this.dashboard=t,this.id=e.id,this.label=e.label,this.title=e.title||e.id,this.type=e.type,this.icon=e.icon||{},this.fields=e.fields||{},this.properties=e.properties||(e.source?e.source.properties:null)||{},this.source=new y(this,e.source),this.events=new b(this,e.events);var a=this;switch(this.type){case"CHORO":var s="CHORO_USTATES";this.source.mappings.contains("state")?s="CHORO_USTATES":this.source.mappings.contains("county")?s="CHORO_USCOUNTIES":this.source.mappings.contains("country")&&(s="CHORO_COUNTRIES"),this.loadWidget("../composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").showChartSelect_default(!1).chartType_default(s)});break;case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":this.loadWidget("../composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").chartType_default(a.properties.chartType||a.properties.charttype||a.type)});break;case"LINE":this.loadWidget("../composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").chartType_default(a.properties.chartType||a.properties.charttype||a.type)});break;case"TABLE":this.loadWidget("../composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").showChartSelect_default(!1).chartType_default("TABLE").chartTypeDefaults({pagination:!0})});break;case"SLIDER":this.loadWidget("../form/Slider",function(t){if(t.id(e.id),e.range){var i="";for(var a in e.events.events.mappings){i=a;break}t.low_default(+e.range[0]).high_default(+e.range[1]).step_default(+e.range[2]).selectionLabel_default(i)}});break;case"GRAPH":this.loadWidgets(["../graph/Graph"],function(t){t.id(e.id).layout_default("ForceDirected2").applyScaleOnLayout_default(!0)});break;case"FORM":this.loadWidgets(["../form/Form","../form/Input","../form/Button","../form/CheckBox","../form/ColorInput","../form/Radio","../form/Range","../form/Select","../form/Slider","../form/TextArea"],function(t,i){var a=i[1],s=i[3],o=i[5],r=i[7],n=i[9];t.id(e.id).inputs(e.fields.map(function(t){var i,e=[],p=[];switch(t.properties.charttype){case"TEXT":i=(new a).type_default("text");break;case"TEXTAREA":i=new n;break;case"CHECKBOX":i=new s;break;case"RADIO":i=new o;break;case"HIDDEN":i=(new a).type_default("hidden");break;default:if(t.properties.enumvals){i=new r,p=t.properties.enumvals;for(var l in p)e.push([l,p[l]])}else i=(new a).type_default("text")}if(i.name_default(t.id).label_default((t.properties?t.properties.label:null)||t.label).value_default(t.properties["default"]?t.properties["default"]:""),i instanceof s||i instanceof o){var h=Object.keys(t.properties.enumvals);i.selectOptions_default(h)}else e.length&&i.selectOptions_default(e);return i}))});break;case"HEAT_MAP":this.loadWidgets(["../other/HeatMap"],function(t){t.id(e.id).image_default(a.properties.imageUrl)});break;default:this.loadWidget("../common/TextBox",function(t){t.id(e.id).text_default(a.id+"\nTODO:  "+a.type)})}}function D(t,i){this.dataSource=t,this.id=i.id,this.from=i.from,this.request={},this.notify=i.notify||[],this.filter=i.filter||[]}function z(t,i,e){this.dashboard=t,this.id=i.id,this.filter=i.filter||[],this.WUID=i.WUID,this.URL=i.URL,this.databomb=i.databomb,this.request={},this._loadedCount=0;var a=this;this.outputs={};var o=[];i.outputs.forEach(function(t){a.outputs[t.id]=new D(a,t),o.push({id:t.id,from:t.from,filter:t.filter||this.filter})},this),this.WUID?this.comms=(new s.HIPIEWorkunit).url(t.marshaller.espUrl._url).proxyMappings(e).hipieResults(o):this.databomb?this.comms=(new s.HIPIEDatabomb).hipieResults(o):this.comms=(new s.HIPIERoxie).url(i.URL).proxyMappings(e)}function M(t,i,e){this.marshaller=t,this.id=i.id,this.title=i.title;var a=this;this.datasources={},this.datasourceTotal=0,i.datasources.forEach(function(t){a.datasources[t.id]=new z(a,t,e),++a.datasourceTotal}),this._visualizations={},this._visualizationArray=[],i.visualizations.forEach(function(t){var i=new w(this,t);this._visualizations[t.id]=i,this._visualizationArray.push(i),this.marshaller._visualizations[t.id]=i,this.marshaller._visualizationArray.push(i)},this),this._visualizationTotal=this._visualizationArray.length}function x(){i.call(this),this._proxyMappings={},this._widgetMappings=t.map(),this._clearDataOnUpdate=!0,this._propogateClear=!1,this.id="Marshaller",this._missingDataString=""}var E="...loading...";return l.prototype.init=function(){for(var t in this.mappings)this.reverseMappings[this.mappings[t]]=t,void 0===this.columnsIdx[t]&&(this.columns.push(t),this.columnsIdx[t]=this.columns.length-1),this.columnsRHS[this.columnsIdx[t]]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=this.columnsIdx[t],this.hasMappings=!0},l.prototype.getFields=function(){return this.visualization.fields?Object.keys(this.mappings).map(function(t){return this.visualization.fields.filter(function(i){return i.id===this.mappings[t]},this).map(function(t){return new e.Field(t.id).type(h(t.properties.type)).label(this.reverseMappings[t.id])},this)[0]},this):null},l.prototype.contains=function(t){return void 0!==this.mappings[t]},l.prototype.doMap=function(t){var i=[];for(var e in this.mappings){var a=this.mappings[e];try{var s=t[a];void 0===s&&(s=t[a.toLowerCase()]),i[this.columnsIdx[e]]=s}catch(o){console.log("Invalid Mapping:  "+this.visualization.id+" ["+a+"->"+t+"]")}}return i},l.prototype.doMapAll=function(t){return t.hipieMappings(this.columnsRHS,this.visualization.dashboard.marshaller.missingDataString())},l.prototype.getMap=function(t){return this.mappings[t]},l.prototype.getReverseMap=function(t){return this.reverseMappings[t]},u.prototype=Object.create(l.prototype),c.prototype=Object.create(l.prototype),d.prototype=Object.create(l.prototype),f.prototype=Object.create(l.prototype),g.prototype=Object.create(l.prototype),m.prototype=Object.create(l.prototype),m.prototype.init=function(){this.visualization.label.forEach(function(t,i){this.reverseMappings[this.mappings[t]]=t,this.columns.push(t),this.columnsIdx[t]=i,this.columnsRHS[i]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=i,this.hasMappings=!0},this)},v.prototype=Object.create(l.prototype),v.prototype.calcAnnotation=function(t,i,e){function a(t,i){if(t)for(var a in t)switch(a){case"faChar":i.faChar=p(t.faChar);break;case"tooltip":i[a]=t[a];break;case"icon_image_colorFill":case"icon_shape_colorFill":case"icon_shape_colorStroke":e?i[a.split("icon_")[1]]=t[a]:i[a]=t[a];break;case"textbox_image_colorFill":case"textbox_shape_colorFill":case"textbox_shape_colorStroke":e||(i[a]=t[a]);break;case"id":case"valuemappings":case"font":case"charttype":break;default:console.log("Unknown annotation property:  "+a)}}var s={};if(a(t,s),i&&i[t.id]&&t.valuemappings){var o=t.valuemappings[i[t.id]];a(o,s)}for(var r in s)return s;return null},v.prototype.doMapAll=function(t){function i(t,i){var e="uid_"+t[0],n=s[e];if(n||(n=(new r.Vertex).faChar(a.icon&&a.icon.faChar?p(a.icon.faChar):"ÔÑ®").text(t[1]?t[1]:""),n.__hpcc_uid=t[0],s[e]=n,o.push(n)),i){t[1]&&n.text(t[1]);var l=a.calcAnnotation(a.visualization.icon,i);if(l)for(var h in l)n[h]&&n[h](l[h]);var u=[];a.fields.forEach(function(t){var e=a.calcAnnotation(t,i,!0);e&&u.push(e)}),n.annotationIcons(u)}return n}var e=t.jsonObj(),a=this,s={},o=[],r=this.visualization.widget,n=[];return e.forEach(function(t){var e=a.doMap(t),s=i(e,t);if(t[a.link.childfile]&&t[a.link.childfile].Row){var o=t[a.link.childfile].Row;o.forEach(function(t,e){var o=a.linkMappings.doMap(t),p=i(o);if(s.id()!==p.id()){var l=(new r.Edge).sourceVertex(s).targetVertex(p).sourceMarker("circleFoot").targetMarker("arrowHead");n.push(l)}})}}),{vertices:o,edges:n,merge:!1}},y.prototype.getQualifiedID=function(){return this.visualization.getQualifiedID()+"."+this.id},y.prototype.exists=function(){return this._id},y.prototype.getDatasource=function(){return this.visualization.dashboard.datasources[this._id]},y.prototype.getOutput=function(){var t=this.getDatasource();return t&&t.outputs?t.outputs[this._output]:null},y.prototype.hasData=function(){return this.getOutput().db?!0:!1},y.prototype.getFields=function(){return this.mappings.getFields()},y.prototype.getColumns=function(){return this.mappings.columns},y.prototype.getData=function(){var t=this.getOutput().db,i=t.data();i.length&&this.sort&&a.multiSort(i,t.hipieMapSortArray(this.sort));var e=this.mappings.doMapAll(t);return this.reverse&&e.reverse(),this.first&&e.length>this.first&&(e.length=this.first),e},y.prototype.getXTitle=function(){return this.mappings.columns[0]},y.prototype.getYTitle=function(){return this.mappings.columns.filter(function(t,i){return i>0}).join(" / ")},_.prototype.exists=function(){return void 0!==this._updates},_.prototype.getUpdates=function(){var t=[];return n("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(i,e){var a=this.visualization.dashboard.datasources[i.datasource],s=this.visualization.dashboard.getVisualization(i.visualization);t.push({eventID:this.eventID,datasource:a,visualization:s})},this),t},_.prototype.getUpdatesDatasources=function(){var t={},i=[];return this.getUpdatesVisualizations().forEach(function(e,a){var s=e.source.getDatasource();s&&!t[s.id]&&(t[s.id]=!0,i.push(s))},this),i},_.prototype.getUpdatesVisualizations=function(){var t={},i=[];return n("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(e,a){var s=this.visualization.dashboard.getVisualization(e.visualization);t[s.id]||(t[s.id]=!0,i.push(s))},this),i},b.prototype.setWidget=function(t){var i=this;for(var e in this.events)t["vertex_"+e]?t["vertex_"+e]=function(t){i.visualization.processEvent(e,i.events[e],t)}:t[e]&&(t[e]=function(t,a,s){i.visualization.processEvent(e,i.events[e],t,a,s)})},b.prototype.exists=function(){return void 0!==this._updates},b.prototype.getUpdates=function(){var t=[];for(var i in this.events)t=t.concat(this.events[i].getUpdates());return t},b.prototype.getUpdatesDatasources=function(){var t=[];for(var i in this.events)t=t.concat(this.events[i].getUpdatesDatasources());return t},b.prototype.getUpdatesVisualizations=function(){var t=[];for(var i in this.events)t=t.concat(this.events[i].getUpdatesVisualizations());return t},w.prototype=Object.create(i.prototype),w.prototype.constructor=w,w.prototype.getQualifiedID=function(){return this.id},w.prototype.isLoading=function(t,i){return null===this.widget},w.prototype.isLoaded=function(t,i){return this.widget instanceof o},w.prototype.loadWidget=function(t,i){this.loadWidgets([t],i)},w.prototype.loadWidgets=function(t,i){this.widget=null;var e=this;r(t,function(t){e.dashboard.marshaller._widgetMappings.has(e.id)?e.setWidget(e.dashboard.marshaller._widgetMappings.get(e.id)):e.setWidget(new t),i&&i(e.widget,arguments)})},w.prototype.setWidget=function(t){this.widget=t,this.events.setWidget(t);for(var i in this.properties)switch(t.classID()){case"chart_MultiChart":case"composite_MegaChart":t.chartTypeDefaults()[i]=this.properties[i];break;default:if(this.widget[i+"_default"])try{this.widget[i+"_default"](this.properties[i])}catch(e){console.log("Invalid Property:"+this.id+".properties."+i)}}return this.widget},w.prototype.accept=function(t){t.visit(this)},w.prototype.update=function(t){var i=this.getInputVisualizations(),e=[];i.forEach(function(t){for(var i in t._eventValues)e.push(t._eventValues[i])});for(var a=t||e.join(", "),s=this.widget;s&&!s.title;)s=s.locateParentWidget();if(s){var o=s.title(),r=o.split(" (");s.title(r[0]+(a?" ("+a+")":"")).render()}else this.widget.render()},w.prototype.notify=function(){if(this.source.hasData()&&this.widget){var t=this.source.getColumns();this.widget.columns(t);var i=this.source.getData();this.widget.data(i),this.update()}},w.prototype.clear=function(){this.widget&&this.dashboard.marshaller.clearDataOnUpdate()&&(this.widget.data([]),this.source.getOutput().request={}),this.dashboard.marshaller.propogateClear()&&this._eventValues&&(delete this._eventValues,this.events.getUpdatesVisualizations().forEach(function(t){t.clear()})),this.update(E)},w.prototype.on=function(t,i){var e=this;return this.overrideMethod(t,function(t,a){t.apply(e,a),setTimeout(function(){i.apply(e,a)},0)}),this},w.prototype.processEvent=function(t,i,e,a,s){var o=this;setTimeout(function(){if(s=void 0===s?!0:s,i.exists()){var t={};if(s)for(var a in i.mappings){var r=o.source.mappings&&o.source.mappings.hasMappings?o.source.mappings.getReverseMap(a):a;t[i.mappings[a]]=e[r]}o._eventValues=t;var n={},p=i.getUpdatesVisualizations();p.forEach(function(t){var i=t.source.getDatasource();n[i.id]||(n[i.id]={datasource:i,request:{},updates:[]}),n[i.id].updates.push(t.id),t.getInputVisualizations().forEach(function(t,e){if(t._eventValues)for(var a in t._eventValues)n[i.id].request[a]&&n[i.id].request[a]!==t._eventValues[a]&&console.log("Duplicate Filter, with mismatched value:  "+a+"="+t._eventValues[a]),n[i.id].request[a]=t._eventValues[a],n[i.id].request[a+"_changed"]=t===o}),"GRAPH"!==t.type&&t.clear(),(i.WUID||i.databomb)&&i.fetchData(n[i.id].request,!1,[t.id])});for(var l in n)n[l].datasource.WUID||n[l].datasource.databomb||n[l].datasource.fetchData(n[l].request,!1,n[l].updates)}},0)},w.prototype.getInputVisualizations=function(){return this.dashboard.marshaller.getVisualizationArray().filter(function(t){var i=t.events.getUpdatesVisualizations();return i.indexOf(this)>=0?!0:!1},this)},D.prototype.getQualifiedID=function(){return this.dataSource.getQualifiedID()+"."+this.id},D.prototype.accept=function(t){t.visit(this)},D.prototype.vizNotify=function(t){this.notify.filter(function(i){return!t||t.indexOf(i)>=0}).forEach(function(t){var i=this.dataSource.dashboard.getVisualization(t);i.notify()},this)},D.prototype.setData=function(t,i,a){this.request=i,this.db=(new e.Grid).jsonObj(t),this.vizNotify(a)},z.prototype.getQualifiedID=function(){return this.dashboard.getQualifiedID()+"."+this.id},z.prototype.accept=function(t){t.visit(this);for(var i in this.outputs)this.outputs[i].accept(t)},z.prototype.fetchData=function(t,i,e){if(!e){e=[];for(var a in this.outputs){var s=this.outputs[a];s.notify.forEach(function(t){s.filter&&s.filter.length||e.push(t);var i=this.dashboard.getVisualization(t);i.update(E)},this)}}var o=this;this.request.refresh=i?!0:!1,this.filter.forEach(function(i){this.request[i+"_changed"]=t[i+"_changed"]||!1;var e=void 0===t[i]?null:t[i];this.request[i]!==e&&(this.request[i]=e)},this),window.__hpcc_debug&&console.log("fetchData:  "+JSON.stringify(e)+"("+JSON.stringify(t)+")");for(var r in this.request)null===this.request[r]&&delete this.request[r];var n=Date.now();this.dashboard.marshaller.commsEvent(this,"request",this.request),this.comms.call(this.request).then(function(i){var a=500-(Date.now()-n);setTimeout(function(){o.processResponse(i,t,e),o.dashboard.marshaller.commsEvent(o,"response",o.request,i),++o._loadedCount},a>0?a:0)})["catch"](function(t){o.dashboard.marshaller.commsEvent(o,"error",o.request,t)})},z.prototype.processResponse=function(t,i,e){var a={};for(var s in t)a[s.toLowerCase()]=t[s];for(var o in this.outputs){var r=this.outputs[o].from;if(r||(r=this.outputs[o].id.toLowerCase()),n(r,t))!n(r+"_changed",t)||n(r+"_changed",t)&&t[r+"_changed"].length&&t[r+"_changed"][0][r+"_changed"]?this.outputs[o].setData(t[r],i,e):this.outputs[o].vizNotify(e);else if(n(r,a))console.log("DDL 'DataSource.From' case is Incorrect"),!n(r+"_changed",a)||n(r+"_changed",a)&&t[r+"_changed"].length&&a[r+"_changed"][0][r+"_changed"]?this.outputs[o].setData(a[r],i,e):this.outputs[o].vizNotify(e);else{var p=[];for(var l in t)p.push(l);console.log("Unable to locate '"+r+"' in response {"+p.join(", ")+"}")}}},M.prototype.getQualifiedID=function(){return this.id},M.prototype.getVisualization=function(t){return this._visualizations[t]||this.marshaller.getVisualization(t)},M.prototype.getVisualizations=function(){return this._visualizations},M.prototype.getVisualizationArray=function(){return this._visualizationArray},M.prototype.getVisualizationTotal=function(){return this._visualizationTotal},M.prototype.accept=function(t){t.visit(this);for(var i in this.datasources)this.datasources[i].accept(t);this._visualizationArray.forEach(function(i){i.accept(t)},this)},M.prototype.allVisualizationsLoaded=function(){var t=this._visualizationArray.filter(function(t){return!t.isLoaded()});return 0===t.length},x.prototype=Object.create(i.prototype),x.prototype.constructor=x,x.prototype.commsDataLoaded=function(){for(var t=0;t<this.dashboardArray.length;t++)for(var i in this.dashboardArray[t].datasources)if(0===this.dashboardArray[t].datasources[i]._loadedCount)return!1;return!0},x.prototype.getVisualization=function(t){return this._visualizations[t]},x.prototype.accept=function(t){t.visit(this),this.dashboardTotal=0;for(var i in this.dashboards)this.dashboards[i].accept(t),++this.dashboardTotal},x.prototype.url=function(t,i){this.espUrl=(new s.ESPUrl).url(t);var e=null,a="HIPIE_DDL";this.espUrl.isWorkunitResult()?(a=this.espUrl._params.ResultName,e=(new s.HIPIEWorkunit).url(t).proxyMappings(this._proxyMappings)):e=(new s.HIPIERoxie).url(t).proxyMappings(this._proxyMappings);var o={refresh:!1},r=this;e.call(o).then(function(t){return n(a,t)?e.fetchResult(a).then(function(e){var s=e[0][a];r.parse(s,function(){i(t)})})["catch"](function(t){r.commsEvent(r,"error",a,t)}):void 0})["catch"](function(t){r.commsEvent(r,"error",o,t)})},x.prototype.proxyMappings=function(t){return arguments.length?(this._proxyMappings=t,this):this._proxyMappings},x.prototype.widgetMappings=function(t){return arguments.length?(this._widgetMappings=t,this):this._widgetMappings},x.prototype.clearDataOnUpdate=function(t){return arguments.length?(this._clearDataOnUpdate=t,this):this._clearDataOnUpdate},x.prototype.propogateClear=function(t){return arguments.length?(this._propogateClear=t,this):this._propogateClear},x.prototype.missingDataString=function(t){return arguments.length?(this._missingDataString=t,this):this._missingDataString},x.prototype.parse=function(t,i){var e=this;return this._json=t,this._jsonParsed=JSON.parse(this._json),this.dashboards={},this.dashboardArray=[],this._visualizations={},this._visualizationArray=[],this._jsonParsed.forEach(function(t){var i=new M(e,t,e._proxyMappings);e.dashboards[t.id]=i,e.dashboardArray.push(i)}),this.dashboardTotal=this.dashboardArray.length,this._visualizationArray.forEach(function(t){t.on("processEvent",function(i,a,s,o,r){e.vizEvent(t.widget,i,s,o,r)})}),this.ready(i),this},x.prototype.getVisualizations=function(){return this._visualizations},x.prototype.getVisualizationArray=function(){return this._visualizationArray},x.prototype.on=function(t,i){var e=this;return this.overrideMethod(t,function(t,a){t.apply(e,a),i.apply(this,arguments)}),this},x.prototype.allDashboardsLoaded=function(){return 0===this.dashboardArray.filter(function(t){return!t.allVisualizationsLoaded()}).length},x.prototype.ready=function(t){function i(t){e.allDashboardsLoaded()?t():setTimeout(i,100,t)}if(t){var e=this;i(t)}},x.prototype.vizEvent=function(t,i,e,a,s){console.log("Marshaller.vizEvent:  "+t.id()+"-"+i)},x.prototype.commsEvent=function(t,i,e,a){switch(i){case"request":window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+t.id+"-"+i+":  "+JSON.stringify(e));break;case"response":case"error":window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+t.id+"-"+i+":  "+JSON.stringify(a));break;default:window.__hpcc_debug&&console.log("Marshaller.commsEvent:  "+JSON.stringify(arguments))}},x.prototype.createDatabomb=function(){var t={};return this.dashboardArray.forEach(function(i){for(var e in i.datasources){var a=i.datasources[e].comms;t[e]={};for(var s in a._hipieResults){var o=a._hipieResults[s];t[e][s]=a._resultNameCache[o.from]}}}),t},{exists:n,Marshaller:x,Dashboard:M,DataSource:z,Output:D,Visualization:w}}),function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/HipieDDLMixin",["d3","../common/Class","../common/PropertyExt","../common/Utility","./HipieDDL","../other/Persist","../layout/Surface","./FlyoutButton"],i):t.marshaller_HipieDDLMixin=i(t.d3,t.common_Class,t.common_PropertyExt,t.common_PropertyExt,t.common_Utility,t.other_Persist,t.layout_Surface,t.marshaller_FlyoutButton)}(this,function(t,i,e,a,s,o,r,n){function p(){i.call(this),e.call(this)}p.prototype=Object.create(i.prototype),p.prototype.constructor=p,p.prototype.mixin(e),p.prototype._class+=" marshaller_HipieDDLMixin",p.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),p.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),p.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),p.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),p.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),p.prototype.publish("missingDataString","***MISSING***","string","Missing data display string"),p.prototype.selection=function(t){return arguments.length?(this._marshaller&&this._marshaller.fetchData(t,!0),this):this._marshaller?this._marshaller.request:null},p.prototype._gatherDashboards=function(t,i){i instanceof Object||i&&(i=JSON.parse(i)),this._ddlDashboards=[],this._ddlVisualizations=[],this._ddlPopupVisualizations=[];var e=this,a=null;t.accept({visit:function(t){t instanceof s.Dashboard?(a={dashboard:t,visualizations:[],popupVisualizations:[]},e._ddlDashboards.push(a)):t instanceof s.DataSource?t.databomb&&i[t.id]&&t.comms.databomb(i[t.id]):t instanceof s.Output?t.dataSource.databomb&&t.dataSource.comms.databombOutput(t.from,t.id):t instanceof s.Visualization&&t.widget&&(t.properties.flyout?(a.popupVisualizations.push(t),e._ddlPopupVisualizations.push(t)):(a.visualizations.push(t),e._ddlVisualizations.push(t)))}})},p.prototype._marshallerRender=function(i,e){function a(){u._gatherDashboards(u._marshaller,u.databomb()),u._ddlVisualizations.forEach(function(t){h.remove(t.id),u._marshaller.widgetMappings().get(t.id)||(t.newWidgetSurface=null,t.widget instanceof r||"composite_MegaChart"===t.widget.classID()?t.newWidgetSurface=t.widget:t.newWidgetSurface=(new r).widget(t.widget),t.newWidgetSurface.title(t.title),t.widget.size({width:0,height:0}))}),u._ddlPopupVisualizations.forEach(function(t){h.remove(t.id);var i=t.events.getUpdatesVisualizations();i.forEach(function(i){switch(i.widget.classID()){case"composite_MegaChart":var e=(new n).title(t.title).widget(t.widget);i.widget.toolbarWidgets().push(e)}})}),h.forEach(function(t,i){u.clearContent(i)}),u.populateContent(),i.render.call(u,function(t){for(var i in u._ddlDashboards)for(var a in u._ddlDashboards[i].dashboard.datasources)u._ddlDashboards[i].dashboard.datasources[a].fetchData({},!0);var s=0,o=setInterval(function(){(u._marshaller.commsDataLoaded()||++s>120)&&(clearInterval(o),e&&e(t))},500)})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return this._marshaller&&this._marshaller.proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()),i.render.call(this,function(t){e&&e(t)});this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var p=[];o.widgetArrayWalker(this.content(),function(t){p.push(t)});var l=t.map(p,function(t){return t.id()}),h=t.map(p.filter(function(t){return 0!==t.id().indexOf(t._idSeed)&&0!==t.id().indexOf("_pe")}),function(t){return t.id()}),u=this;this._marshaller=(new s.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).missingDataString(this.missingDataString()).widgetMappings(l).on("commsEvent",function(t,i){u.commsEvent.apply(u,arguments)}).on("vizEvent",function(){u.vizEvent.apply(u,arguments)}),this.firstRender=!0,"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this._marshaller.parse(this.ddlUrl(),a):this._marshaller.url(this.ddlUrl(),a)},p.prototype.dashboards=function(){var t={};for(var i in this._marshaller.dashboards)t[i]={},this._marshaller.dashboards[i].visualizations.forEach(function(e){t[i][e.id]=e.widget},this);return t},p.prototype.visualizations=function(){return this._marshaller._visualizationArray.map(function(t){return t.newWidgetSurface||t.widget})};var l="<!doctype html><html><head><meta charset='utf-8'><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz.js'></script><script src='http://viz.hpccsystems.com/v1.14.0-rc5/dist-amd/hpcc-viz-common.js'></script></head><body style='padding:0px; margin:0px; overflow:hidden'><div id='placeholder' style='width:100%; height:100vh'></div><script>   require(['src/other/Persist'], function (Persist) {\n       Persist.create({STATE}, function(widget) {\n           widget\n               .target('placeholder')\n               .ddlUrl('{DDL}')\n               .databomb('{DATABOMB}')\n               .render()\n           ;\n       });\n   });</script></body></html>";return p.prototype.generateTestPage=function(){if(this._marshaller){var t=this,i=o.serialize(t,function(t,i){return"databomb"===i.id||"ddlUrl"===i.id?!0:!1}),e=this._marshaller.createDatabomb(),s=l.replace("{VERSION}",t.version()).replace("{STATE}",i).replace("{DDL}",t._marshaller._json.replace("WUID","databomb")).replace("{DATABOMB}",JSON.stringify(e));a.downloadBlob("html",s,"test")}},p.prototype.vizEvent=function(t,i,e,a,s){},p.prototype.commsEvent=function(t,i,e,a){},p}),function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/Graph",["d3","../common/SVGWidget","../common/TextBox","../common/Surface","../common/ResizeSurface","../chart/MultiChartSurface","../common/Palette","../graph/Graph","../graph/Vertex","../graph/Edge","./HipieDDLMixin"],i):t.marshaller_Graph=i(t.d3,t.common_SVGWidget,t.common_TextBox,t.common_Surface,t.common_ResizeSurface,t.chart_MultiChartSurface,t.common_Palette,t.graph_Graph,t.graph_Vertex,t.graph_Edge,t.marshaller_HipieDDLMixin)}(this,function(t,i,e,a,s,o,r,n,p,l,h){function u(){n.call(this),h.call(this),this._design_mode=!1,this._dashboards=[],this.graphAttributes=["snapToGrid","showEdges"],this.widgetAttributes=["layout","chartType","palette","title","columns","data"],this.layout("Hierarchy"),this.applyScaleOnLayout(!0),this.content([])}return u.prototype=Object.create(n.prototype),u.prototype.constructor=u,u.prototype.mixin(h),u.prototype._class+=" marshaller_Graph",u.prototype.publish("content",[],"widgetArray","widgets",null,{tags:["Basic"]}),u.prototype.populateContent=function(){var t=[],i=[];for(var e in this._ddlDashboards)this._ddlDashboards[e].visualizations.forEach(function(i){if(i.widget){var e=null;if(i.widget instanceof s)e=i.widget.size({width:210,height:210});else{var a=280,o=210;e=(new s).showTitle(!0).size({width:a,height:o}).content(i.widget)}e&&(i.newWidgetSurface=e),
t.push(e)}i.getInputVisualizations().forEach(function(){},this)},this);for(e in this._ddlDashboards)this._ddlDashboards[e].visualizations.forEach(function(t){t.getInputVisualizations().forEach(function(e){i.push((new l).sourceVertex(e.newWidgetSurface).targetVertex(t.newWidgetSurface).targetMarker("arrowHead"))},this)},this);this.content(t),this.data({vertices:t,edges:i})},u.prototype.enter=function(t,i){n.prototype.enter.apply(this,arguments),i.classed("graph_Graph",!0)},u.prototype.render=function(t){return this._marshallerRender(n.prototype,t),this},u.prototype.commsError=function(t,i){alert("Comms Error:\n"+t+"\n"+i)},u}),function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/HTML",["d3","../layout/Grid","./HipieDDLMixin"],i):t.marshaller_HTML=i(t.d3,t.layout_Grid,t.marshaller_HipieDDLMixin)}(this,function(t,i,e){function a(){i.call(this),e.call(this),this.surfacePadding(0)}return a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.prototype.mixin(e),a.prototype._class+=" marshaller_HTML",a.prototype.populateContent=function(){var t=0,i=0,e=this.cellDensity();for(var a in this._ddlDashboards){var s=Math.floor(Math.sqrt(this._ddlDashboards[a].visualizations.length));this._ddlDashboards[a].visualizations.forEach(function(a){if(a.newWidgetSurface){for(;null!==this.getCell(t*e,i*e);)i++,i%s===0&&(t++,i=0);this.setContent(t,i,a.newWidgetSurface)}},this)}var o={};this.content().forEach(function(t){var i=t.widget();i&&"layout_Surface"===i.classID()&&(i=i.widget()),i&&(o[i.id()]=t)});for(a in this._ddlDashboards)this._ddlDashboards[a].visualizations.forEach(function(t,i){if(!t.properties.flyout){var e=t.events.getUpdatesVisualizations(),a=e.map(function(t){return o[t.id].id()});o[t.id].indicateTheseIds(a)}})},a.prototype.enter=function(t,e){i.prototype.enter.apply(this,arguments)},a.prototype.render=function(t){return this._marshallerRender(i.prototype,t),this},a.prototype.commsError=function(t,i){alert("Comms Error:\n"+t+"\n"+i)},a}),function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/Tabbed",["d3","../layout/Tabbed","../layout/Grid","./HipieDDL","../layout/Surface","../layout/Cell"],i):t.marshaller_Tabbed=i(t.d3,t.layout_Tabbed,t.layout_Grid,t.marshaller_HipieDDL,t.layout_Surface,t.layout_Cell)}(this,function(t,i,e,a,s,o){function r(){i.call(this)}function n(t,i){i instanceof Object||i&&(i=JSON.parse(i));var e=null,s={};return t.accept({visit:function(t){t instanceof a.Dashboard?(e={dashboard:t,visualizations:[]},s[t.getQualifiedID()]=e):t instanceof a.DataSource?t.databomb&&i[t.id]&&t.comms.databomb(i[t.id]):t instanceof a.Output?t.dataSource.databomb&&t.dataSource.comms.databombOutput(t.from,t.id):t instanceof a.Visualization&&t.widget&&e.visualizations.push(t)}}),s}return r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.prototype._class+=" marshaller_Tabbed",r.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),r.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),r.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),r.prototype.publish("designMode",!1,"boolean","Design Mode",null,{tags:["Basic"]}),r.prototype.testData2=function(){return this.ddlUrl("http://10.241.100.159:8002/WsEcl/submit/query/roxie/hipie_testrelavator3.ins002_service/json"),this},r.prototype._origDesignMode=r.prototype.designMode,r.prototype.designMode=function(t){var i=r.prototype._origDesignMode.apply(this,arguments);return arguments.length&&this.widgets().forEach(function(i){i.widget().designMode(t)}),i},r.prototype.render=function(s){function o(){var t=n(p.marshaller,p.databomb());if(!r.length){p.marshaller.dashboardTotal<=1&&p.showTabs(!1);for(var a in t){var o=new e;p.addTab(o,t[a].dashboard.title);var l=0,h=0,u=Math.floor(Math.sqrt(t[a].visualizations.length));t[a].visualizations.forEach(function(t,i){i&&i%u===0&&(l++,h=0),t.widget.size({width:0,height:0}),o.setContent(l,h,t.widget,t.title),h++})}}for(var c in t)for(var d in t[c].dashboard.datasources)t[c].dashboard.datasources[d].fetchData({},!0);i.prototype.render.call(p,function(t){s&&s(t)})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return i.prototype.render.apply(this,arguments);this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearTabs(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var r=[];this.widgets().forEach(function(t){r=r.concat(t.widget().content())});var p=this;return this.marshaller=(new a.Marshaller).proxyMappings(this.proxyMappings()).widgetMappings(t.map(r.map(function(t){return t.widget()}),function(t){return t.id()})).on("commsError",function(t,i){p.commsError(t,i)}),"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this.marshaller.parse(this.ddlUrl(),function(){o()}):this.marshaller.url(this.ddlUrl(),function(){o()}),this},r.prototype.commsError=function(t,i){alert("Comms Error:\n"+t+"\n"+i)},r}),function(t,i){"function"==typeof define&&define.amd?define("src/marshaller/TargetMarshaller",["d3","../common/HTMLWidget","./HipieDDLMixin"],i):t.marshaller_TargetMarshaller=i(t.d3,t.common_HTMLWidget,t.marshaller_HipieDDLMixin)}(this,function(t,i,e){function a(){i.call(this),e.call(this),this._tag="div"}return a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.prototype.mixin(e),a.prototype._class+=" marshaller_TargetMarshaller",a.prototype.publish("configObject",{},"object","TargetMarshaller setup object",null,{tags:["Basic"]}),a.prototype.content=function(){return[]},a.prototype.populateContent=function(){var t=this.configObject();for(var i in this._ddlDashboards)this._ddlDashboards[i].visualizations.forEach(function(e,a){var s=t[e.id];void 0!==s?(void 0!==s.target?e.newWidgetSurface.target(s.target):(console.log("Target not specified for the following:"),console.log("this._ddlDashboards["+i+"].visualizations["+a+"].id = "+e.id)),"function"==typeof s.callback?s.callback(e.widget,e.newWidgetSurface):(console.warn("Callback not specified for the following:"),console.log("this._ddlDashboards["+i+"].visualizations["+a+"].id = "+e.id))):(console.warn("Config not specified for the following:"),console.log("this._ddlDashboards["+i+"].visualizations["+a+"].id = "+e.id))},this)},a.prototype.enter=function(t,e){i.prototype.enter.apply(this,arguments)},a.prototype.render=function(t){return this.marshallerRender(i.prototype,t),this},a.prototype.commsError=function(t,i){alert("Comms Error:\n"+t+"\n"+i)},a}),define("hpcc-viz-marshaller",function(){});