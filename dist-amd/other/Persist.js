(function(e,t){typeof define=="function"&&define.amd?define(["../common/Utility"],t):e.other_Persist=t(e.common_Utility)})(this,function(e){function t(e){return e.publishedProperties(!1,!0)}function n(e,i){if(!e)return;i(e),t(e).forEach(function(t){switch(t.type){case"widget":n(e[t.id](),i);break;case"widgetArray":case"propertyArray":r(e[t.id](),i)}})}function r(e,t){if(!e)return;e.forEach(function(e){n(e,t)})}function i(e,t,n){e.propertyWalker(t,n)}function s(e,t,r){n(e,function(e){i(e,t,r)})}return{discover:t,widgetWalker:n,widgetArrayWalker:r,propertyWalker:i,widgetPropertyWalker:s,serializeTheme:function(e,t){return JSON.stringify(this.serializeThemeToObject(e,t))},serializeThemeToObject:function(e,t){function r(e,t){var n=!1;for(var r in t)if(e.indexOf(t[r])!==-1){n=!0;break}return n}t=t||["surface","Color","Font","palette"];var n={};return s(e,null,function(e,i){if(e[i.id+"_modified"]()||e.publishedProperty(i.id).origDefaultValue!==e.publishedProperty(i.id).defaultValue)if(r(i.id,t)){var s=e._class.trim().split(" ");for(var o in s){n[s[o]]===undefined&&(n[s[o]]={});if(n[s[o]][i.id]===undefined){n[s[o]][i.id]=e[i.id]();break}if(n[s[o]][i.id]===e[i.id]())break}}}),n},removeTheme:function(e,t){s(e,null,function(e,t){e.publishedProperty(t.id).defaultValue=e.publishedProperty(t.id).origDefaultValue}),typeof t=="function"&&t.call(this)},applyTheme:function(e,t,n){var r=this;s(e,null,function(e,n){switch(n.type){case"widget":return r.applyTheme(e[n.id](),t),!0;case"widgetArray":var i=e[n.id]();return i.forEach(function(e){r.applyTheme(e,t)},this),!0;default:e.applyTheme(t)}}),typeof n=="function"&&n.call(this)},serializeToObject:function(e,t,n,r){var s={__class:e.classID()};e._id.indexOf(e._idSeed)!==0&&(s.__id=e._id),e.version&&(s.__version=e.version()),s.__properties={};var o=this;i(e,t,function(e,t){if(e[t.id+"_modified"]())switch(t.type){case"widget":return s.__properties[t.id]=o.serializeToObject(e[t.id](),null,n,r),!0;case"widgetArray":case"propertyArray":s.__properties[t.id]=[];var i=e[t.id]();return i.forEach(function(e,i){s.__properties[t.id].push(o.serializeToObject(e,null,n,r))}),!0;default:s.__properties[t.id]=e[t.id]()}});if(e.classID()==="marshaller_Graph"){var u=e.data().vertices;u&&(this.__vertices=u.map(function(e){return this.serializeToObject(e,null,n,r)},this))}return n&&e.data&&(s.__data||(s.__data={}),s.__data.data=e.data()),r&&e.serializeState&&(s.__state=e.serializeState()),s},serialize:function(e,t,n,r){return JSON.stringify(this.serializeToObject(e,t,n,r))},deserializeFromObject:function(e,t,n){var r=0,i=this;s(e,null,function(e,n){e[n.id+"_reset"]();if(t.__properties[n.id]!==undefined)switch(n.type){case"widget":++r;var s=n.id;i.create(t.__properties[n.id],function(t){e[s](t),--r});break;case"widgetArray":case"propertyArray":var o=n.id,u=t.__properties[n.id];if(u.length){++r;var a=[];a.length=u.length;var f=0;u.forEach(function(t,n){++f,i.create(t,function(t){t._owner=e,a[n]=t,--f});var s=setInterval(function(){f<=0&&(clearInterval(s),f=undefined,e[o](a),--r)},20)})}break;default:e[n.id](t.__properties[n.id])}});var o=setInterval(function(){if(r<=0){clearInterval(o),r=undefined;if(t.__data)for(var i in t.__data)switch(i){case"data":e.data(t.__data[i]);break;default:console.log("Unexpected __data item:  "+i),e[i](t.__data[i])}t.__state&&e.deserializeState&&e.deserializeState(t.__state),n(e)}},20)},deserialize:function(e,t,n){typeof t=="string"&&(t=JSON.parse(t)),t.__id&&t.__id.indexOf(e._idSeed)!==0&&e._id!==t.__id&&console.log("Deserialize:  IDs do not match - "+e._id),this.deserializeFromObject(e,t,n)},create:function(t,n){typeof t=="string"&&(t=JSON.parse(t));var r=this;e.requireWidget(t.__class).then(function(e){var i=new e;t.__id&&t.__id.indexOf(i._idSeed)!==0&&t.__id.indexOf("_pe")!==0&&(i._id=t.__id),r.deserializeFromObject(i,t,n)}).catch(function(e){console.log("Persist.create:  ***exception***"),console.log(e),n(null)})},clone:function(e,t){this.create(this.serializeToObject(e,[],!0,!0),t)}}});