!function(e,i){"function"==typeof define&&define.amd?define(["../common/Utility"],i):e.other_Persist=i(e.common_Utility)}(this,function(e){function i(e){return e.publishedProperties(!1,!0)}function t(e,a){e&&(a(e),i(e).forEach(function(i){switch(i.type){case"widget":t(e[i.id](),a);break;case"widgetArray":case"propertyArray":r(e[i.id](),a)}}))}function r(e,i){e&&e.forEach(function(e){t(e,i)})}function a(e,i,t){e.propertyWalker(i,t)}function n(e,i,r){t(e,function(e){a(e,i,r)})}return{discover:i,widgetWalker:t,widgetArrayWalker:r,propertyWalker:a,widgetPropertyWalker:n,serializeTheme:function(e,i){return JSON.stringify(this.serializeThemeToObject(e,i))},serializeThemeToObject:function(e,i){function t(e,i){var t=!1;for(var r in i)if(-1!==e.indexOf(i[r])){t=!0;break}return t}i=i||["surface","Color","Font","palette"];var r={};return n(e,null,function(e,a){if((e[a.id+"_modified"]()||e.publishedProperty(a.id).origDefaultValue!==e.publishedProperty(a.id).defaultValue)&&t(a.id,i)){var n=e._class.trim().split(" ");for(var o in n){if(void 0===r[n[o]]&&(r[n[o]]={}),void 0===r[n[o]][a.id]){r[n[o]][a.id]=e[a.id]();break}if(r[n[o]][a.id]===e[a.id]())break}}}),r},removeTheme:function(e,i){n(e,null,function(e,i){e.publishedProperty(i.id).defaultValue=e.publishedProperty(i.id).origDefaultValue}),"function"==typeof i&&i.call(this)},applyTheme:function(e,i,t){var r=this;n(e,null,function(e,t){switch(t.type){case"widget":return r.applyTheme(e[t.id](),i),!0;case"widgetArray":var a=e[t.id]();return a.forEach(function(e){r.applyTheme(e,i)},this),!0;default:e.applyTheme(i)}}),"function"==typeof t&&t.call(this)},serializeToObject:function(e,i,t,r){var n={__class:e.classID()};0!==e._id.indexOf(e._idSeed)&&(n.__id=e._id),e.version&&(n.__version=e.version()),n.__properties={};var o=this;if(a(e,i,function(i,a){if(i[a.id+"_modified"]())switch(a.type){case"widget":return n.__properties[a.id]=o.serializeToObject(i[a.id](),null,t,r&&!e.serializeState),!0;case"widgetArray":case"propertyArray":n.__properties[a.id]=[];var d=i[a.id]();return d.forEach(function(i,d){n.__properties[a.id].push(o.serializeToObject(i,null,t,r&&!e.serializeState))}),!0;default:n.__properties[a.id]=i[a.id]()}}),"marshaller_Graph"===e.classID()){var d=e.data().vertices;d&&(this.__vertices=d.map(function(i){return this.serializeToObject(i,null,t,r&&!e.serializeState)},this))}return t&&e.data&&(n.__data||(n.__data={}),n.__data.data=e.data()),r&&(e.serializeState?n.__state=e.serializeState():e.data&&(n.__state={data:e.data()})),n},serialize:function(e,i,t,r){return JSON.stringify(this.serializeToObject(e,i,t,r))},deserializeFromObject:function(e,i,t){var r=0,a=this;n(e,null,function(e,t){if(e[t.id+"_reset"](),void 0!==i.__properties[t.id])switch(t.type){case"widget":++r;var n=t.id;a.create(i.__properties[t.id],function(i){e[n](i),--r});break;case"widgetArray":case"propertyArray":var o=t.id,d=i.__properties[t.id];if(d.length){++r;var s=[];s.length=d.length;var c=0;d.forEach(function(i,t){++c,a.create(i,function(i){i._owner=e,s[t]=i,--c});var n=setInterval(function(){0>=c&&(clearInterval(n),c=void 0,e[o](s),--r)},20)})}break;default:e[t.id](i.__properties[t.id])}});var o=setInterval(function(){if(0>=r){if(clearInterval(o),r=void 0,i.__data)for(var a in i.__data)switch(a){case"data":e.data(i.__data[a]);break;default:console.log("Unexpected __data item:  "+a),e[a](i.__data[a])}i.__state&&(e.deserializeState?e.deserializeState(i.__state):i.__state.data&&e.data&&e.data(i.__state.data)),t(e)}},20)},deserialize:function(e,i,t){"string"==typeof i&&(i=JSON.parse(i)),i.__id&&0!==i.__id.indexOf(e._idSeed)&&e._id!==i.__id&&console.log("Deserialize:  IDs do not match - "+e._id),this.deserializeFromObject(e,i,t)},create:function(i,t){"string"==typeof i&&(i=JSON.parse(i));var r=this;e.requireWidget(i.__class).then(function(e){var a=new e;i.__id&&0!==i.__id.indexOf(a._idSeed)&&0!==i.__id.indexOf("_pe")&&(a._id=i.__id),r.deserializeFromObject(a,i,t)})["catch"](function(e){console.log("Persist.create:  ***exception***"),console.log(e),t(null)})},clone:function(e,i){this.create(this.serializeToObject(e,[],!0,!0),i)}}});