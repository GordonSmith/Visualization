!function(e,i){"function"==typeof define&&define.amd?define(["../common/Utility"],i):e.other_Persist=i(e.common_Utility)}(this,function(e){function i(e){var i=[];return e.publishedProperties().forEach(function(r){var t=e,a=r;if(a.type){for(;"proxy"===a.type;)t=t[a.proxy],a=t.publishedProperty(a.method);a.id!==e.publishedProperty(r.id).id&&(a=JSON.parse(JSON.stringify(a)),a.id=e.publishedProperty(r.id).id),i.push(a)}},this),i}function r(e,t){if(e){t(e);for(var a=i(e),n=0;n<a.length;++n){var o=a[n];switch(o.type){case"widget":r(e[o.id](),t);break;case"widgetArray":case"propertyArray":var d=e[o.id]();d&&d.forEach(function(e){r(e,t)})}}}}function t(e,i){e&&e.forEach(function(e){r(e,i)})}function a(e,r,t){for(var a=i(e),n=0;n<a.length;++n){var o=a[n];"function"==typeof r&&r(e,o)||t(e,o)}}function n(e,i,t){r(e,function(e){a(e,i,t)})}return{discover:i,widgetWalker:r,widgetArrayWalker:t,propertyWalker:a,widgetPropertyWalker:n,serializeTheme:function(e,i){return JSON.stringify(this.serializeThemeToObject(e,i))},serializeThemeToObject:function(e,i){function r(e,i){var r=!1;for(var t in i)if(-1!==e.indexOf(i[t])){r=!0;break}return r}i=i||["surface","Color","Font","palette"];var t={};return n(e,null,function(e,a){if((e[a.id+"_modified"]()||e.publishedProperty(a.id).origDefaultValue!==e.publishedProperty(a.id).defaultValue)&&r(a.id,i)){var n=e._class.trim().split(" ");for(var o in n){if(void 0===t[n[o]]&&(t[n[o]]={}),void 0===t[n[o]][a.id]){t[n[o]][a.id]=e[a.id]();break}if(t[n[o]][a.id]===e[a.id]())break}}}),t},removeTheme:function(e,i){n(e,null,function(e,i){e.publishedProperty(i.id).defaultValue=e.publishedProperty(i.id).origDefaultValue}),"function"==typeof i&&i.call(this)},applyTheme:function(e,i,r){var t=this;n(e,null,function(e,r){switch(r.type){case"widget":return t.applyTheme(e[r.id](),i),!0;case"widgetArray":var a=e[r.id]();return a.forEach(function(e){t.applyTheme(e,i)},this),!0;default:e.applyTheme(i)}}),"function"==typeof r&&r.call(this)},serializeToObject:function(e,i,r){var t={__class:e.classID()};0!==e._id.indexOf(e._idSeed)&&(t.__id=e._id),e.version&&(t.__version=e.version()),t.__properties={};var n=this;if(a(e,i,function(e,i){if(e[i.id+"_modified"]())switch(i.type){case"widget":return t.__properties[i.id]=n.serializeToObject(e[i.id](),null,r),!0;case"widgetArray":case"propertyArray":t.__properties[i.id]=[];var a=e[i.id]();return a.forEach(function(e,a){t.__properties[i.id].push(n.serializeToObject(e,null,r))}),!0;default:t.__properties[i.id]=e[i.id]()}}),"marshaller_Graph"===e.classID()){var o=e.data().vertices;o&&(this.__vertices=o.map(function(e){return this.serializeToObject(e,null,r)},this))}return r&&e.data&&(t.__data||(t.__data={}),t.__data.data=e.data()),t},serialize:function(e,i,r){return JSON.stringify(this.serializeToObject(e,i,r))},deserializeFromObject:function(e,i,r){var t=0,a=this;n(e,null,function(e,r){if(e[r.id+"_reset"](),void 0!==i.__properties[r.id])switch(r.type){case"widget":++t;var n=r.id;a.create(i.__properties[r.id],function(i){e[n](i),--t});break;case"widgetArray":case"propertyArray":var o=r.id,d=i.__properties[r.id];if(d.length){++t;var s=[];s.length=d.length;var c=0;d.forEach(function(i,r){++c,a.create(i,function(i){i._owner=e,s[r]=i,--c});var n=setInterval(function(){0>=c&&(clearInterval(n),c=void 0,e[o](s),--t)},20)})}break;default:e[r.id](i.__properties[r.id])}});var o=setInterval(function(){if(0>=t){if(clearInterval(o),t=void 0,i.__data)for(var a in i.__data)e[a](i.__data[a]);r(e)}},20)},deserialize:function(e,i,r){"string"==typeof i&&(i=JSON.parse(i)),i.__id&&0!==i.__id.indexOf(e._idSeed)&&e._id!==i.__id&&console.log("Deserialize:  IDs do not match - "+e._id),this.deserializeFromObject(e,i,r)},create:function(i,r){"string"==typeof i&&(i=JSON.parse(i));var t=this;e.requireWidget(i.__class).then(function(e){var a=new e;i.__id&&0!==i.__id.indexOf(a._idSeed)&&0!==i.__id.indexOf("_pe")&&(a._id=i.__id),t.deserializeFromObject(a,i,r)})["catch"](function(e){console.log("Persist.create:  ***exception***"),console.log(e),r(null)})},clone:function(e,i){this.create(this.serializeToObject(e,[],!0),i)}}});