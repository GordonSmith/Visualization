!function(t,e){"function"==typeof define&&define.amd?define(["es6-promise"],e):t.other_Comms=e()}(this,function(){function t(t){if(void 0===t||null===t)return null;if(!t.trim)return t.Row?e(t.Row):t;var r=t.trim();return""!==r&&!isNaN(r)&&(r.length<=1||"0"!==r[0]||"."===r[1])?Number(r):r}function e(e){for(var r in e)e[r]=t(e[r]);return e}function r(){this._protocol="http:",this._hostname="localhost"}function s(t){this._mappings=t,this._reverseMappings={};for(var e in this._mappings){this._reverseMappings[e]={};for(var r in this._mappings[e])this._reverseMappings[e][this._mappings[e][r]]=r}}function n(){r.call(this),this._proxyMappings={},this._mappings=new s({}),this._timeout=f}function o(t,e){if(!t||!e)return!1;for(var r=t.split("."),s=e,n=0;n<r.length;++n){var o=r[n];if(void 0===s[o])return!1;s=s[o]}return!0}function i(){n.call(this)}function a(t){for(var e in t){if(t[e].Row&&t[e].Row instanceof Array)return t;var r=a(t[e]);if(r)return r}return null}function u(){n.call(this),this._port="8002",this._target="",this._query=""}function h(){n.call(this),this._port="8010",this._wuid="",this._jobname="",this._sequence=null,this._resultName=null,this._fetchResultNamesPromise=null,this._fetchResultPromise={},this._resultNameCache={},this._resultNameCacheCount=0}function p(){n.call(this),this._port="8010",this._wuid=null}function c(){n.call(this)}function l(){h.call(this),this._hipieResults={}}function m(){l.call(this)}var f=60;r.prototype.url=function(t){if(!arguments.length)return this._url;this._url=t;var e=document.createElement("a");e.href=this._url,e.href=e.href;var r={};if(e.search.length){var s=e.search;"?"===s[0]&&(s=s.substring(1)),s=s.split("&"),s.map(function(t){var e=t.split("=");r[decodeURIComponent(e[0])]=decodeURIComponent(e[1])})}for(this._protocol=e.protocol,this._hostname=e.hostname,this._port=e.port,this._pathname=e.pathname;this._pathname.length&&"/"===this._pathname[0];)this._pathname=this._pathname.substring(1);return this._search=e.search,this._params=r,this._hash=e.hash,this._host=e.host,this},r.prototype.protocol=function(t){return arguments.length?(this._protocol=t,this):this._protocol},r.prototype.hostname=function(t){return arguments.length?(this._hostname=t,this):this._hostname},r.prototype.port=function(t){return arguments.length?(this._port=t,this):this._port},r.prototype.pathname=function(t){return arguments.length?(this._pathname=t,this):this._pathname},r.prototype.isWsWorkunits=function(){return this._pathname.toLowerCase().indexOf("wsworkunits")>=0||this._params.Wuid},r.prototype.isWorkunitResult=function(){return this.isWsWorkunits()&&(this._params.Sequence||this._params.ResultName)},r.prototype.isWsEcl=function(){return this._pathname.toLowerCase().indexOf("wsecl")>=0||this._params.QuerySetId&&this._params.Id},r.prototype.isWsWorkunits_GetStats=function(){return this._pathname.toLowerCase().indexOf("wsworkunits/wugetstats")>=0&&this._params.WUID},r.prototype.getUrl=function(t){return t=t||{},(t.protocol?t.protocol:this._protocol)+"//"+(t.hostname?t.hostname:this._hostname)+":"+(t.port?t.port:this._port)+"/"+(t.pathname?t.pathname:this._pathname)},s.prototype.contains=function(t,e){return o(t+"."+e,this._mappings)},s.prototype.mapResult=function(t,e){var r=this._mappings[e];r&&(t[e]=t[e].map(function(t){var e=[];if(r.x&&r.x instanceof Array){e=[];for(var s=0;s<r.x.length;++s)e.push(t[r.y[s]])}else for(var n in r)"label"===r[n]?e[0]=t[n]:"weight"===r[n]&&(e[1]=t[n]);return e},this))},s.prototype.mapResponse=function(t){for(var e in t)this.mapResult(t,e)},n.prototype=Object.create(r.prototype);var _=function(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(encodeURIComponent(r)+"="+encodeURIComponent(t[r]));return e.join("&")},g=function(t,e,r){return new Promise(function(s,n){function o(t){delete window[u],document.body.removeChild(h)}var i=1e3*r,a=5e3,u="jsonp_callback_"+Math.round(999999*Math.random());window[u]=function(t){i=0,o(t),s(t)};var h=document.createElement("script");h.src=t+(t.indexOf("?")>=0?"&":"?")+"jsonp="+u+"&"+_(e),document.body.appendChild(h);var p=setInterval(function(){0>=i?clearInterval(p):(i-=a,0>=i?(clearInterval(p),console.log("Request timeout:  "+h.src),o(),n(Error("Request timeout:  "+h.src))):console.log("Request pending ("+i/1e3+" sec):  "+h.src))},a)})};return n.prototype.jsonp=function(t,e,s){for(var n in this._proxyMappings){var o=t.split(n),i=o[0];if(o.length>1){var a=(new r).url(t);t=i+this._proxyMappings[n],e.IP=a._hostname,e.PORT=a._port,o.length>0&&(e.PATH=o[1]);break}}return g(t,e,this.timeout())},n.prototype.ajax=function(t,e,r){return new Promise(function(s,n){var o=e;r&&(o+="?"+_(r));var i=new XMLHttpRequest;i.onload=function(t){this.status>=200&&this.status<300?s(JSON.parse(this.response)):n(Error(this.statusText))},i.onerror=function(){n(Error(this.statusText))},i.open(t,o),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send()})},n.prototype.get=function(t,e){return this.ajax("GET",t,e)},n.prototype.post=function(t,e){return this.ajax("POST",t,e)},n.prototype.mappings=function(t){return arguments.length?(this._mappings=new s(t),this):this._mappings},n.prototype.proxyMappings=function(t){return arguments.length?(this._proxyMappings=t,this):this._proxyMappings},n.prototype.timeout=function(t){return arguments.length?(this._timeout=t||f,this):this._timeout},i.prototype=Object.create(n.prototype),i.prototype.cacheCalls=function(t){return arguments.length?(this._cacheCalls=t,this):this._cacheCalls},i.prototype.call=function(t,e){var r=this._url+(this._url.indexOf("?")>=0?"&":"?")+_(t);if(this._cacheCalls){var s=this;return new Promise(function(t,s){var n=JSON.parse(localStorage.getItem("hpcc.viz."+r));if(!n)throw Error("not cached");e&&(console.log("Deprecated:  callback, use promise (Basic.prototype.call)"),e(n)),t(n)})["catch"](function(t){return s.get(r).then(function(t){return localStorage.setItem("hpcc.viz."+r,JSON.stringify(t)),e&&(console.log("Deprecated:  callback, use promise (Basic.prototype.call)"),e(t)),t})})}return localStorage.removeItem("hpcc.viz."+r),this.get(r).then(function(t){return e&&(console.log("Deprecated:  callback, use promise (Basic.prototype.call)"),e(t)),t})},u.prototype=Object.create(n.prototype),u.prototype.url=function(t){var e=n.prototype.url.apply(this,arguments);if(arguments.length){this._port="8010"===this._port?"8002":this._port;for(var r in this._params)switch(r){case"QuerySetId":this.target(this._params[r]);break;case"Id":this.query(this._params[r])}var s,o;this._target&&this._query||(s=this._pathname.split("/query/"),s.length>=2&&(o=s[1].split("/"),o.length>=2&&(this.target(o[0]),this.query(o[1]))))}return e},u.prototype.target=function(t){return arguments.length?(this._target=t,this):this._target},u.prototype.query=function(t){return arguments.length?(this._query=t,this):this._query},u.prototype.constructUrl=function(){return n.prototype.getUrl.call(this,{pathname:"WsEcl/submit/query/"+this._target+"/"+this._query+"/json"})},u.prototype.call=function(t,r,s){t=t||{},t.target=t.target||this._target,t.query=t.query||this._query;var n=this,o=this.getUrl({pathname:"WsEcl/submit/query/"+t.target+"/"+t.query+"/json"});return this.jsonp(o,r).then(function(t){if(t=a(t),t.Exception)throw Error(t.Exception.reduce(function(t,e,r,s){return t.length&&(t+="\n"),t+e.Source+" "+e.Code+":  "+e.Message},""));for(var r in t)t[r].Row&&(t[r]=t[r].Row.map(e));return n._mappings.mapResponse(t),s&&(console.log("Deprecated:  callback, use promise (WsECL.prototype.call)"),s(t)),t})},u.prototype.send=function(t,e){return this.call({target:this._target,query:this._query},t,e)},h.prototype=Object.create(n.prototype),h.prototype.url=function(t){var e=n.prototype.url.apply(this,arguments);if(arguments.length){for(var r in this._params)switch(r){case"Wuid":this.wuid(this._params[r]);break;case"ResultName":this.resultName(this._params[r]);break;case"Sequence":this.sequence(this._params[r])}if(!this._wuid){var s=this._url.split("/res/");if(s.length>=2){var o=s[1].split("/");this.wuid(o[0])}}}return e},h.prototype.wuid=function(t){return arguments.length?(this._wuid=t,this):this._wuid},h.prototype.jobname=function(t){return arguments.length?(this._jobname=t,this):this._jobname},h.prototype.sequence=function(t){return arguments.length?(this._sequence=t,this):this._sequence},h.prototype.resultName=function(t){return arguments.length?(this._resultName=t,this):this._resultName},h.prototype.appendParam=function(t,e,r){return e?(r&&(r+="&"),r+t+"="+e):r},h.prototype.constructUrl=function(){var t=n.prototype.getUrl.call(this,{pathname:"WsWorkunits/res/"+this._wuid+"/"}),e="";return e=this.appendParam("ResultName",this._resultName,e),t+(e?"?"+e:"")},h.prototype._fetchResult=function(t,r,s){if(t=t||{},!this._fetchResultPromise[t.resultname]){t._start=t._start||0,t._count=t._count||-1;var n=this.getUrl({pathname:"WsWorkunits/WUResult.json"}),o={Wuid:t.wuid,ResultName:t.resultname,SuppressXmlSchema:!0,Start:t._start,Count:t._count};this._resultNameCache[t.resultname]={};var i=this;this._fetchResultPromise[t.resultname]=this.jsonp(n,o).then(function(n){for(var o in n){if(!n[o].Result)throw"No result found.";i._total=n[o].Total,n=n[o].Result;for(var a in n){n=n[a].Row.map(e);break}break}return i._resultNameCache[t.resultname]=n,s||i._mappings.mapResult(i._resultNameCache,t.resultname),r&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype._fetchResult)"),r(i._resultNameCache[t.resultname])),i._resultNameCache[t.resultname]})}return this._fetchResultPromise[t.resultname]},h.prototype.fetchResult=function(t,e,r){if(t.wuid)return this._fetchResult(t,e,r);if(t.jobname){var s=this;return this.WUQuery(t,function(n){return t.wuid=n[0].Wuid,s._fetchResult(t,e,r)})}},h.prototype.WUQuery=function(t,e){var r=this.getUrl({pathname:"WsWorkunits/WUQuery.json"}),s={Jobname:s.jobname,Count:1};return this._resultNameCache={},this._resultNameCacheCount=0,this.jsonp(r,s).then(function(t){if(!o("WUQueryResponse.Workunits.ECLWorkunit",t))throw"No workunit found.";return t=t.WUQueryResponse.Workunits.ECLWorkunit,e&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype.WUQuery)"),e(t)),t})},h.prototype.fetchResultNames=function(t){if(!this._fetchResultNamesPromise){var e=this.getUrl({pathname:"WsWorkunits/WUInfo.json"}),r={Wuid:this._wuid,TruncateEclTo64k:!0,IncludeExceptions:!1,IncludeGraphs:!1,IncludeSourceFiles:!1,IncludeResults:!0,IncludeResultsViewNames:!1,IncludeVariables:!1,IncludeTimers:!1,IncludeResourceURLs:!1,IncludeDebugValues:!1,IncludeApplicationValues:!1,IncludeWorkflows:!1,IncludeXmlSchemas:!1,SuppressResultSchemas:!0};this._resultNameCache={},this._resultNameCacheCount=0;var s=this;this._fetchResultNamesPromise=this.jsonp(e,r).then(function(e){return o("WUInfoResponse.Workunit.Results.ECLResult",e)&&e.WUInfoResponse.Workunit.Results.ECLResult.map(function(t){s._resultNameCache[t.Name]=[],++s._resultNameCacheCount}),t&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype.fetchResultNames)"),t(s._resultNameCache)),s._resultNameCache})}return this._fetchResultNamesPromise},h.prototype.fetchResults=function(t,e){var r=this;return this.fetchResultNames().then(function(s){var n=[];for(var o in r._resultNameCache)n.push(r.fetchResult({wuid:r._wuid,resultname:o},null,e));return Promise.all(n).then(function(e){return t&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype.fetchResults)"),t(r._resultNameCache)),r._resultNameCache})})},h.prototype.postFilter=function(t,e){var r={};for(var s in e)r[s]=e[s].filter(function(e,r){for(var s in t)if(void 0!==e[s]&&void 0!==t[s]&&e[s]!=t[s])return!1;return!0});return this._mappings.mapResponse(r),r},h.prototype.send=function(t,e){var r=this;this._resultNameCacheCount?e(r.postFilter(t,this._resultNameCache)):this.fetchResults(function(s){e(r.postFilter(t,s))},!0)},p.prototype=Object.create(n.prototype),p.prototype.url=function(t){var e=n.prototype.url.apply(this,arguments);if(arguments.length)for(var r in this._params)switch(r){case"WUID":this.wuid(this._params[r])}return e},p.prototype.wuid=function(t){return arguments.length?(this._wuid=t,this):this._wuid},p.prototype.constructUrl=function(){return n.prototype.getUrl.call(this,{pathname:"WsWorkunits/WUGetStats?WUID="+this._wuid})},p.prototype.send=function(t,e){var r=this.getUrl({pathname:"WsWorkunits/WUGetStats.json?WUID="+this._wuid});return this.jsonp(r,t).then(function(t){return o("WUGetStatsResponse.Statistics.WUStatisticItem",t)?(e&&(console.log("Deprecated:  callback, use promise (WsWorkunits_GetStats.prototype.send)"),e(t.WUGetStatsResponse.Statistics.WUStatisticItem)),t.WUGetStatsResponse.Statistics.WUStatisticItem):(e&&(console.log("Deprecated:  callback, use promise (WsWorkunits_GetStats.prototype.send)"),e([])),[])})},c.prototype=Object.create(n.prototype),c.prototype.fetchResults=function(t,r){var s=this.getUrl({});this._resultNameCache={},this._resultNameCacheCount=0;var n=this;return this.jsonp(s,t).then(function(t){if(t=a(t),t.Exception)throw Error(t.Exception.reduce(function(t,e,r,s){return t.length&&(t+="\n"),t+e.Source+" "+e.Code+":  "+e.Message},""));for(var s in t)t[s].Row&&(n._resultNameCache[s]=t[s].Row.map(e),++n._resultNameCacheCount);return r&&(console.log("Deprecated:  callback, use promise (HIPIERoxie.prototype.fetchResults)"),r(n._resultNameCache)),n._resultNameCache})},c.prototype.fetchResult=function(t,e){var r=this;return new Promise(function(s,n){e&&(console.log("Deprecated:  callback, use promise (HIPIERoxie.prototype.fetchResult)"),e(r._resultNameCache[t])),s(r._resultNameCache[t])})},c.prototype.call=function(t,e){return this.fetchResults(t,e)},l.prototype=Object.create(h.prototype),l.prototype.hipieResults=function(t){if(!arguments.length)return this._hipieResults;this._hipieResultsLength=0,this._hipieResults={};var e=this;return t.forEach(function(t){e._hipieResultsLength++,e._hipieResults[t.id]=t}),this},l.prototype.fetchResults=function(t){var e=this;return h.prototype.fetchResultNames.call(this).then(function(r){var s=[];for(var n in e._hipieResults){var o=e._hipieResults[n];s.push(e.fetchResult(o.from))}return Promise.all(s).then(function(r){return t&&(console.log("Deprecated:  callback, use promise (HIPIEWorkunit.prototype.fetchResults)"),t(e._resultNameCache)),e._resultNameCache})})},l.prototype.fetchResult=function(t,e){return h.prototype.fetchResult.call(this,{wuid:this._wuid,resultname:t}).then(function(t){return e&&(console.log("Deprecated:  callback, use promise (HIPIEWorkunit.prototype.fetchResult)"),e(t)),t})},l.prototype.call=function(t,e){function r(t){var e={};for(var r in t)void 0!==t[r]&&void 0!==t[r+"_changed"]&&(e[r]=t[r]);var n={};for(var o in s._hipieResults){var i=s._hipieResults[o],a=!0;for(var u in e)if(i.filter.indexOf(u)<0){a=!1;break}a&&(n[i.from]=s._resultNameCache[i.from].filter(function(t){for(var r in e)if(t[r]!=e[r]&&t[r.toLowerCase()]!=e[r])return!1;return!0}))}return n}var s=this;return!t.refresh&&this._resultNameCache&&this._resultNameCacheCount?new Promise(function(e,s){e(r(t))}):this.fetchResults(e).then(function(e){return r(t)})},m.prototype=Object.create(l.prototype),m.prototype.databomb=function(t){return arguments.length?(this._databomb=t,this):this._databomb},m.prototype.databombOutput=function(t,r){return arguments.length?(this._resultNameCacheCount++,this._databomb instanceof Array?this._resultNameCache[t]=this._databomb.map(e):this._resultNameCache[t]=this._databomb[r].map(e),this):void 0},m.prototype.fetchResults=function(t){var e=this;return new Promise(function(r,s){t&&(console.log("Deprecated:  callback, use promise (HIPIEDatabomb.prototype.fetchResults)"),t(e._resultNameCache)),r(e._resultNameCache)})},{Basic:i,ESPMappings:s,ESPUrl:r,WsECL:u,WsWorkunits:h,HIPIERoxie:c,HIPIEWorkunit:l,HIPIEDatabomb:m,createESPConnection:function(t){t=t||document.URL;var e=(new r).url(t);return e.isWsWorkunits_GetStats()?(new p).url(t):e.isWsWorkunits()?(new h).url(t):e.isWsEcl()?(new u).url(t):null},hookJsonp:function(t){g=t}}});