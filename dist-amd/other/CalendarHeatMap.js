(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/HTMLWidget","../common/Palette","css!./CalendarHeatMap"],t):e.other_CalendarHeatMap=t(e.d3,e.common_HTMLWidget,e.common_Palette)})(this,function(e,t,n){function r(e){t.call(this)}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype._class+=" other_CalendarHeatMap",r.prototype._palette=n.rainbow("default"),r.prototype.publish("paletteID","YlOrRd","set","Palette ID",r.prototype._palette.switch(),{tags:["Basic","Shared"]}),r.prototype.publish("dateColumn",null,"set","Date Column",function(){return this.columns()},{optional:!0}),r.prototype.publish("datePattern","%Y-%m-%d","string","Date Pattern"),r.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0}),r.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(e){return!e.aggrType()}}),r.prototype.publish("aggrDeltaColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(e){return!e.aggrType()}}),r.prototype.calendarData=function(){var t=e.time.format(this.datePattern()).parse,n=this.aggrDeltaColumn()?e.format(".1%"):e.format("s");if(this._prevDateColumn!==this.dateColumn()||this._prevAggrType!==this.aggrType()||this._prevAggrColumn!==this.aggrColumn()||this._prevAggrDeltaColumn!==this.aggrDeltaColumn())this._prevDateColumn=this.dateColumn(),this._prevAggrType=this.aggrType(),this._prevAggrColumn=this.aggrColumn(),this._prevAggrDeltaColumn=this.aggrDeltaColumn(),this._view=this._db.aggregateView([this.dateColumn()],this.aggrType(),this.aggrColumn(),this.aggrDeltaColumn());return this._view.entries().map(function(e){return e.dateKey=t(e.key),e.formattedValues=n(e.values),e})},r.prototype.calcDelta=function(e){return(e.Close-e.Open)/e.Open},r.prototype.enter=function(n,r){t.prototype.enter.apply(this,arguments),e.select(n.parentNode).style("overflow","scroll")},r.prototype.update=function(n,r){function m(t){var n=new Date(t.getFullYear(),t.getMonth()+1,0),r=t.getDay(),i=e.time.weekOfYear(t),o=n.getDay(),u=e.time.weekOfYear(n);return"M"+(i+1)*s+","+r*s+"H"+i*s+"V"+7*s+"H"+u*s+"V"+(o+1)*s+"H"+(u+1)*s+"V"+0+"H"+(i+1)*s+"Z"}t.prototype.update.apply(this,arguments),this._palette=this._palette.switch(this.paletteID());var i=this.width(),s=i/12/5,o=s*8,u=this.calendarData(),a=e.map(u,function(e){return e.dateKey}),f=e.extent(u,function(e){return e.dateKey.getFullYear()}),l=this,c=r.selectAll("svg").data(e.range(f[0],f[1]+1));c.enter().append("svg").each(function(t){var n=e.select(this);n.append("g").append("text").style("text-anchor","middle")}),c.attr("width",i).attr("height",o),c.select("g").attr("transform","translate("+(i-s*53)/2+","+(o-s*7-1)+")"),c.select("text").attr("transform","translate(-6,"+s*3.5+")rotate(-90)").text(function(e){return e}),c.exit().remove();var h=e.extent(u,function(e){return e.values});if(this.aggrDeltaColumn()){var p=Math.max(Math.abs(h[0],h[1]));h=[-p,p]}var d=c.select("g").selectAll(".day").data(function(t){return e.time.days(new Date(t,0,1),new Date(t+1,0,1))});d.enter().append("rect").attr("class","day").append("title"),d.attr("x",function(t){return e.time.weekOfYear(t)*s}).attr("y",function(e){return e.getDay()*s}).attr("width",s).attr("height",s),d.select("title").text(function(e){return e}),d.filter(function(e){return a.has(e)}).style("fill",function(e){return l._palette(a.get(e).values,h[0],h[1])}).select("title").text(function(e){var t=a.get(e);return t.key+": "+t.formattedValues}),d.exit().remove();var v=c.select("g").selectAll(".month").data(function(t){return e.time.months(new Date(t,0,1),new Date(t+1,0,1))});v.enter().append("path").attr("class","month"),v.attr("d",m),v.exit().remove()},r.prototype.exit=function(e,n){t.prototype.exit.apply(this,arguments)},r});