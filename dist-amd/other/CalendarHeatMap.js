!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/HTMLWidget","../common/Palette","css!./CalendarHeatMap"],e):t.other_CalendarHeatMap=e(t.d3,t.common_HTMLWidget,t.common_Palette)}(this,function(t,e,a){function n(t){e.call(this)}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype._class+=" other_CalendarHeatMap",n.prototype._palette=a.rainbow("default"),n.prototype.publish("paletteID","YlOrRd","set","Palette ID",n.prototype._palette["switch"](),{tags:["Basic","Shared"]}),n.prototype.publish("dateColumn",null,"set","Date Column",function(){return this.columns()},{optional:!0}),n.prototype.publish("datePattern","%Y-%m-%d","string","Date Pattern"),n.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0}),n.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(t){return!t.aggrType()}}),n.prototype.publish("aggrDeltaColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(t){return!t.aggrType()}}),n.prototype.calendarData=function(){var e=t.time.format(this.datePattern()).parse,a=this.aggrDeltaColumn()?t.format(".1%"):t.format("s");return(this._prevDateColumn!==this.dateColumn()||this._prevAggrType!==this.aggrType()||this._prevAggrColumn!==this.aggrColumn()||this._prevAggrDeltaColumn!==this.aggrDeltaColumn())&&(this._prevDateColumn=this.dateColumn(),this._prevAggrType=this.aggrType(),this._prevAggrColumn=this.aggrColumn(),this._prevAggrDeltaColumn=this.aggrDeltaColumn(),this._view=this._db.aggregateView([this.dateColumn()],this.aggrType(),this.aggrColumn(),this.aggrDeltaColumn())),this._view.entries().map(function(t){return t.dateKey=e(t.key),t.formattedValues=a(t.values),t})},n.prototype.calcDelta=function(t){return(t.Close-t.Open)/t.Open},n.prototype.enter=function(a,n){e.prototype.enter.apply(this,arguments),t.select(a.parentNode).style("overflow","scroll")},n.prototype.update=function(a,n){function r(e){var a=new Date(e.getFullYear(),e.getMonth()+1,0),n=e.getDay(),r=t.time.weekOfYear(e),o=a.getDay(),l=t.time.weekOfYear(a);return"M"+(r+1)*i+","+n*i+"H"+r*i+"V"+7*i+"H"+l*i+"V"+(o+1)*i+"H"+(l+1)*i+"V0H"+(r+1)*i+"Z"}e.prototype.update.apply(this,arguments),this._palette=this._palette["switch"](this.paletteID());var o=this.width(),i=o/12/5,l=8*i,s=this.calendarData(),p=t.map(s,function(t){return t.dateKey}),u=t.extent(s,function(t){return t.dateKey.getFullYear()}),g=this,h=n.selectAll("svg").data(t.range(u[0],u[1]+1));h.enter().append("svg").each(function(e){var a=t.select(this);a.append("g").append("text").style("text-anchor","middle")}),h.attr("width",o).attr("height",l),h.select("g").attr("transform","translate("+(o-53*i)/2+","+(l-7*i-1)+")"),h.select("text").attr("transform","translate(-6,"+3.5*i+")rotate(-90)").text(function(t){return t}),h.exit().remove();var c=t.extent(s,function(t){return t.values});if(this.aggrDeltaColumn()){var m=Math.max(Math.abs(c[0],c[1]));c=[-m,m]}var d=h.select("g").selectAll(".day").data(function(e){return t.time.days(new Date(e,0,1),new Date(e+1,0,1))});d.enter().append("rect").attr("class","day").append("title"),d.attr("x",function(e){return t.time.weekOfYear(e)*i}).attr("y",function(t){return t.getDay()*i}).attr("width",i).attr("height",i),d.select("title").text(function(t){return t}),d.filter(function(t){return p.has(t)}).style("fill",function(t){return g._palette(p.get(t).values,c[0],c[1])}).select("title").text(function(t){var e=p.get(t);return e.key+": "+e.formattedValues}),d.exit().remove();var f=h.select("g").selectAll(".month").data(function(e){return t.time.months(new Date(e,0,1),new Date(e+1,0,1))});f.enter().append("path").attr("class","month"),f.attr("d",r),f.exit().remove()},n.prototype.exit=function(t,a){e.prototype.exit.apply(this,arguments)},n});