!function(t,e){"function"==typeof define&&define.amd?define(["d3","../common/HTMLWidget","../common/Palette","../common/Utility","css!./CalendarHeatMap"],e):t.other_CalendarHeatMap=e(t.d3,t.common_HTMLWidget,t.common_Palette,t.common_Utility)}(this,function(t,e,a,n){function r(t){e.call(this),n.SimpleSelectionMixin.call(this)}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" other_CalendarHeatMap",r.prototype.mixin(n.SimpleSelectionMixin),r.prototype._palette=a.rainbow("default"),r.prototype.publish("paletteID","YlOrRd","set","Palette ID",r.prototype._palette["switch"](),{tags:["Basic","Shared"]}),r.prototype.publish("dateColumn",null,"set","Date Column",function(){return this.columns()},{optional:!0}),r.prototype.publish("datePattern","%Y-%m-%d","string","Date Pattern"),r.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0}),r.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(t){return!t.aggrType()}}),r.prototype.publish("aggrDeltaColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(t){return!t.aggrType()}}),r.prototype.calendarData=function(){var e=t.time.format(this.datePattern()).parse,a=this.aggrDeltaColumn()?t.format(".1%"):t.format("s");return(this._prevDateColumn!==this.dateColumn()||this._prevAggrType!==this.aggrType()||this._prevAggrColumn!==this.aggrColumn()||this._prevAggrDeltaColumn!==this.aggrDeltaColumn())&&(this._prevDateColumn=this.dateColumn(),this._prevAggrType=this.aggrType(),this._prevAggrColumn=this.aggrColumn(),this._prevAggrDeltaColumn=this.aggrDeltaColumn(),this._view=this._db.aggregateView([this.dateColumn()],this.aggrType(),this.aggrColumn(),this.aggrDeltaColumn())),this._view.entries().map(function(t){return t.dateKey=e(t.key),t.formattedValues=a(t.values.aggregate),t.origRows=a(t.values),t})},r.prototype.calcDelta=function(t){return(t.Close-t.Open)/t.Open},r.prototype.enter=function(a,n){e.prototype.enter.apply(this,arguments),t.select(a.parentNode).style("overflow","scroll"),this._selection.widgetElement(n)},r.prototype.update=function(a,n){function r(e){var a=new Date(e.getFullYear(),e.getMonth()+1,0),n=e.getDay(),r=t.time.weekOfYear(e),o=a.getDay(),l=t.time.weekOfYear(a);return"M"+(r+1)*i+","+n*i+"H"+r*i+"V"+7*i+"H"+l*i+"V"+(o+1)*i+"H"+(l+1)*i+"V0H"+(r+1)*i+"Z"}e.prototype.update.apply(this,arguments),this._palette=this._palette["switch"](this.paletteID());var o=this.width(),i=o/12/5,l=8*i,s=this.calendarData(),p=t.map(s,function(t){return t.dateKey}),u=t.extent(s,function(t){return t.dateKey.getFullYear()}),g=this,c=n.selectAll("svg").data(t.range(u[0],u[1]+1));c.enter().append("svg").each(function(e){var a=t.select(this),n=a.append("g");n.append("text").style("text-anchor","middle"),n.append("g").attr("class","days"),n.append("g").attr("class","months")}),c.attr("width",o).attr("height",l),c.select("g").attr("transform","translate("+(o-53*i)/2+","+(l-7*i-1)+")"),c.select("text").attr("transform","translate(-6,"+3.5*i+")rotate(-90)").text(function(t){return t}),c.exit().remove();var h=t.extent(s,function(t){return t.values.aggregate});if(this.aggrDeltaColumn()){var m=Math.max(Math.abs(h[0],h[1]));h=[-m,m]}var d=c.select(".days").selectAll(".day").data(function(e){return t.time.days(new Date(e,0,1),new Date(e+1,0,1))});d.enter().append("rect").attr("class","day").call(this._selection.enter.bind(this._selection)).on("click",function(t){var e=p.get(t);e&&e.values&&e.values&&e.values.length&&g.click(g.rowToObj(e.values[0]),g.dateColumn(),g._selection.selected(this))}).append("title"),d.attr("x",function(e){return t.time.weekOfYear(e)*i}).attr("y",function(t){return t.getDay()*i}).attr("width",i).attr("height",i),d.select("title").text(function(t){return t}),d.filter(function(t){return p.has(t)}).style("fill",function(t){var e=p.get(t);return e&&e.values&&e.values.aggregate?g._palette(e.values.aggregate,h[0],h[1]):null}).select("title").text(function(t){var e=p.get(t);return e.key+": "+e.formattedValues}),d.exit().remove();var y=c.select(".months").selectAll(".month").data(function(e){return t.time.months(new Date(e,0,1),new Date(e+1,0,1))});y.enter().append("path").attr("class","month"),y.attr("d",r),y.exit().remove()},r.prototype.exit=function(t,a){e.prototype.exit.apply(this,arguments)},r.prototype.click=function(t,e,a){console.log("Click:  "+JSON.stringify(t)+", "+e+", "+a)},r});